<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประเมินอาการสโตรก (AI)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <style>
        :root {
            --primary-color: #007BFF; --background-color: #f0f2f5;
            --card-bg-color: #ffffff; --text-color: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.1); --border-radius: 24px;
            --symptom-red: #D32F2F; --symptom-green: #388E3C;
            --dark-red: #C0392B; --light-red-bg: #FFF0F0;
            --action-blue: #007BFF; --action-green: #28A745;
            --action-red: #D32F2F; --action-orange: #f39c12; --action-gray: #6C757D;
            --ai-yellow: #FFD700; --ai-text: #000;
        }

        * { box-sizing: border-box; } 

        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            background-color: var(--background-color); 
            margin: 0; padding: 16px; 
            padding-bottom: 80px;
            font-size: 24px; 
            line-height: 1.5;
            color: var(--text-color);
        }

        /* --- Global Button Style --- */
        button, .btn-action, .file-upload-btn, #btn-record, .btn-likely, .btn-unlikely, .btn-back {
            font-family: "Noto Sans Thai", sans-serif !important;
            border-radius: 50px !important;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; font-size: 1.1em; padding: 15px;
        }
        button:active, .btn-action:active { transform: scale(0.98); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .normal-font-mode { font-size: 18px !important; }
        .normal-font-mode .btn-action { font-size: 1.2em; padding: 15px; margin-top: 15px;} 
        
        .floating-actions { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 4000; }
        .float-btn { display: flex; align-items: center; justify-content: center; width: 70px; height: 70px; border-radius: 50%; color: white; font-weight: bold; font-size: 1.2em; box-shadow: 0 4px 15px rgba(0,0,0,0.4); text-decoration: none; border: 3px solid white; cursor: pointer; transition: transform 0.2s; }
        .float-1669 { background-color: #D32F2F; animation: pulse-red 2s infinite; }
        .float-sawi { background-color: #f39c12; }
        .float-label { font-size: 0.6em; display: block; margin-top: -5px; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }

        /* Karaoke Animation */
        .karaoke-text {
            background: linear-gradient(to right, #D32F2F 50%, #333 50%); background-size: 200% 100%; background-position: 100% 0;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: karaoke 3s linear infinite; font-size: 1.4em; font-weight: 800; display: inline-block;
        }
        @keyframes karaoke { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; color: white; text-align: center; }
        .spinner { border: 8px solid #333; border-top: 8px solid #ffc107; border-radius: 50%; width: 80px; height: 80px; animation: spin 1s linear infinite; margin-bottom: 30px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .main-container { max-width: 600px; margin: 0 auto; width: 100%; }
        .card { padding: 25px; background-color: var(--card-bg-color); border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 10px; width: 100%; overflow: hidden; }
        .card-body { padding-bottom: 10px; width: 100%; }

        .section-title { font-size: 1.3em; font-weight: 700; color: var(--text-color); display: flex; align-items: center; justify-content: center; margin-bottom: 10px; text-align: center;}
        .section-subtitle { font-size: 1.1em; color: #555; margin-top: 0px; margin-bottom: 20px; text-align: center; }

        .assessor-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 20px; flex-wrap: nowrap; }
        .modern-select { 
            flex-grow: 0; width: auto; padding: 10px 15px; font-size: 1em; border-radius: 50px; border: 2px solid #ddd; background-color: #fff; 
            font-family: "Noto Sans Thai", sans-serif;
            color: #333; min-width: 120px; 
        }
        
        /* Phone Input Style Refined */
        .phone-input-wrapper { display: none; margin-bottom: 20px; width: 100%; }
        .phone-input-container { display: flex; gap: 10px; align-items: center; width: 100%; }
        .phone-input { 
            flex: 1; padding: 12px 20px; 
            border-radius: 50px; border: 2px solid #ddd; font-size: 1em; 
            font-family: "Noto Sans Thai", sans-serif;
            text-align: center; outline: none; width: 100%;
        }
        .phone-input:focus { border-color: var(--primary-color); }
        .search-btn {
            width: auto !important; padding: 0 25px !important; margin: 0 !important;
            background-color: var(--primary-color); color: white;
            border-radius: 50px;
        }
        
        .user-info-compact { 
            font-size: 0.9em; background: #f8f9fa; padding: 15px; border-radius: 15px; margin-bottom: 20px; 
            display: flex; flex-wrap: wrap; /* แก้ปัญหาล้นจอ */
            align-items: center; justify-content: space-between; gap: 10px; border: 1px solid #eee; 
        }
        .user-info-item { display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .info-label { color: #666; font-size: 0.85em; }
        .info-val { font-weight: bold; color: #333; }

        .symptom-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .symptom-card { border-radius: 20px; box-shadow: var(--shadow); text-align: center; padding: 8px; cursor: pointer; background: #fff; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
        .symptom-card img { width: 100%; height: auto; aspect-ratio: 1/1; object-fit: cover; margin-bottom: 5px; border-radius: 15px; }
        .symptom-card p { margin: 0; line-height: 1.1; font-weight: 800; font-size: 1.1em; color: #2c3e50; }
        
        .symptom-card.ai-test { background-color: var(--ai-yellow); border: 2px solid #F1C40F; color: var(--ai-text); flex-direction: row; gap: 10px; padding: 15px; min-height: 70px; align-items: center; }
        .symptom-card.ai-test h3 { margin: 0; font-size: 1em; font-weight: bold; }

        .ai-input-row { display: flex; align-items: flex-start; gap: 15px; margin-top: 10px; }
        .ai-example-img { width: 25%; min-width: 80px; border-radius: 10px; cursor: zoom-in; object-fit: cover; aspect-ratio: 1/1; border: 1px solid #ddd; align-self: center;}
        .ai-action-col { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        
        .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .file-upload-btn { background-color: #eee; color: #333; padding: 10px; width: 100%; font-size: 0.95em; border-radius: 50px; text-align: center; margin-top: 10px; }
        
        .pdpa-box { background: #f9f9f9; padding: 15px; border-radius: 15px; border: 1px solid #ddd; margin: 15px 0; font-size: 0.8em; text-align: left; }
        .hidden { display: none; }
        .ai-input-box { border: 1px solid #ddd; padding: 15px; border-radius: 20px; margin-bottom: 15px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .btn-likely { background-color: var(--symptom-red); color: white; margin-bottom: 10px;}
        .btn-unlikely { background-color: var(--symptom-green); color: white; margin-bottom: 10px;}
        .btn-back-container { padding: 15px 0; border-top: 1px solid #eee; margin-top: 25px; }
        .btn-back { background: none; color: var(--primary-color); border: 2px solid var(--primary-color); }
        .options-container { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
        .options-container button { padding: 20px; font-size: 1.1em; flex-grow: 1; color: white; }
        .time-options button { width: calc(33.33% - 8px); flex-grow: 0; margin-bottom: 10px; font-size: 1em; padding: 15px 5px; color: #333; border: 1px solid #ddd; background-color: #f8f9fa;}
        
        .emergency-text-container { padding: 20px; text-align: center; background: var(--light-red-bg); border-radius: 20px; margin-bottom: 20px; border: 3px solid var(--symptom-red); }
        .emergency-text-container p { margin: 5px 0; font-size: 1.2em; }
        .emergency-text-container .large-red-blink { font-weight: 800; font-size: 1.8em; color: var(--dark-red); animation: blinker 1.2s linear infinite; }
        .emergency-text-container .small-black-blink { color: black; animation: blinker 1.5s linear infinite; font-weight: bold; font-size: 1.3em;}
        .countdown-timer { color: var(--primary-color); font-weight: bold; margin-top: 15px; font-size: 1.2em;}
        @keyframes blinker { 50% { opacity: 0.3; } }
        
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 1.1em; }
        .summary-table tr td { padding: 15px 5px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .summary-table .icon-col { width: 50px; text-align: center; font-size: 1.5em; }
        
        .action-buttons-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; place-items: center; margin-top: 25px; }
        /* UPDATED: Improved Action Button Style */
        .action-button { 
            display: flex; align-items: center; justify-content: center; width: 100%; aspect-ratio: 1/1; 
            border-radius: 20px; font-size: 2.2em; color: white; /* Force White Icon */
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); border: 2px solid white;
        }
        .location-button { background-color: var(--action-blue); }
        .location-button.success { background-color: var(--action-green); }
        .tel-sawi-button { background-color: var(--action-orange); }
        .tel-1669-button { background-color: var(--action-red); }
        .action-button-text { font-size: 0.9em; font-weight: bold; color: #555; margin-top: 8px; }
        
        .contact-buttons { margin-top: 25px; }
        /* UPDATED: Contact Buttons to be White Text on Color */
        .contact-button { 
            border-radius: 50px; padding: 15px; margin-bottom: 15px; font-size: 1.2em; 
            background-color: var(--primary-color); color: white !important; /* Force White Text */
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; text-decoration: none;
        }
        .contact-button .iconify { font-size: 1.4em; margin-right: 10px; }
        .route-button { background-color: #17a2b8; }
        
        .global-footer-hint { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(0,0,0,0.9); color: white; text-align: center; 
            padding: 10px; font-size: 0.9em; z-index: 3500; font-weight: bold; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; /* Force single line */
            height: 40px; line-height: 20px;
        }
        .modal { position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 30px; border-radius: 20px; width: 90%; max-width: 550px; text-align: left; max-height: 80vh; overflow-y: auto; }
        
        /* New Help Button Style */
        .help-btn {
            font-size: 0.7em; 
            background-color: var(--primary-color); 
            color: white; 
            padding: 4px 10px; 
            border-radius: 20px; 
            margin-left: 10px; 
            cursor: pointer; 
            display: inline-block; 
            vertical-align: middle;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* AI Result Styles */
        .result-image-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .result-image-container img { width: 100%; display: block; }
        .grid-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(144, 238, 144, 0.3) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(144, 238, 144, 0.3) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }
        .result-label {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.6); color: white; padding: 8px;
            text-align: center; font-size: 0.9em; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">กำลังโหลดข้อมูล...</div>
        <div id="loading-subtext"></div>
    </div>

    <!-- Floating Buttons -->
    <div class="floating-actions">
        <div class="float-btn float-sawi" onclick="handleCallClick(this, 'tel_sawee', '0894745523')">
            <div style="display:flex; flex-direction:column; align-items:center;">
                <span class="iconify" data-icon="mdi:hospital-box" style="font-size: 24px;"></span>
                <span class="float-label">รพ.สวี</span>
            </div>
        </div>
        <div class="float-btn float-1669" onclick="handleCallClick(this, 'tel_1669', '1669')">
            <div style="display:flex; flex-direction:column; align-items:center;">
                <span class="iconify" data-icon="mdi:phone-alert" style="font-size: 24px;"></span>
                <span style="font-size:0.9em;">1669</span>
            </div>
        </div>
    </div>
    
    <div class="global-footer-hint">ฉุกเฉินเร่งด่วน กดปุ่มโทรออกมุมขวาล่างได้ทันที</div>

    <div class="main-container">
        <!-- Layer 1: Home -->
        <div id="layer-1" data-layer="1" class="card"></div>
        
        <!-- Other Layers -->
        <div id="layer-2" data-layer="2" class="card hidden"></div>
        <div id="layer-3" data-layer="3" class="card hidden"></div>
        <div id="layer-4" data-layer="4" class="card hidden"></div>
        <div id="layer-5" data-layer="5" class="card hidden normal-font-mode"></div>
        <div id="layer-6" data-layer="6" class="card hidden"></div>
        <div id="layer-no-symptom-review" data-layer="no-symptom-review" class="card hidden"></div>

        <!-- AI Layers -->
        <div id="layer-ai-intro" data-layer="ai-intro" class="card hidden"></div>
        <div id="layer-ai-input" data-layer="ai-input" class="card hidden"></div>
        <div id="layer-ai-processing" data-layer="ai-processing" class="card hidden"></div>
        <div id="layer-ai-result" data-layer="ai-result" class="card hidden"></div>
        
        <div id="history-card" class="card hidden normal-font-mode"></div>
        
        <!-- Modals -->
        <div id="disclaimerModal" class="modal" style="display:none;"></div>
        <div id="confirmLocationModal" class="modal normal-font-mode" style="display:none;">
             <div class="modal-content" style="text-align: center;">
                <span class="iconify" data-icon="mdi:map-marker-alert" style="font-size: 60px; color: var(--action-orange);"></span>
                <h2 style="margin-top: 15px;">แจ้งพิกัดก่อนโทร</h2>
                <p style="color: #555;">เพื่อให้รถพยาบาลไปรับท่านได้ถูกตำแหน่ง ระบบจะส่งพิกัด GPS ปัจจุบันของท่าน</p>
                <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 25px;">
                    <button id="modal-send-location-btn" class="btn-action" style="background-color: var(--action-blue); margin-top:0; color:white;">ตกลง (ส่งพิกัดและโทร)</button>
                    <button class="btn-action" style="background-color: #aaa; margin-top:0; color:white;" onclick="document.getElementById('confirmLocationModal').style.display='none'">ยกเลิก</button>
                </div>
            </div>
        </div>
        <div id="aiSummaryModal" class="modal" style="display:none;">
            <div class="modal-content">
                <h3 style="text-align:center;">✨ ข้อความส่งต่อแพทย์</h3>
                <textarea id="aiSummaryText" style="width:100%; height:150px; padding:10px; border-radius:10px; border:1px solid #ccc; font-size:1em;" readonly></textarea>
                <button class="btn-action" style="background-color:#28a745; margin-top:10px; padding:15px; color:white;" onclick="copySummary()">คัดลอกข้อความ</button>
                <button class="btn-action" style="background-color:#6c757d; margin-top:10px; padding:15px; color:white;" onclick="document.getElementById('aiSummaryModal').style.display='none'">ปิด</button>
            </div>
        </div>
        <div id="how-to-act-modal" class="modal normal-font-mode"></div>
        <div id="image-viewer-modal" class="modal" style="background-color: rgba(0,0,0,0.95); flex-direction: column;" onclick="document.getElementById('image-viewer-modal').style.display='none'">
            <img id="full-image" style="max-width: 90%; max-height: 80vh; object-fit: contain; border-radius: 10px;">
            <div style="color: #ccc; margin-top: 10px; font-size: 18px;">แตะที่ว่างเพื่อปิด</div>
            <div class="btn-back" style="color: white; border-color: white; width: auto; padding: 10px 30px; margin-top: 20px;" onclick="document.getElementById('image-viewer-modal').style.display='none'">ปิด</div>
        </div>
    </div>

<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyptTEQF-bSEVcghqYZlQdPdP9WWbxn7JDzbidpI-m6wCe23ASFET9GF6M2l5RHBaz4/exec"; 
    const LIFF_ID = "2005789397-WRm1lYd9";
    const REGISTRATION_LIFF_URL = "https://liff.line.me/2005789397-nebQ8oJy";
    const HEALTH_INFO_LIFF_ID = "2005789397-RLAGXrBJ"; // Add constants here
    const DAILY_CHECK_LIFF_ID = "2005789397-WRm1lYd9";
    
    let sessionData = {};
    let aiInputs = { face: null, arm: null, audio: null };
    let mediaRecorder;
    let audioChunks = [];
    let currentAnalysisResult = null; 
    let countdownInterval;
    let currentActionElement = null;
    let currentActionKey = '';
    let notificationSent = false;
    let pendingCallUrl = null; 

    const symptomImages = {
        'Balance': 'https://img2.pic.in.th/pic/-14a8e9c4fc269d4d8f.md.png',
        'Eye': 'https://img2.pic.in.th/pic/-16881cec753a949477.md.png',
        'Face': 'https://img5.pic.in.th/file/secure-sv1/-1846055524307466a7.md.png',
        'Arm': 'https://img2.pic.in.th/pic/-15dbb33e12115949f4.md.png',
        'Speech': 'https://img5.pic.in.th/file/secure-sv1/-179b7758ead26c6d76.md.png'
    };
    const symptomTranslations = { 'Balance': 'การทรงตัว', 'Eye': 'การมองเห็น', 'Face': 'ใบหน้า', 'Arm': 'แขนขา', 'Speech': 'การพูด' };
    const symptomDetails = {
        'Balance': { likely: ['เดินเซรุนแรง', 'สูญเสียการทรงตัว', 'ยืน/นั่งนิ่งไม่ได้'], unlikely: ['เวียนหัวตอนเปลี่ยนท่า', 'น้ำในหูไม่เท่ากัน'], desc: 'ยืนตัวตรงแขนแนบลำตัว 10 วินาที ไม่ได้ มีเซล้ม' },
        'Eye': { likely: ['ตามัวหรือมองไม่เห็น', 'เห็นภาพซ้อน', 'เสียการมองเห็นครึ่งซีก'], unlikely: ['ปัญหาสายตาเดิม', 'ตาแห้ง/ระคายเคือง'], desc: 'เอามือปิดตาทีละข้างแล้วมอง เห็นไม่ชัด' },
        'Face': { likely: ['หน้าเบี้ยวครึ่งซีก', 'มุมปากตกข้างหนึ่ง', 'ยิ้มแล้วปากเบี้ยว'], unlikely: ['โรคใบหน้าเบี้ยว (Bell\'s Palsy)', 'บวมจากปัญหาฟัน'], desc: 'ส่องกระจกยิ้มยิงฟันดูปาก และตา มุมปากหรือหางตาตก', hasAi: true },
        'Arm': { likely: ['แขน/ขาอ่อนแรงซีกเดียว', 'ยกแขนไม่เท่ากัน', 'ของหลุดจากมือ'], unlikely: ['ปวดกล้ามเนื้อ', 'ชาจากการนอนทับ'], desc: 'ยกแขนเหยียดไปข้างหน้า ดูว่าสามารถเกร็งได้หรือไม่', hasAi: true },
        'Speech': { likely: ['พูดไม่ชัด/ไม่เป็นคำ', 'ลิ้นแข็งเหมือนคนเมา', 'นึกคำพูดไม่ออก'], unlikely: ['พูดติดขัดเพราะเหนื่อย', 'เสียงแหบ/เป็นหวัด'], desc: 'ทดสอบพูดคำยากเช่น ยายกินลำไยน้ำลายยายไหลย้อย พูดแล้วติดขัดลิ้นพันกัน', hasAi: true }
    };
    const hospitalCoords = { lat: 10.2300226, lon: 99.1087481 };

    window.handleEmergencyCall = function(tel, label) {
        // Updated flow to match main buttons
        handleCallClick(null, 'floating_call', tel); 
    };

    window.onload = async () => {
        document.getElementById('loading').style.display = 'none'; 
        buildInitialHTML();
        buildAILayers(); 
        
        // Prepare "How to act" modal content
        document.getElementById('how-to-act-modal').innerHTML = `<div class="modal-content"><h2 style="text-align:center;">ข้อควรปฏิบัติขณะเดินทาง</h2><div style="text-align:left;"><strong>1. ทันทีที่สงสัยว่ามีอาการสโตรก</strong><ul><li>โทรแจ้งเหตุฉุกเฉินทันที แจ้งว่า “สงสัยสโตรก”</li><li>แจ้งชื่อผู้ป่วย, เวลาเริ่มมีอาการครั้งแรก, และที่อยู่ปัจจุบัน</li><li>หากส่งข้อมูลผ่านแอปแล้วให้แจ้งว่า <strong style="color: var(--symptom-red);">"ส่งข้อมูลทาง Line สวีรู้ทันสโตรกแล้ว"</strong></li></ul><strong>2. ขณะรอรถพยาบาล</strong><ul><li>ให้นอนราบหรือเอนศีรษะสูงเล็กน้อย (15-30°)</li><li>คลายเสื้อผ้าให้หายใจสะดวก, **ห้ามกินยาหรือดื่มน้ำเด็ดขาด**</li><li>เฝ้าสังเกตอาการและการหายใจ</li></ul><strong>3. ระหว่างเดินทางและเมื่อถึงโรงพยาบาล</strong><ul><li>ไม่ควรขับรถเอง ให้รอรถพยาบาล</li><li>เตรียมข้อมูลสำคัญ: ชื่อ, ประวัติโรคประจำตัว, ยาที่ใช้</li><li>เตรียมบัตรประชาชน</li></ul><strong>4. เมื่อถึงโรงพยาบาล</strong><ul><li>รีบแจ้งแพทย์/พยาบาลว่า "สงสัยสโตรก" และบอกเวลาที่เริ่มมีอาการ</li></ul></div><button onclick="document.querySelector('#how-to-act-modal').style.display='none';" class="btn-action" style="background-color:var(--primary-color); color:white;">รับทราบ</button></div>`;
        
        document.getElementById('disclaimerModal').innerHTML = `<div class="modal-content" onclick="event.stopPropagation()"><h2 style="text-align:center;">ข้อจำกัดความรับผิดชอบ</h2><p>• แอปพลิเคชันนี้ใช้เพื่อ <strong>ประเมินอาการเบื้องต้น</strong> เท่านั้น ไม่ใช่การวินิจฉัยทางการแพทย์</p><p>• การตัดสินใจรักษาต้องพิจารณาจากปัจจัยจริงโดยบุคลากรทางการแพทย์</p><p>• แอปพลิเคชันนี้ <strong>ไม่ได้โทรออกฉุกเฉินให้ท่าน</strong> หากมีเหตุจำเป็น ท่านต้องเป็นผู้กดโทรออกด้วยตนเอง</p><p style="font-size:1em; color:#555;">การประเมินนี้เป็นการคัดกรองตามอาการ ไม่ได้รวมปัจจัยเสี่ยงส่วนบุคคล</p><button onclick="document.querySelector('#disclaimerModal').style.display='none'" style="background-color:var(--primary-color); color:white; font-size:1.4em; padding:15px; border-radius: 10px; width:100%; margin-top:15px;">รับทราบ</button></div>`;
        
        setTimeout(() => {
            const infoBtn = document.getElementById('info-btn');
            if(infoBtn) infoBtn.onclick = () => { document.querySelector('#disclaimerModal').style.display = 'flex'; };
        }, 500);
        
        document.getElementById('modal-send-location-btn').onclick = () => { 
            document.getElementById('confirmLocationModal').style.display = 'none'; 
            getLocation(false, true, () => {
                // After location is obtained (and saved via sessionData update), if this was triggered by "Save & Close", we proceed.
                // But wait, the button calls getLocation(false, true). The 'true' is 'callAfter'.
                // If we are reusing this modal for Final Save, we need to handle that.
                if (currentActionKey === 'บันทึกและปิด') {
                    handleFinalSave(currentActionElement, true);
                } else {
                    executePendingCall();
                }
            }); 
        };

        try {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                sessionData.userID = profile.userId;
                sessionData.userName = profile.displayName;
                fetchUserData(profile.userId); 
            }
        } catch (e) { console.log(e); }
    };

    // --- MAIN FLOW FUNCTIONS ---

    function buildInitialHTML() {
        document.getElementById('layer-1').innerHTML = `
            <div class="card-body">
                <h1 class="section-title">ประเมินอาการสโตรก <div id="info-btn" class="help-btn">อ่านก่อน</div></h1>
                
                <div class="assessor-row">
                    <p style="margin:0; font-size:1em; white-space: nowrap;">ท่านประเมินอาการให้ใคร</p>
                    <select id="assessor-select" class="modern-select" onchange="handleAssessorChange(this)">
                        <option value="myself">ตัวฉันเอง</option>
                        <option value="others">ผู้อื่น</option>
                    </select>
                </div>
                <!-- Phone Input for Others -->
                <div id="patient-phone-wrapper" class="phone-input-wrapper">
                    <div class="phone-input-container">
                        <input type="tel" id="patient-phone" class="phone-input" placeholder="เบอร์โทรศัพท์" maxlength="10" inputmode="numeric">
                        <button class="search-btn" onclick="triggerSearch()">
                            <span class="iconify" data-icon="mdi:magnify" style="font-size:1.5em;"></span>
                        </button>
                    </div>
                </div>

                <!-- Compact User Info Bar -->
                <div id="user-info-bar" class="user-info-compact" style="display:none;">
                    <div class="user-info-item" style="flex-basis: 100%;"><span class="info-label">ชื่อ:</span> <span class="info-val" id="ui-name">-</span></div>
                    <div class="user-info-item"><span class="info-label">ความเสี่ยง:</span> <span class="info-val" id="ui-risk">-</span></div>
                    <div class="user-info-item"><span class="info-label">วันที่:</span> <span class="info-val" id="ui-date">-</span></div>
                </div>
                
                <!-- AI Button -->
                <div class="symptom-card ai-test" onclick="handleAiTest()" style="margin-bottom: 15px; min-height: 70px; flex-direction: row; gap: 10px; padding: 15px;">
                    <span class="iconify" data-icon="mdi:robot-happy" style="font-size: 36px;"></span>
                    <div style="text-align:left;">
                        <h3 style="margin:0; font-size: 0.95em;">ทดสอบอาการด้วย AI</h3>
                        <span style="font-size:0.7em;">วิเคราะห์ใบหน้า แขน และเสียง</span>
                    </div>
                </div>

                <div class="symptom-grid">
                    <div class="symptom-card" onclick="showLayer2('Balance')"><img src="${symptomImages['Balance']}"><p>เซ/มึนหัว</p></div>
                    <div class="symptom-card" onclick="showLayer2('Eye')"><img src="${symptomImages['Eye']}"><p>ตามัวมาก</p></div>
                    <div class="symptom-card" onclick="showLayer2('Face')"><img src="${symptomImages['Face']}"><p>มุมปากตก</p></div>
                    <div class="symptom-card" onclick="showLayer2('Arm')"><img src="${symptomImages['Arm']}"><p>ยกแขนยาก</p></div>
                    <div class="symptom-card" onclick="showLayer2('Speech')"><img src="${symptomImages['Speech']}"><p>ลำบากพูด</p></div>
                    <div style="min-height: 160px;"></div>
                </div>
            </div>`;
            
        // Init other layers
        document.getElementById('layer-2').innerHTML = `<div class="card-body"><h2 id="layer-2-title" class="section-title" style="text-align:center;"></h2><div id="layer-2-new-content"></div><hr id="layer-2-separator" style="margin: 25px 0;"><p id="layer-2-subtitle" class="section-subtitle">หรือเลือกอาการที่ใกล้เคียงที่สุด</p><div id="layer-2-buttons" class="options-container"></div></div><div class="btn-back-container"><div class="btn-back" onclick="showLayer('layer-1')">ย้อนกลับ</div></div>`;
        document.getElementById('layer-3').innerHTML = `<div class="card-body"><h2 class="section-title" style="text-align:center;">อาการเกิดขึ้นอย่างไร?</h2><div class="options-container"><button class="btn-likely" onclick="handleSeveritySelection('เกิดขึ้นอย่างเฉียบพลัน')">เกิดขึ้นอย่างเฉียบพลัน</button><button style="background-color: #E67E22; color: white;" onclick="handleChronicSymptom('เกิดขึ้นเรื้อรัง/ค่อยๆ เป็น')">เป็นมานาน/ค่อยๆเป็น</button></div></div><div class="btn-back-container"><div class="btn-back" onclick="showLayer('layer-2')">ย้อนกลับ</div></div>`;
        document.getElementById('layer-4').innerHTML = `<div class="card-body"><h2 class="section-title" style="text-align:center;">อาการเริ่มเป็นเมื่อไหร่?</h2><p class="section-subtitle">โปรดประมาณการเวลาให้ใกล้เคียงที่สุด</p><div class="options-container time-options" id="time-options-container"></div></div><div class="btn-back-container"><div class="btn-back" onclick="showLayer('layer-3')">ย้อนกลับ</div></div>`;
        document.getElementById('layer-5').innerHTML = `<div class="card-body"><div class="emergency-text-container"><p>อาการของท่าน เข้าข่าย</p><p class="large-red-blink">เป็นอาการของสโตรก</p><p class="small-black-blink">โปรดกดส่งพิกัด และโทรออกหา รพ.ด้วยตัวเอง</p><div id="countdown-timer" class="countdown-timer"></div></div><div id="action-grid-container" class="action-buttons-grid"></div><table id="summary-table" class="summary-table"></table><div id="contact-buttons" class="contact-buttons"></div><div id="route-button-container"></div><button class="btn-action" style="background-color: var(--dark-red); color: white;" onclick="handleFinalSave(this, true)">บันทึกข้อมูลและปิดหน้าต่าง</button></div><div class="btn-back-container"><div class="btn-back" onclick="showLayer('layer-4')">ย้อนกลับ</div></div>`;
        document.getElementById('layer-6').innerHTML = `<div class="card-body"><div id="final-emoji" style="text-align:center; font-size: 5em; margin-bottom: 15px;"></div><h2 id="final-title" class="section-title" style="text-align:center;"></h2><p id="final-text" style="text-align:center; font-size:1.3em;"></p><button class="btn-action" style="background-color: var(--primary-color); padding: 25px; color: white;" onclick="handleFinalSave(this, false)">บันทึกและปิด</button></div>`;
        setupTimeOptions();
    }

    function buildAILayers() {
        document.getElementById('layer-ai-intro').innerHTML = `
            <div class="card-body">
                <h2 class="section-title"><span class="iconify" data-icon="mdi:brain"></span> ทดสอบด้วย AI</h2>
                <div style="text-align: left; margin-bottom: 20px;">
                    <p>ระบบ AI เป็นส่วนหนึ่งของการศึกษา ผลลัพธ์อาจมีความคลาดเคลื่อน <strong>หากมีอาการผิดปกติ ควรรีบพบแพทย์</strong></p>
                </div>
                
                <div class="pdpa-box">
                    <label style="display:flex; gap:10px; align-items:start;">
                        <input type="checkbox" id="pdpa-consent">
                        <span>ข้าพเจ้ายินยอมให้นำรูปภาพและเสียงไปประมวลผลด้วย AI เพื่อประเมินความเสี่ยงเบื้องต้นเท่านั้น</span>
                    </label>
                </div>

                <button class="btn-action" style="background-color: var(--primary-color); color:white;" onclick="startAiTestFlow()">เริ่มการทดสอบ</button>
            </div>
            <div class="btn-back-container"><div class="btn-back" onclick="showLayer('layer-1')">ย้อนกลับ</div></div>
        `;

        document.getElementById('layer-ai-input').innerHTML = `
            <div class="card-body">
                <h2 class="section-title">เก็บข้อมูลวิเคราะห์</h2>
                
                <div class="ai-input-box">
                    <h3>1. ใบหน้า (Face)</h3>
                    <div class="ai-input-row">
                        <img class="ai-example-img" src="https://img2.pic.in.th/pic/-19b938acd92f7035f5.png" onclick="viewImage(this.src)">
                        <div class="ai-action-col">
                            <p style="font-size:0.8em; color:#666; margin:0;">ถอดหน้ากาก ยิ้มกว้างๆ ให้เห็นฟัน เพื่อดูมุมปาก <strong>เหมือนรูปตัวอย่าง</strong></p>
                            <div class="file-upload-wrapper">
                                <div class="file-upload-btn"><span class="iconify" data-icon="mdi:camera"></span> ถ่ายรูป</div>
                                <input type="file" accept="image/*" capture="user" onchange="handleImageInput(this, 'face')">
                            </div>
                        </div>
                    </div>
                    <img id="preview-face" style="width:100%; display:none; margin-top:10px; border-radius:10px;">
                </div>

                <div class="ai-input-box">
                    <h3>2. แขน (Arm)</h3>
                    <div class="ai-input-row">
                        <img class="ai-example-img" src="https://img5.pic.in.th/file/secure-sv1/-20d4026a1d1efbfe8e.png" onclick="viewImage(this.src)">
                        <div class="ai-action-col">
                            <p style="font-size:0.8em; color:#666; margin:0;">ยกแขน 2 ข้างมาข้างหน้า (ระดับไหล่) ให้คนช่วยถ่าย หรือตั้งเวลา <strong>เหมือนรูปตัวอย่าง</strong></p>
                            <div class="file-upload-wrapper">
                                <div class="file-upload-btn"><span class="iconify" data-icon="mdi:camera"></span> ถ่ายรูป</div>
                                <input type="file" accept="image/*" capture="environment" onchange="handleImageInput(this, 'arm')">
                            </div>
                        </div>
                    </div>
                    <img id="preview-arm" style="width:100%; display:none; margin-top:10px; border-radius:10px;">
                </div>

                <div class="ai-input-box">
                    <h3>3. เสียง (Speech)</h3>
                    <p style="font-size:0.9em; text-align:center;">พูดว่า: <span class="karaoke-text">"ยายกินลำไย น้ำลายยายไหลย้อย"</span></p>
                    <button onclick="toggleRecording()" id="btn-record" style="background:#d9534f; color:white; padding:15px; width:100%; font-size: 1.1em;">
                        <span class="iconify" data-icon="mdi:microphone" style="margin-right:5px;"></span> กดเพื่ออัดเสียง
                    </button>
                    <div id="audio-controls-container" style="display:none; margin-top:10px; text-align:center;">
                        <audio id="audio-playback" controls style="width:100%;"></audio>
                        <div style="color:green; font-weight:bold;">บันทึกเสียงแล้ว</div>
                    </div>
                </div>
                
                <p style="color:var(--symptom-red); font-weight:bold; text-align:center; font-size:0.9em; margin-top:20px;">* ต้องส่งรูปหรือเสียงอย่างน้อย 1 อย่าง *</p>

                <button class="btn-action" style="background-color: var(--ai-yellow); color:black;" onclick="analyzeWithGemini()">ส่งวิเคราะห์</button>
            </div>
            <div class="btn-back-container"><div class="btn-back" onclick="showLayer('layer-ai-intro')">ย้อนกลับ</div></div>
        `;

        document.getElementById('layer-ai-processing').innerHTML = `
            <div class="card-body" style="text-align:center; padding:50px 0;">
                <div class="spinner" style="margin: 0 auto;"></div>
                <h2>กำลังวิเคราะห์...</h2>
                <p>AI กำลังตรวจสอบความสมมาตรของใบหน้า<br>ระดับของแขน และความชัดเจนของเสียง</p>
            </div>
        `;

        document.getElementById('layer-ai-result').innerHTML = `<div class="card-body" id="ai-result-content"></div>`;
    }

    // --- New Logic for Assessor Change & Phone Search ---
    window.handleAssessorChange = function(select) {
        const phoneWrapper = document.getElementById('patient-phone-wrapper');
        const phoneInput = document.getElementById('patient-phone');
        if (select.value === 'others') {
            phoneWrapper.style.display = 'block';
            phoneInput.value = ''; 
            phoneInput.classList.remove('valid', 'invalid'); 
        } else {
            phoneWrapper.style.display = 'none';
            fetchUserData(sessionData.userID); 
        }
    };

    window.triggerSearch = function() {
        const input = document.getElementById('patient-phone');
        const phone = input.value.replace(/[^0-9]/g, '');
        
        if (phone.length === 10) {
            fetchUserDataByPhone(phone);
        } else {
            alert("กรุณากรอกเบอร์โทรศัพท์ให้ครบ 10 หลัก");
            input.focus();
        }
    };

    window.fetchUserDataByPhone = function(phone) {
        const url = `${GAS_URL}?action=getUserDataByPhone&phone=${phone}&callback=processUserData`;
        const scriptTag = document.createElement('script'); scriptTag.src = url; document.head.appendChild(scriptTag);
    };

    // --- MANUAL FLOW LOGIC ---
    window.showLayer2 = function(symptomKey) {
        saveData('symptomCategory', symptomKey);
        document.getElementById('layer-2-title').textContent = `อาการด้าน${symptomTranslations[symptomKey]}`;
        const newContentContainer = document.getElementById('layer-2-new-content');
        const buttonsContainer = document.getElementById('layer-2-buttons');
        newContentContainer.innerHTML = '';
        buttonsContainer.innerHTML = '';
        
        let newHtml = `<div class="symptom-image-container" style="text-align:center;">
            <img src="${symptomImages[symptomKey]}" alt="${symptomTranslations[symptomKey]}" style="width:100%; max-width:400px; border-radius:20px; box-shadow:0 4px 8px rgba(0,0,0,0.1);" onclick="viewImage('${symptomImages[symptomKey]}')">
            <div class="zoom-hint">แตะเพื่อขยายรูป</div>
        </div>`;
        
        const detail = symptomDetails[symptomKey];
        if (detail.desc) {
            newHtml += `<div style="background:#f0faff; border-left: 5px solid var(--primary-color); padding: 15px; margin: 20px 0; text-align: left; border-radius: 5px;">
                <strong>วิธีสังเกตอาการ:</strong> ${detail.desc}
            </div>`;
        }

        if (detail.hasAi) {
            newHtml += `<button onclick="handleAiTest()" style="background-color: var(--ai-yellow); color: black; margin-bottom: 20px; font-size: 1em;">
                <span class="iconify" data-icon="mdi:robot-happy"></span> ใช้ AI ช่วยตรวจอาการนี้
            </button>`;
        }
        
        newHtml += `<div class="general-symptom-buttons" style="margin-top:20px; display:flex; gap:10px;">
                        <button class="btn-likely" onclick="handleSymptomResult(true, 'อาการเข้าข่าย')">อาการเข้าข่าย</button>
                        <button class="btn-unlikely" onclick="handleSymptomResult(false, 'อาการไม่เข้าข่าย')">อาการไม่เข้าข่าย</button>
                    </div>`;
        newContentContainer.innerHTML = newHtml;
        
        detail.likely.forEach(text => {
            const btn = document.createElement('button'); btn.className = 'btn-likely'; btn.textContent = text;
            btn.onclick = () => handleSymptomResult(true, text); buttonsContainer.appendChild(btn);
        });
        detail.unlikely.forEach(text => {
            const btn = document.createElement('button'); btn.className = 'btn-unlikely'; btn.textContent = text;
            btn.onclick = () => handleSymptomResult(false, text); buttonsContainer.appendChild(btn);
        });
        showLayer('layer-2');
    };

    window.handleSymptomResult = function(isLikely, symptomDetail, symptomCategory = null) {
        if (symptomCategory) { saveData('symptomCategory', symptomCategory); }
        saveData('symptomDetail', symptomDetail);
        if (isLikely) { showLayer('layer-3'); } 
        else {
            saveData('frequency', 'อาจไม่เข้าข่ายสโตรกเฉียบพลัน');
            showFinalMessage("คำแนะนำเบื้องต้น", "อาการดังกล่าวอาจไม่ใช่อาการของสโตรกเฉียบพลัน แต่หากกังวลควรปรึกษาแพทย์");
        }
    };

    window.handleSeveritySelection = function(frequencyText) { saveData('frequency', frequencyText); showLayer('layer-4'); };
    window.handleChronicSymptom = function(frequencyText) { saveData('frequency', frequencyText); showFinalMessage("คำแนะนำ", "อาการที่เป็นมานานหรือเรื้อรัง ควรปรึกษาแพทย์เพื่อหาสาเหตุที่แท้จริง"); };

    window.handleTimeSelection = function(minutesAgo, isChronic = false) {
        if (isChronic) { saveData('onsetTime', 'เรื้อรัง/หลายวัน'); showFinalMessage("คำแนะนำ", "เนื่องจากอาการเป็นมานานแล้ว อาจไม่ใช่ภาวะฉุกเฉินของสโตรก แต่ควรพบแพทย์เพื่อประเมิน"); return; }
        const onsetTime = new Date(Date.now() - minutesAgo * 60000);
        sessionData.onsetTimeObject = onsetTime;
        saveData('onsetTime', formatFullDateTime(onsetTime));
        showLayer('layer-5');
        buildSummaryPage();
    };

    function setupTimeOptions() {
        const container = document.getElementById('time-options-container');
        if (!container) return;
        container.innerHTML = '';
        const now = new Date();
        const timeOptions = [
            { text: `เพิ่งเกิด (${formatTime(now)})`, minutes: 0 }, { text: '10 นาที', minutes: 10 },
            { text: '30 นาที', minutes: 30 }, { text: '1 ชม.', minutes: 60 },
            { text: '2 ชม.', minutes: 120 }, { text: '3 ชม.', minutes: 180 },
            { text: '4 ชม.', minutes: 240 }, { text: '6 ชม.', minutes: 360 },
            { text: '12 ชม.', minutes: 720 },
            { text: '1 วันก่อน', minutes: 1440, chronic: true },
            { text: 'หลายวันก่อน', minutes: 0, chronic: true, final: true }
        ];
        timeOptions.forEach((opt, index) => {
            const btn = document.createElement('button'); btn.textContent = opt.text;
            btn.onclick = () => handleTimeSelection(opt.minutes, opt.chronic);
            if (opt.final) { btn.style.backgroundColor = '#ddd'; } 
            else if (opt.chronic) { btn.style.backgroundColor = '#E67E22'; btn.style.color = 'white'; } 
            else { btn.style.backgroundColor = '#f0f2f5'; }
            container.appendChild(btn);
        });
    }

    function buildSummaryPage() {
        if (!sessionData.eventId) { sessionData.eventId = sessionData.userID + '-' + Date.now(); }
        const onset = sessionData.onsetTimeObject;
        if (!onset) return;
        const arrivalDeadline = new Date(onset.getTime() + 3.5 * 60 * 60 * 1000);
        const rtpaDeadline = new Date(onset.getTime() + 4.5 * 60 * 60 * 1000);
        sessionData.arrivalDeadline = formatTime(arrivalDeadline);
        sessionData.rtpaDeadline = formatTime(rtpaDeadline);
        startCountdown(rtpaDeadline.getTime());
        
        // Update Table
        let tableHtml = '<tbody>';
        tableHtml += createTableRow('mdi:account-circle', 'ผู้ป่วย', sessionData.registeredName || sessionData.userName);
        tableHtml += createTableRow('mdi:account-heart-outline', 'อาการ', sessionData.symptomDetail);
        tableHtml += createTableRow('mdi:clock-time-three-outline', 'เริ่มมีอาการเมื่อ', formatFullDateTime(onset));
        tableHtml += createTableRow('mdi:timer-sand', 'ต้องถึง รพ. ภายใน (3.5ชม.)', sessionData.arrivalDeadline + ' น.');
        tableHtml += createTableRow('mdi:timer-sand', 'ต้องได้รับยาภายใน (4.5ชม.)', sessionData.rtpaDeadline + ' น.');
        tableHtml += '</tbody>';
        document.getElementById('summary-table').innerHTML = tableHtml;
        
        buildActionContainer();
        
        // Auto check location button state if location already exists
        if(sessionData.location) {
             const locButton = document.getElementById('location-action'); 
             const locText = document.getElementById('location-text');
             if (locButton) {
                 locButton.classList.add('success'); 
                 locButton.innerHTML = `<span class="iconify" data-icon="mdi:check-circle"></span>`; 
                 locText.textContent = 'ส่งพิกัดแล้ว';
                 
                 // If loc exists, calc distance immediately
                 const coords = sessionData.location.split(',');
                 if(coords.length === 2) {
                     const distance = getDistanceFromLatLonInKm(parseFloat(coords[0]), parseFloat(coords[1]), hospitalCoords.lat, hospitalCoords.lon);
                     updateSummaryAndActions(distance);
                 }
             }
        } else {
            updateSummaryAndActions(null);
        }
    }

    function startCountdown(deadlineMillis) {
        if (countdownInterval) clearInterval(countdownInterval);
        const timerElement = document.getElementById('countdown-timer');
        if (!timerElement) return;
        const updateTimer = () => {
            const distance = deadlineMillis - new Date().getTime();
            if (distance < 0) { timerElement.textContent = "หมดเวลาการให้ยาแล้ว"; timerElement.style.color = "var(--dark-red)"; clearInterval(countdownInterval); return; }
            const hours = Math.floor(distance / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            timerElement.textContent = `ท่านต้องได้รับยาภายใน ${String(hours)} ชั่วโมง ${String(minutes).padStart(2, '0')} นาที`;
        };
        updateTimer();
        countdownInterval = setInterval(updateTimer, 1000);
    }

    function updateSummaryAndActions(distance) {
        const table = document.getElementById('summary-table').getElementsByTagName('tbody')[0];
        document.querySelectorAll('.distance-row').forEach(row => row.remove());
        const contactContainer = document.getElementById('contact-buttons');
        contactContainer.innerHTML = '';
        const routeContainer = document.getElementById('route-button-container');
        routeContainer.innerHTML = '';
        if (distance !== null) {
            let extraHtml = '';
            const sawiButtonWrapper = document.querySelector('.tel-sawi-button')?.closest('.action-button-wrapper');
            if (distance > 450) {
                extraHtml += createTableRow('mdi:alert-circle-outline', 'ระยะทางไป รพ.สวี', 'โปรดเดินทางไป รพ.ที่ใกล้ที่สุด', true, 'distance-row');
                if (sawiButtonWrapper) sawiButtonWrapper.style.display = 'none';
            } else {
                if (sawiButtonWrapper) sawiButtonWrapper.style.display = 'flex';
                const travelTimeMinutes = (distance / 40) * 60;
                const ambulanceTravelTime = travelTimeMinutes * 1.5 + 15;
                const selfTravelArrival = new Date(Date.now() + travelTimeMinutes * 60000);
                const ambulanceArrival = new Date(Date.now() + ambulanceTravelTime * 60000);
                const rtpaDeadline = sessionData.onsetTimeObject ? new Date(sessionData.onsetTimeObject.getTime() + 4.5 * 60 * 60 * 1000) : new Date();
                sessionData.distance = `${distance.toFixed(1)} กม.`;
                sessionData.duration = formatDuration(travelTimeMinutes);
                const selfTravelText = `${formatTime(selfTravelArrival)} น. (${selfTravelArrival <= rtpaDeadline ? 'ทัน' : 'อาจไม่ทัน'})`;
                const ambulanceTravelText = `${formatTime(ambulanceArrival)} น. (${ambulanceArrival <= rtpaDeadline ? 'ทัน' : 'อาจไม่ทัน'})`;
                sessionData.selfTravelEstimate = selfTravelText;
                sessionData.ambulanceEstimate = ambulanceTravelText;
                extraHtml += createTableRow('mdi:map-marker-distance', 'ระยะทางไป รพ.สวี', sessionData.distance, false, 'distance-row');
                extraHtml += createTableRow('mdi:car-clock', 'คาดการณ์เวลาเดินทาง', sessionData.duration, false, 'distance-row');
                extraHtml += createTableRow('mdi:run-fast', 'คาดการณ์ (เดินทางมาเอง)', sessionData.selfTravelEstimate, selfTravelText.includes('ไม่ทัน'), 'distance-row');
                extraHtml += createTableRow('mdi:ambulance', 'คาดการณ์ (รถ รพ. ไปรับ)', sessionData.ambulanceEstimate, ambulanceTravelText.includes('ไม่ทัน'), 'distance-row');
                const gmapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${hospitalCoords.lat},${hospitalCoords.lon}`;
                routeContainer.innerHTML = `<a href="${gmapsUrl}" target="_blank" class="contact-button route-button"><span class="iconify" data-icon="mdi:directions"></span><span class="label">เส้นทางไป รพ.สวี</span></a>`;
            }
            table.insertAdjacentHTML('beforeend', extraHtml);
        }
        if (sessionData.volunteerContacts) {
            const contacts = sessionData.volunteerContacts;
            let areaInfo = (sessionData.district && sessionData.village) ? `(ต.${sessionData.district} ม.${sessionData.village})` : '';
            contactContainer.innerHTML = `<h3 style="font-size:1.1em; text-align:center; margin-top:20px; margin-bottom:10px;">เบอร์โทรผู้ช่วยเหลือในพื้นที่</h3>`;
            if (contacts.volunteer1_tel) contactContainer.innerHTML += createContactButton(contacts.volunteer1_tel, "โทรหา อสม. 1", "tel_asm1");
            if (contacts.volunteer2_tel) contactContainer.innerHTML += createContactButton(contacts.volunteer2_tel, "โทรหา อสม. 2", "tel_asm2");
            if (contacts.headman_tel) contactContainer.innerHTML += createContactButton(contacts.headman_tel, `โทรหา ผู้นำชุมชน ${areaInfo}`, "tel_header");
            if (contacts.pcu_tel) contactContainer.innerHTML += createContactButton(contacts.pcu_tel, `โทรหา ${contacts.pcu_name || 'รพ.สต.'}`, "tel_pcu");
        }
    }

    function createContactButton(tel, label, key) { 
        return `<div class="contact-button" onclick="handleCallClick(this, '${key}', '${tel}')">
                    <span class="iconify" data-icon="mdi:phone"></span><span class="label">${label}</span>
                </div>`; 
    }
    
    function createTableRow(iconName, label, value, isUrgent = false, rowClass = '') {
        const valueClass = isUrgent ? 'value-col value-urgent' : 'value-col';
        return `<tr class="${rowClass}"><td class="icon-col"><span class="iconify" data-icon="${iconName}"></span></td><td class="label-col">${label}</td><td class="${valueClass}">${value || 'N/A'}</td></tr>`;
    }
    
    function buildActionContainer() {
        const container = document.getElementById('action-grid-container');
        if (!container) return;
        container.innerHTML = `
            <div class="action-button-wrapper">
                <div id="location-action" class="action-button location-button" onclick="getLocation(false, false)"><span class="iconify" data-icon="mdi:map-marker"></span></div><p id="location-text" class="action-button-text">ส่งพิกัดที่อยู่</p>
            </div>
            <div class="action-button-wrapper" onclick="handleCallClick(this, 'tel_sawee', '0894745523')">
                <div class="action-button tel-sawi-button"><span class="iconify" data-icon="mdi:phone"></span></div><p class="action-button-text">โทร รพ.สวี</p>
            </div>
            <div class="action-button-wrapper" onclick="handleCallClick(this, 'tel_1669', '1669')">
                <div class="action-button tel-1669-button"><span class="iconify" data-icon="mdi:phone"></span></div><p class="action-button-text">โทร 1669</p>
            </div>`;
    }

    // --- AI & Global Helper Functions ---
    window.handleAiTest = function() { showLayer('layer-ai-intro'); };
    window.startAiTestFlow = function() {
        if (!document.getElementById('pdpa-consent').checked) { alert("กรุณายอมรับเงื่อนไขการใช้งานข้อมูลก่อน"); return; }
        showLayer('layer-ai-input');
    };
    window.handleImageInput = function(input, type) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    const resizedData = canvas.toDataURL('image/jpeg', 0.7);
                    aiInputs[type] = resizedData.split(',')[1];
                    const preview = document.getElementById(`preview-${type}`);
                    preview.src = resizedData; preview.style.display = 'block';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    };
    window.toggleRecording = function() {
        const btn = document.getElementById('btn-record');
        if (btn.innerText.includes("กดเพื่ออัดเสียง")) {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                mediaRecorder = new MediaRecorder(stream); mediaRecorder.start(); audioChunks = [];
                btn.innerHTML = '<span class="iconify" data-icon="mdi:stop"></span> กำลังบันทึก... (หยุดอัตโนมัติ 10 วิ)';
                btn.style.backgroundColor = "#333";
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(blob);
                    const audioPlayback = document.getElementById('audio-playback');
                    audioPlayback.src = audioUrl;
                    document.getElementById('audio-controls-container').style.display = 'block';
                    
                    const reader = new FileReader(); reader.readAsDataURL(blob);
                    reader.onloadend = () => { aiInputs.audio = reader.result.split(',')[1]; };
                    btn.innerHTML = '<span class="iconify" data-icon="mdi:check"></span> บันทึกเสร็จสิ้น (กดเพื่ออัดใหม่)';
                    btn.style.backgroundColor = "#28a745";
                };
                setTimeout(() => { if (mediaRecorder.state === "recording") { mediaRecorder.stop(); } }, 10000);
            });
        } else { if (mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.stop(); } else { btn.innerHTML = '<span class="iconify" data-icon="mdi:microphone"></span> กดเพื่ออัดเสียง'; btn.style.backgroundColor = "#d9534f"; } }
    };
    window.analyzeWithGemini = function() {
        if (!aiInputs.face && !aiInputs.arm && !aiInputs.audio) { alert("กรุณาใส่อย่างน้อย 1 ข้อมูล"); return; }
        showLayer('layer-ai-processing');
        const userDataPayload = { 
            risk_group: sessionData.risk_group, 
            score: sessionData.thai_cv_risk_score,
            userId: sessionData.userID || 'guest',
            name: sessionData.registeredName || sessionData.userName || 'Guest'
        };
        
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'analyzeStroke', faceImage: aiInputs.face, armImage: aiInputs.arm, speechAudio: aiInputs.audio, userData: userDataPayload }) })
        .then(res => res.json()).then(data => { 
            if (data.status === 'success') { 
                currentAnalysisResult = data.data; 
                if (data.data.fileUrls) {
                     sessionData.fileUrls = data.data.fileUrls;
                     sessionData.isAiAssessment = true;
                }
                sessionData.riskScore = data.data.riskScore;
                sessionData.analysis = data.data.analysis;

                displayAiResult(data.data); 
            } else { 
                alert("การวิเคราะห์ขัดข้อง โปรดลองใหม่อีกครั้ง (" + data.message + ")");
                showLayer('layer-ai-input'); 
            } 
        })
        .catch(err => { 
            alert("การเชื่อมต่อขัดข้อง โปรดตรวจสอบอินเทอร์เน็ต (" + err.message + ")"); 
            showLayer('layer-ai-input'); 
        });
    };
    window.requestSummary = function() {
        if (!currentAnalysisResult) return;
        const btn = document.getElementById('btn-gen-summary'); const originalText = btn.innerText;
        btn.innerText = "กำลังสร้างข้อความ..."; btn.disabled = true;
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'generateSummary', data: currentAnalysisResult }) })
        .then(res => res.json()).then(data => {
            btn.innerText = originalText; btn.disabled = false;
            if (data.status === 'success') { document.getElementById('aiSummaryText').value = data.summary; document.getElementById('aiSummaryModal').style.display = 'flex'; } 
            else { alert("ไม่สามารถสร้างสรุปได้: " + data.message); }
        }).catch(err => { btn.innerText = originalText; btn.disabled = false; alert("Connection Error"); });
    };
    window.copySummary = function() { const copyText = document.getElementById("aiSummaryText"); copyText.select(); copyText.setSelectionRange(0, 99999); document.execCommand("copy"); alert("คัดลอกข้อความแล้ว"); };
    
    // --- NEW: Client-side Flex Message Creation ---
    function createFlexMessage(data) {
        const altText = "ผลประเมินสวีรู้ทันสโตรก";
        
        let headerColor = "#28A745"; // Green by default (Normal)
        let title = "ผลการประเมิน: ปกติ";
        let subTitle = "ไม่พบความเสี่ยงชัดเจน";
        
        if (data.isEmergency) {
            headerColor = "#D32F2F"; // Red
            title = "‼️ แจ้งเหตุฉุกเฉิน ‼️";
            subTitle = "พบความเสี่ยงสูง/อาการชัดเจน";
        } else if (data.isAiAssessment && data.riskScore && data.riskScore > 50) {
            headerColor = "#F57C00"; // Orange
            title = "⚠️ มีความเสี่ยงปานกลาง";
            subTitle = `AI Score: ${data.riskScore}%`;
        }

        // --- HERO IMAGE (AI ONLY) ---
        let heroImage = null;
        if (data.isAiAssessment && data.fileUrls) {
            // Prefer Face URL, then Arm URL
            let imgUrl = data.fileUrls.face || data.fileUrls.arm;
            if (imgUrl) {
                // Ensure URL is valid string
                heroImage = {
                    type: "image",
                    url: imgUrl,
                    size: "full",
                    aspectRatio: "20:13",
                    aspectMode: "cover",
                    action: { type: "uri", uri: imgUrl }
                };
            }
        }

        // --- BODY ---
        let bodyContents = [];
        
        // 1. Patient Info Section
        bodyContents.push({
            type: "box", layout: "vertical", margin: "md",
            contents: [
                { type: "text", text: "👤 ข้อมูลผู้ป่วย", weight: "bold", size: "sm", color: "#888888" },
                { type: "text", text: data.registeredName || data.userName || "ไม่ระบุชื่อ", weight: "bold", size: "lg", wrap: true },
                { type: "text", text: `พื้นที่: ต.${data.district || '-'} ม.${data.village || '-'}`, size: "sm", color: "#666666" }
            ]
        });

        // 2. Symptom Section
        let symptomText = data.symptomDetail || "ไม่มีอาการผิดปกติ";
        if (data.isAiAssessment) symptomText = `AI: ${data.analysis || 'วิเคราะห์เรียบร้อย'}`;
        
        bodyContents.push({ type: "separator", margin: "md" });
        bodyContents.push({
            type: "box", layout: "vertical", margin: "md",
            contents: [
                { type: "text", text: "📝 อาการ", weight: "bold", size: "sm", color: "#888888" },
                { type: "text", text: symptomText, wrap: true, size: "sm", color: "#333333" },
                { type: "text", text: `เริ่มเป็นเมื่อ: ${data.onsetTime || '-'}`, size: "xs", color: "#aaaaaa", margin: "xs" }
            ]
        });

        // 3. Location & Emergency Section (If Emergency)
        if (data.isEmergency) {
            bodyContents.push({ type: "separator", margin: "md" });
            bodyContents.push({
                type: "box", layout: "vertical", margin: "md",
                contents: [
                    { type: "text", text: "📍 พิกัด & ติดต่อ", weight: "bold", size: "sm", color: "#888888" },
                    { type: "text", text: data.location || "ไม่ได้ระบุพิกัด", size: "xs", color: "#333333", wrap: true, margin: "xs" }
                ]
            });
        }

        // --- FOOTER BUTTONS ---
        let footerContents = [];
        
        // 1. Map Button (If location exists)
        if (data.location) {
            const loc = data.location.split(',');
            if (loc.length === 2) {
                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${loc[0]},${loc[1]}`;
                footerContents.push({
                    type: "button", style: "secondary", height: "sm", margin: "sm",
                    action: { type: "uri", label: "📍 แผนที่ผู้ป่วย", uri: mapUrl }
                });
            }
        }

        // 2. Call Buttons (Grid Layout)
        if (data.isEmergency) {
            let callButtons = [];
            // Emergency 1669
            callButtons.push({
                type: "button", style: "primary", color: "#D32F2F", height: "sm", margin: "sm",
                action: { type: "uri", label: "📞 1669", uri: "tel:1669" }
            });
            // Hospital
            callButtons.push({
                type: "button", style: "primary", color: "#F57C00", height: "sm", margin: "sm",
                action: { type: "uri", label: "📞 รพ.สวี", uri: "tel:0894745523" }
            });
            
            // Volunteers (if available)
            if (data.volunteerContacts) {
                const c = data.volunteerContacts;
                if (c.pcu_tel) callButtons.push({ type: "button", style: "secondary", height: "sm", margin: "sm", action: { type: "uri", label: "📞 รพ.สต.", uri: `tel:${c.pcu_tel}` } });
                if (c.headman_tel) callButtons.push({ type: "button", style: "secondary", height: "sm", margin: "sm", action: { type: "uri", label: "📞 ผู้นำฯ", uri: `tel:${c.headman_tel}` } });
                if (c.volunteer1_tel) callButtons.push({ type: "button", style: "secondary", height: "sm", margin: "sm", action: { type: "uri", label: "📞 อสม.1", uri: `tel:${c.volunteer1_tel}` } });
            }

            // Add buttons to footer in chunks if too many, but vertical stack is safer for mobile
            callButtons.forEach(btn => footerContents.push(btn));
        }

        // 3. Link Buttons (Standard)
        footerContents.push({ type: "separator", margin: "md" });
        footerContents.push({
            type: "box", layout: "horizontal", margin: "md", spacing: "sm",
            contents: [
                { type: "button", style: "link", height: "sm", action: { type: "uri", label: "ข้อมูลสุขภาพ", uri: `https://liff.line.me/${HEALTH_INFO_LIFF_ID}` } },
                { type: "button", style: "link", height: "sm", action: { type: "uri", label: "ประเมินซ้ำ", uri: `https://liff.line.me/${DAILY_CHECK_LIFF_ID}` } }
            ]
        });

        // 4. Branding Footer
        footerContents.push({ 
            type: "text", 
            text: "จัดทำโดย สวีรู้ทันสโตรก", 
            size: "xxs", 
            color: "#aaaaaa", 
            align: "center", 
            margin: "sm" 
        });

        // Assemble Final JSON
        let flexContainer = {
            type: "bubble",
            header: {
                type: "box", layout: "vertical", backgroundColor: headerColor,
                contents: [
                    { type: "text", text: title, color: "#ffffff", weight: "bold", size: "xl", wrap: true },
                    { type: "text", text: subTitle, color: "#ffffffcc", size: "sm" }
                ]
            },
            body: {
                type: "box", layout: "vertical",
                contents: bodyContents
            },
            footer: {
                type: "box", layout: "vertical",
                contents: footerContents
            }
        };

        if (heroImage) {
            flexContainer.hero = heroImage;
        }

        return { type: "flex", altText: altText, contents: flexContainer };
    }

    function displayAiResult(result) {
        const container = document.getElementById('ai-result-content');
        let html = '';
        if (!result.isValid) {
            html += `<h2 style="color:orange;">⚠️ ข้อมูลไม่ชัดเจน</h2><p>${result.refusalReason || "รูปภาพไม่ชัดเจน หรือไม่ใช่รูปคนที่ต้องการ"}</p><button class="btn-action" style="background:#333; color:white;" onclick="showLayer('layer-ai-input')">ลองถ่ายใหม่</button>`;
        } else {
            if (result.isRisk) { html += `<h2 style="color:var(--symptom-red);">🚨 พบความเสี่ยงสูง (${result.riskScore}%)</h2><div style="background:#fee; padding:15px; border-radius:10px; text-align:left; margin-bottom:15px;"><strong>อาการที่พบ:</strong><ul>`; (result.detectedSymptoms || []).forEach(s => html += `<li>${s}</li>`); html += `</ul><p>${result.analysis}</p></div>`; } 
            else { html += `<h2 style="color:var(--symptom-green);">✅ ไม่พบความเสี่ยงชัดเจน</h2><p>${result.analysis}</p>`; }
            
            html += `<h3>ภาพที่วิเคราะห์</h3>`;
            if (aiInputs.face) { 
                html += `<div class="result-image-container">
                    <img src="data:image/jpeg;base64,${aiInputs.face}">
                    <div class="grid-overlay"></div>
                    <div class="result-label">Face Analysis</div>
                </div>`; 
            }
            if (aiInputs.arm) { 
                html += `<div class="result-image-container">
                    <img src="data:image/jpeg;base64,${aiInputs.arm}">
                    <div class="grid-overlay"></div>
                    <div class="result-label">Arm Analysis</div>
                </div>`; 
            }

            html += `<button id="btn-gen-summary" class="btn-action" style="background-color:#17a2b8; margin-bottom:10px; color:white;" onclick="requestSummary()">✨ สร้างสรุปอาการส่งต่อแพทย์</button>`;
            
            if(result.isRisk) {
                 html += `<button class="btn-action" style="background-color:var(--symptom-red); color:white;" onclick="saveData('symptomDetail', 'AI Analysis Result: ' + '${result.analysis}'); showLayer('layer-3');">ประเมินความเฉียบพลันต่อ</button>`;
            } else {
                 html += `<button class="btn-action" style="background-color:var(--primary-color); margin-top:10px; color:white;" onclick="saveData('symptomDetail', 'AI: No significant risk found'); saveData('isFinalSave', true); handleFinalSave(this, false);">บันทึกและจบการประเมิน</button>`;
            }
        }
        html += `<div class="btn-back-container"><div class="btn-back" onclick="showLayer('layer-ai-input')">ย้อนกลับไปแก้ไขข้อมูล</div></div>`;
        container.innerHTML = html;
        showLayer('layer-ai-result');
    }

    // --- Core Navigation & Utilities ---
    window.showLayer = function(id) { document.querySelectorAll('[data-layer]').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); };
    window.saveData = function(key, value) { sessionData[key] = value; };
    window.viewImage = function(src) { const modal = document.getElementById('image-viewer-modal'); document.getElementById('full-image').src = src; modal.style.display = "flex"; };
    
    // Database & Final Save Logic
    window.handleFinalSave = function(button, isEmergency) {
        if(button && button.disabled) return;
        
        // --- FORCE LOCATION FOR EMERGENCY CASES ---
        if (isEmergency && !sessionData.location) {
            if(confirm("สำหรับเคสฉุกเฉิน จำเป็นต้องระบุพิกัดเพื่อความช่วยเหลือที่แม่นยำ\nกด 'ตกลง' เพื่อส่งพิกัด")) {
                 // Reuse existing location logic but callback to save again
                 getLocation(false, true, () => {
                     handleFinalSave(button, isEmergency);
                 });
            }
            return;
        }

        if(button) button.disabled = true;
        sessionData.isEmergency = isEmergency;
        sessionData.isFinalSave = true; 
        
        const callbackName = 'saveCallback' + Date.now();
        window[callbackName] = function(response) {
            if (response && response.status === 'success') {
                if (liff.isInClient()) {
                    // --- NEW: Client-side Message Sending ---
                    const flexMsg = createFlexMessage(sessionData);
                    let messagesToSend = [flexMsg];
                    
                    if (isEmergency) {
                        const instructionText = "คำแนะนำเบื้องต้น:\n1. โทร 1669 ทันที\n2. ให้นอนราบหรือเอนศีรษะสูงเล็กน้อย\n3. ห้ามกินยาหรือดื่มน้ำ\n4. เตรียมบัตรประชาชนและข้อมูลยา";
                        messagesToSend.push({ type: 'text', text: instructionText });
                    }

                    liff.sendMessages(messagesToSend)
                        .then(() => {
                            if (currentActionKey === 'บันทึกและปิด' || !isEmergency) {
                                liff.closeWindow();
                            } else {
                                alert("ส่งข้อมูลเรียบร้อย");
                                if(document.getElementById('how-to-act-modal').style.display !== 'flex') {
                                     liff.closeWindow();
                                }
                            }
                        })
                        .catch((err) => {
                            console.error('LIFF Send Error', err);
                            alert("บันทึกแล้ว (ส่งข้อความไม่สำเร็จ: " + err.code + ")");
                            if (currentActionKey === 'บันทึกและปิด') liff.closeWindow();
                        });
                } else {
                    if (isEmergency) {
                        document.getElementById('how-to-act-modal').style.display = 'flex';
                    } else {
                        alert("บันทึกข้อมูลเรียบร้อย");
                    }
                }
            } else { 
                alert("เกิดข้อผิดพลาดในการบันทึก: " + (response ? response.message : 'Unknown error')); 
            }
            if(button) button.disabled = false;
        };
        const dataStr = encodeURIComponent(JSON.stringify(sessionData));
        const url = `${GAS_URL}?action=saveData&callback=${callbackName}&data=${dataStr}`;
        const scriptTag = document.createElement('script'); scriptTag.src = url; document.head.appendChild(scriptTag);
    };
    
    // --- UPDATED CALL FLOW LOGIC ---
    window.handleCallClick = function(element, key, tel) {
        currentActionKey = key;
        currentActionElement = element;
        pendingCallUrl = `tel:${tel}`;
        
        document.getElementById('confirmLocationModal').style.display = 'flex';
    };

    window.executePendingCall = function() {
        if(pendingCallUrl) {
            sessionData.contactedVia = currentActionKey;
            if(currentActionKey.startsWith('tel_')) sessionData[currentActionKey] = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
            
            const payload = { ...sessionData, isEmergency: true }; 
            const dataStr = encodeURIComponent(JSON.stringify(payload));
            const url = `${GAS_URL}?action=saveData&data=${dataStr}`; 
            const img = new Image(); img.src = url; 
            
            document.getElementById('how-to-act-modal').style.display = 'flex';
            
            window.location.href = pendingCallUrl;
        }
    }
    
    window.getLocation = function(andThenSave = false, callAfter = false, callback = null) {
        const locButton = document.getElementById('location-action'); 
        const locText = document.getElementById('location-text');
        if (locButton) {
             locButton.onclick = null; locText.textContent = 'กำลังค้นหา...';
        }
        
        navigator.geolocation.getCurrentPosition(position => {
            if(locButton) {
                locButton.classList.add('success'); locButton.innerHTML = `<span class="iconify" data-icon="mdi:check-circle"></span>`; locText.textContent = 'ส่งพิกัดแล้ว';
            }
            const { latitude, longitude } = position.coords; 
            saveData('location', `${latitude},${longitude}`);
            
            const distance = getDistanceFromLatLonInKm(latitude, longitude, hospitalCoords.lat, hospitalCoords.lon);
            updateSummaryAndActions(distance);
            
            if (callback) {
                callback();
            } else if (callAfter) {
                 document.getElementById('confirmLocationModal').style.display = 'none';
                 executePendingCall();
            } else if (andThenSave) {
                // Legacy support
            }
        }, error => { 
            if(locButton) {
                locButton.onclick = () => getLocation(andThenSave, callAfter, callback); locText.textContent = 'ส่งพิกัดที่อยู่'; updateSummaryAndActions(null); 
            }
            alert("ไม่สามารถรับพิกัดได้ กรุณาลองใหม่อีกครั้ง หรือกดโทรเลย");
        });
    };

    window.triggerSave = function(element, key, isFinalSave = false) {
        currentActionKey = key;
        handleFinalSave(element, true);
    };

    // ... (Keep fetchUserData, volunteer data, manual flow logic the same) ...
    // Note: I'm keeping the rest of the file identical to preserve context, 
    // just the Call Flow and Final Save logic needed heavy changes.
    // ...
    window.fetchUserData = function(userId) {
        const url = `${GAS_URL}?action=getUserData&userId=${userId}&callback=processUserData`;
        const scriptTag = document.createElement('script'); scriptTag.src = url; document.head.appendChild(scriptTag);
    };
    window.processUserData = function(response) {
        const infoBar = document.getElementById('user-info-bar');
        const uiName = document.getElementById('ui-name');
        const uiRisk = document.getElementById('ui-risk');
        const uiDate = document.getElementById('ui-date');
        const phoneInput = document.getElementById('patient-phone');
        
        if (response.status === 'found' && response.data) {
            const data = response.data;
            sessionData.registeredName = data.name; sessionData.district = data.district; sessionData.village = data.village; sessionData.risk_group = data.risk_group; 
            sessionData.thai_cv_risk_score = data.thai_cv_risk_score;
            uiName.textContent = data.name || '-';
            uiRisk.textContent = (data.risk_group || '-') + (data.thai_cv_risk_score ? ` (${data.thai_cv_risk_score}%)` : '');
            uiDate.textContent = data.timestamp || '-';
            infoBar.style.display = 'flex';
            
            if (phoneInput && phoneInput.value.length === 10) phoneInput.style.borderColor = "#28a745";
            if(sessionData.district && sessionData.village) { fetchVolunteerData(`ต.${sessionData.district} ม.${sessionData.village}`); }
        } else {
             infoBar.style.display = 'none';
             if (phoneInput && phoneInput.value.length === 10) {
                 phoneInput.style.borderColor = "#dc3545";
                 alert("ไม่พบข้อมูลของเบอร์โทรนี้");
            }
        }
    };
    window.fetchVolunteerData = function(areaKey) { const url = `${GAS_URL}?action=getVolunteerData&areaKey=${encodeURIComponent(areaKey)}&callback=processVolunteerData`; const scriptTag = document.createElement('script'); scriptTag.src = url; document.head.appendChild(scriptTag); };
    window.processVolunteerData = function(response) { if (response.status === 'found') { sessionData.volunteerContacts = response.data; } };
    window.handleNoSymptom = function() { document.getElementById('review-container').innerHTML = Object.keys(symptomImages).map(key => 
        `<div class="symptom-card" style="margin-bottom:15px; flex-direction:row; justify-content:space-between; padding:20px;" onclick="showLayer2('${key}')">
            <img src="${symptomImages[key]}" style="width:80px; height:80px; margin:0;">
            <div style="flex-grow:1; text-align:left; padding-left:15px;"><h3 style="margin:0;">${symptomTranslations[key]}</h3><p style="font-weight:normal;">กดเพื่อประเมิน</p></div>
            <span class="iconify" data-icon="mdi:chevron-right" style="font-size:30px; color:#ccc;"></span>
        </div>`).join('') + `<button class="btn-unlikely" style="margin-top:20px;" onclick="handleFinalNoSymptom()">ยืนยันไม่มีอาการ</button>`;
        showLayer('layer-no-symptom-review');
    };
    window.handleFinalNoSymptom = function() { saveData('symptomCategory', 'ไม่มีอาการ'); saveData('randomGreeting', "เยี่ยมมาก! วันนี้คุณไม่มีอาการน่าสงสัยสโตรกเลย"); showFinalMessage("เยี่ยมมาก!", "วันนี้คุณไม่มีอาการน่าสงสัยสโตรกเลย"); };
    window.showFinalMessage = function(title, text) { saveData('symptomDetail', text); document.getElementById('final-title').textContent = title; document.getElementById('final-text').textContent = text; document.getElementById('final-emoji').textContent = '👍'; showLayer('layer-6'); };

    // Utils
    function formatTime(date) { return date.toTimeString().slice(0, 5); }
    function formatFullDateTime(date) { if (!date || isNaN(new Date(date).getTime())) return 'N/A'; const d = new Date(date); return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth()+1).padStart(2, '0')}/${d.getFullYear()+543} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')} น.`; }
    function formatDuration(minutes) { if (isNaN(minutes) || minutes < 0) return 'N/A'; const h = Math.floor(minutes / 60); const m = Math.round(minutes % 60); return h > 0 ? `${h} ชม. ${m} นาที` : `${m} นาที`; }
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2-lat1) * Math.PI/180; const dLon = (lon2-lon1) * Math.PI/180; const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
</script>
</body>
</html>
</script>