<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประเมินอาการสโตรกรายวัน</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007BFF; --background-color: #f0f2f5;
            --card-bg-color: #ffffff; --text-color: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.1); --border-radius: 12px;
            --symptom-red: #D32F2F; --symptom-green: #388E3C;
            --dark-red: #C0392B; --light-red-bg: #FADBD8;
        }
        body { font-family: "Noto Sans Thai", sans-serif; background-color: var(--background-color); margin: 0; padding: 16px; font-size: 1.2em; }
        .main-container { max-width: 600px; margin: 0 auto; }
        .section-title { font-size: 1.5em; font-weight: 700; color: var(--text-color); margin-bottom: 0; display: flex; align-items: center; justify-content: center; }
        .section-subtitle { font-size: 1em; color: #555; margin-top: 4px; margin-bottom: 24px; }
        .card { padding: 24px; background-color: var(--card-bg-color); border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 16px; position: relative; padding-bottom: 70px; }
        .symptom-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .symptom-card { border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; padding: 12px; cursor: pointer; transition: transform 0.2s ease; display: flex; flex-direction: column; justify-content: space-between; align-items: center; }
        .symptom-card:hover { transform: translateY(-5px); }
        .symptom-card img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 8px; margin-bottom: 8px; }
        .symptom-card p { margin: 0; font-size: 1.1em; font-weight: bold; line-height: 1.3; }
        .symptom-card .symptom-text-red { color: var(--symptom-red); }
        .symptom-card .symptom-text-blue { color: #0b5394; }
        button { font-family: "Noto Sans Thai", sans-serif; cursor: pointer; border: none; }
        .options-container { text-align: center; }
        .options-container button { display: block; width: 100%; padding: 15px; margin: 8px 0; border-radius: 8px; font-size: 1em; font-weight: bold; }
        .btn-action { width: 90%; margin: 20px auto 0 auto; color: white; }
        .btn-final-save { background-color: #28a745; }
        .btn-symptom-likely { background-color: var(--symptom-red); color: white; }
        .btn-symptom-unlikely { background-color: var(--symptom-green); color: white; }
        .btn-severity-acute { background-color: var(--symptom-red); color: white; }
        .btn-severity-chronic { background-color: #E67E22; color: white; }
        .emergency-text-container { background-color: var(--light-red-bg); border-radius: var(--border-radius); padding: 20px; text-align: center; margin-bottom: 24px; }
        .emergency-text-container p { margin: 0; line-height: 1.6; font-size: 1.1em; }
        .emergency-text-container .highlight-large { font-size: 1.5em; font-weight: bold; color: var(--dark-red); }
        .blink { animation: blinker 1.2s linear infinite; font-weight: bold; color: var(--symptom-red); }
        @keyframes blinker { 50% { opacity: 0.2; } }
        .btn-back { background: none; color: var(--primary-color); padding: 10px; font-size: 0.9em; position: absolute; bottom: 10px; right: 20px; }
        .hidden { display: none; }
        .info-icon { font-size: 18px; cursor: pointer; color: #007BFF; margin-left: 8px; font-style: normal; border: 1px solid #007BFF; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 10px; width: 85%; max-width: 400px; text-align: left; }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="layer-1" data-layer="1">
            <h1 class="section-title">ประเมินอาการสโตรกรายวัน <span id="info-icon" class="info-icon">i</span></h1>
            <p class="section-subtitle">วันนี้ท่านมีอาการตามหลัก BEFAST หรือไม่?</p>
            <div class="symptom-grid">
                <div class="symptom-card" onclick="showLayer2('การทรงตัว')"><img src="https://i.ibb.co/GMvMmZV/ezgif-2-563a5d8327-apng.png" alt="เซ"><p class="symptom-text-red">การทรงตัว</p></div>
                <div class="symptom-card" onclick="showLayer2('สายตา')"><img src="https://i.ibb.co/9r0cMc2/ezgif-2-5374788704.png" alt="ตา"><p class="symptom-text-red">สายตา</p></div>
                <div class="symptom-card" onclick="showLayer2('ใบหน้า')"><img src="https://i.ibb.co/nRJc4MX/ezgif-2-8b010716d3.png" alt="หน้า"><p class="symptom-text-red">ใบหน้า</p></div>
                <div class="symptom-card" onclick="showLayer2('แขนขา')"><img src="https://i.ibb.co/G7Vbn9V/ezgif-2-b6c57b3b00.png" alt="แขน"><p class="symptom-text-red">แขนขา</p></div>
                <div class="symptom-card" onclick="showLayer2('การพูด')"><img src="https://i.ibb.co/gVYy8Nf/ezgif-2-01c5ed2695.png" alt="พูด"><p class="symptom-text-red">การพูด</p></div>
                <div class="symptom-card" onclick="handleNoSymptom()"><img src="https://i.ibb.co/yVP6CGv/image.png" alt="ไม่มีอาการ"><p class="symptom-text-blue">ไม่มีอาการ</p></div>
            </div>
        </div>

        <div id="layer-2" class="card hidden" data-layer="2">
            <h2 id="layer-2-title" class="section-title"></h2>
            <p class="section-subtitle">กรุณาเลือกรายละเอียดอาการที่ใกล้เคียงที่สุด</p>
            <div id="layer-2-buttons" class="options-container"></div>
            <button class="btn-back" onclick="goBack()">ย้อนกลับ</button>
        </div>

        <div id="layer-3" class="card hidden" data-layer="3">
            <h2 class="section-title">อาการดังกล่าวเกิดขึ้นอย่างไร?</h2>
            <div class="options-container">
                <button class="btn-severity-acute" onclick="handleSeveritySelection('เกิดขึ้นอย่างเฉียบพลัน')">เกิดขึ้นอย่างเฉียบพลัน</button>
                <button class="btn-severity-chronic" onclick="handleChronicSymptom('เกิดขึ้นเรื้อรัง/ค่อยๆ เป็น')">เป็นมานาน/ค่อยๆเป็น</button>
            </div>
            <button class="btn-back" onclick="goBack()">ย้อนกลับ</button>
        </div>
        
        <div id="layer-final" class="card hidden" data-layer="final">
             <h2 id="final-title" class="section-title" style="text-align:center;"></h2>
             <p id="final-text" style="text-align:center;"></p>
             <button class="btn-action btn-final-save" onclick="handleFinalSave(this)">บันทึกและปิด</button>
        </div>

        <div id="disclaimerModal" class="modal hidden">
            <div class="modal-content">
                <h2 style="text-align:center;">ข้อจำกัดความรับผิดชอบ</h2>
                <p>• แอปพลิเคชันนี้ใช้เพื่อ **เสนอข้อมูลและประเมินอาการเบื้องต้น** เท่านั้น ไม่ใช่การวินิจฉัยทางการแพทย์</p>
                <p>• การตัดสินใจรักษาต้องพิจารณาจากปัจจัยจริงโดยบุคลากรทางการแพทย์</p>
                <p>• แอปพลิเคชันนี้ **ไม่ได้โทรออกฉุกเฉินให้ท่าน** หากมีเหตุจำเป็น ท่านต้องเป็นผู้กดโทรออกด้วยตนเอง</p>
                <button onclick="document.getElementById('disclaimerModal').style.display='none'" style="background-color:var(--primary-color); color:white; width:100%; padding:10px; margin-top:15px; border-radius:8px;">ตกลง</button>
            </div>
        </div>
    </div>

<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>
    // --- ค่าจริงของคุณได้ถูกใส่ไว้เรียบร้อยแล้ว ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyptTEQF-bSEVcghqYZlQdPdP9WWbxn7JDzbidpI-m6wCe23ASFET9GF6M2l5RHBaz4/exec";
    const LIFF_ID = "2005789397-WRm1lYd9";
    
    // --- Global Variables & Data ---
    let currentLayer = 1;
    let sessionData = {};

    // --- [ปรับปรุงใหม่] รายละเอียดอาการแบบกระชับ ---
    const symptomDetails = {
        'การทรงตัว': {
            likely: ['เดินเซรุนแรง, ทรงตัวไม่ได้', 'เวียนหัวรุนแรง, บ้านหมุน'],
            unlikely: ['เวียนหัวเล็กน้อยពេលเปลี่ยนท่า', 'อาการของโรคน้ำในหู', 'ทรงตัวลำบาก (เรื้อรัง)']
        },
        'สายตา': {
            likely: ['ตามัว/มืดบอดหนึ่งข้าง', 'เห็นภาพซ้อน', 'มองไม่เห็นภาพครึ่งซีก'],
            unlikely: ['ปัญหาสายตาที่เป็นอยู่เดิม', 'เห็นจุดดำลอยไปมา']
        },
        'ใบหน้า': {
            likely: ['ใบหน้าเบี้ยว/มุมปากตก', 'หลับตาไม่สนิทหนึ่งข้าง'],
            unlikely: ['อาจเป็น Bell\'s Palsy', 'บวมจากปัญหาในช่องปาก']
        },
        'แขนขา': {
            likely: ['แขน/ขาอ่อนแรงซีกเดียว', 'ยกแขนไม่ขึ้น/ของหลุดมือ'],
            unlikely: ['ชาจากการนอนทับ', 'ปวด/อักเสบกล้ามเนื้อ']
        },
        'การพูด': {
            likely: ['พูดไม่ชัด, ลิ้นแข็ง, อ้อแอ้', 'นึกคำพูดไม่ออก/ใช้คำผิด', 'ไม่เข้าใจคำพูดผู้อื่น'],
            unlikely: ['พูดติดขัดเพราะเหนื่อย/เครียด', 'เสียงแหบ/ปัญหาการได้ยิน']
        }
    };

    // --- Core Functions ---
    window.onload = async () => {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                sessionData.userID = profile.userId;
                sessionData.userName = profile.displayName;
            } else { liff.login(); }
        } catch (err) {
            alert("ไม่สามารถเชื่อมต่อกับ LINE ได้ โปรดลองเปิดใหม่อีกครั้ง");
        }
        document.getElementById('info-icon').onclick = () => { document.getElementById('disclaimerModal').style.display = 'flex'; };
    };

    function saveData(key, value) {
        sessionData[key] = value;
        console.log("Data Stored:", sessionData);
    }
    
    function handleFinalSave(button) {
        button.textContent = 'กำลังบันทึก...';
        button.disabled = true;

        const callbackName = 'saveCallback' + Date.now();
        window[callbackName] = function(response) {
            if (response && response.status === 'success') {
                if (liff.isInClient()) liff.closeWindow();
                else alert("บันทึกข้อมูลเรียบร้อยแล้ว");
            } else {
                alert("เกิดข้อผิดพลาดในการบันทึก: " + (response ? response.message : 'Unknown error'));
                button.textContent = 'บันทึกและปิด';
                button.disabled = false;
            }
            delete window[callbackName];
            document.head.removeChild(scriptTag);
        };

        const dataStr = encodeURIComponent(JSON.stringify(sessionData));
        const url = `${GAS_URL}?callback=${callbackName}&data=${dataStr}`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        scriptTag.onerror = function() {
            alert("ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้");
            button.textContent = 'บันทึกและปิด';
            button.disabled = false;
            delete window[callbackName];
        };
        document.head.appendChild(scriptTag);
    }
    
    // --- UI & Flow Functions ---
    function showLayer(layerNumber) {
        currentLayer = layerNumber;
        document.querySelectorAll('[data-layer]').forEach(el => el.classList.add('hidden'));
        document.getElementById(`layer-${layerNumber}`).classList.remove('hidden');
        window.scrollTo(0, 0);
    }
    
    function goBack() { if (currentLayer > 1) showLayer(currentLayer - 1); }

    function showFinalMessage(title, text) {
        document.getElementById('final-title').textContent = title;
        document.getElementById('final-text').textContent = text;
        showLayer('final');
    }

    function createButton(container, text, className, onClick) {
        const button = document.createElement('button');
        button.textContent = text;
        button.className = className;
        button.onclick = onClick;
        container.appendChild(button);
    }

    function showLayer2(symptomCategory) {
        saveData('symptomCategory', symptomCategory);
        document.getElementById('layer-2-title').textContent = `อาการด้าน${symptomCategory}`;
        const buttonsContainer = document.getElementById('layer-2-buttons');
        buttonsContainer.innerHTML = '';
        const details = symptomDetails[symptomCategory];
        
        details.likely.forEach(text => createButton(buttonsContainer, text, 'btn-symptom-likely', () => handleSymptomResult(true, text)));
        details.unlikely.forEach(text => createButton(buttonsContainer, text, 'btn-symptom-unlikely', () => handleSymptomResult(false, text)));
        showLayer(2);
    }

    function handleNoSymptom() {
        saveData('symptomCategory', 'ไม่มีอาการ');
        showFinalMessage("เยี่ยมมาก!", "วันนี้คุณไม่มีอาการน่าสงสัย ขอให้มีสุขภาพที่แข็งแรงต่อไปครับ");
    }

    function handleSymptomResult(isLikely, symptomDetail) {
        saveData('symptomDetail', symptomDetail);
        if (isLikely) { 
            showLayer(3); 
        } else {
            saveData('frequency', 'อาจไม่เข้าข่ายสโตรกเฉียบพลัน');
            showFinalMessage("คำแนะนำเบื้องต้น", "อาการดังกล่าวอาจไม่ใช่อาการของสโตรกเฉียบพลัน แต่หากกังวลควรปรึกษาแพทย์");
        }
    }
    
    function handleSeveritySelection(frequencyText) {
        saveData('frequency', frequencyText);
        // เมื่อเลือก "เฉียบพลัน" ให้ข้ามไปหน้าสรุปฉุกเฉินทันที
        // โดยตั้งเวลาเป็น "ตอนนี้"
        const now = new Date();
        sessionData.onsetTimeObject = now;
        saveData('onsetTime', formatFullDateTime(now));

        // สร้างหน้าสรุปฉุกเฉิน (จะถูกแทนที่ด้วย app ที่ซับซ้อนกว่าในอนาคต)
        // สำหรับตอนนี้ เราจะแสดง alert และบันทึกข้อมูล
        alert("ตรวจพบอาการเฉียบพลันที่เข้าข่ายสโตรก! โปรดโทร 1669 ทันที");
        handleFinalSave(document.createElement('button')); // ส่งปุ่มจำลองเพื่อบันทึก
    }

    function handleChronicSymptom(frequencyText) {
        saveData('frequency', frequencyText);
        showFinalMessage("คำแนะนำ", "อาการที่เป็นมานานหรือเรื้อรัง ควรปรึกษาแพทย์เพื่อหาสาเหตุที่แท้จริง");
    }

    function formatFullDateTime(date) {
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear() + 543;
        const hh = String(date.getHours()).padStart(2, '0');
        const mm = String(date.getMinutes()).padStart(2, '0');
        const ss = String(date.getSeconds()).padStart(2, '0');
        return `${d}/${m}/${y} ${hh}:${mm}:${ss}`;
    }
</script>
</body>
</html>