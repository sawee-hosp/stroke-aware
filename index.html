<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประเมินอาการสโตรก</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007BFF; --background-color: #f0f2f5;
            --card-bg-color: #ffffff; --text-color: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.1); --border-radius: 12px;
            --symptom-red: #D32F2F; --symptom-green: #388E3C;
            --dark-red: #C0392B; --light-red-bg: #FFF0F0;
            --action-blue: #007BFF; --action-green: #28A745;
            --action-red: #D32F2F; --action-gray: #6C757D;
        }
        body { font-family: "Noto Sans Thai", sans-serif; background-color: var(--background-color); margin: 0; padding: 16px; font-size: 18px; }
        .main-container { max-width: 600px; margin: 0 auto; }
        .card { padding: 24px; background-color: var(--card-bg-color); border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 16px; position: relative; }
        .card-body { padding-bottom: 50px; }
        .section-title { font-size: 1.6em; font-weight: 700; color: var(--text-color); display: flex; align-items: center; justify-content: center; }
        .section-subtitle { font-size: 1.1em; color: #555; margin-top: 4px; margin-bottom: 24px; text-align: center; }
        
        .symptom-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .symptom-card { border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; padding: 12px; cursor: pointer; transition: transform 0.2s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 150px; }
        .symptom-card:hover { transform: translateY(-5px); }
        .symptom-card img { width: 100%; max-width: 100px; aspect-ratio: 1 / 1; object-fit: contain; margin-bottom: 8px; }
        .symptom-card p { margin: 0; line-height: 1.3; font-weight: bold; }
        .symptom-card p.large-red { font-size: 24px; color: var(--symptom-red); }
        .symptom-card p.large-blue { font-size: 24px; color: var(--primary-color); }

        button { font-family: "Noto Sans Thai", sans-serif; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; }
        .options-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .options-container button { padding: 12px 18px; font-size: 1em; flex-grow: 1; color: white; }
        .time-options button { width: calc(33.33% - 6px); flex-grow: 0; margin-bottom: 8px; font-size: 0.9em; padding: 10px 5px; color: #333;}
        .btn-action { width: 100%; padding: 15px; color: white; margin-top: 20px; font-size: 1.2em; border-radius: 10px; }
        .btn-final-confirm { background-color: var(--primary-color); font-size: 1.3em !important; padding: 20px !important; }
        .btn-symptom-likely { background-color: var(--symptom-red); }
        .btn-symptom-unlikely { background-color: var(--symptom-green); }
        .btn-severity-acute { background-color: var(--symptom-red); color: white; width:100%; }
        .btn-severity-chronic { background-color: #E67E22; color: white; width:100%; }
        .btn-back { background: none; color: var(--primary-color); padding: 10px; font-size: 1em; margin-top: 20px; text-align: right; width: 100%; display: block; }

        .emergency-text-container { padding: 15px; text-align: center; background: var(--light-red-bg); border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--symptom-red); }
        .emergency-text-container .highlight-large { font-size: 1.5em; font-weight: bold; color: var(--dark-red); animation: blinker 1.2s linear infinite; }
        .emergency-text-container .highlight-small { font-size: 0.9em; color: black; animation: blinker 1.5s linear infinite; }
        .countdown-timer { font-size: 1.0em; color: var(--primary-color); font-weight: bold; margin-top: 8px; }
        @keyframes blinker { 50% { opacity: 0.3; } }
        .action-buttons-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; place-items: center; }
        .action-button { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100px; height: 100px; border-radius: 15px; cursor: pointer; text-align: center; color: white; text-decoration: none; transition: background-color 0.3s; }
        .action-button-icon { width: 48px; height: 48px; }
        .action-button-text { font-size: 0.9em; margin-top: 5px; font-weight: bold; color: #555;}
        .location-button { background-color: var(--action-blue); }
        .location-button.success { background-color: var(--action-green); }
        .tel-button { background-color: var(--action-red); }
        #summary-container .info-card { display: flex; align-items: center; gap: 15px; padding: 12px 5px; border-bottom: 1px solid #eee; }
        .info-card-icon { width: 30px; height: 30px; flex-shrink: 0; color: var(--primary-color);}
        .info-card-text p { margin: 0; }
        .info-card-text .label { font-size: 0.9em; color: #666; }
        .info-card-text .value { font-size: 1em; font-weight: bold; color: var(--text-color); }
        .contact-buttons { margin-top: 20px; }
        .contact-button { display: flex; align-items: center; gap: 10px; border: 2px solid var(--action-gray); border-radius: 10px; padding: 12px; margin-bottom: 10px; text-decoration: none; color: var(--text-color); font-weight: bold; transition: background-color 0.2s; }
        .contact-button:hover { background-color: #f0f0f0; }
        .contact-button svg { width: 24px; height: 24px; fill: var(--action-gray); }
        .contact-button .label { flex-grow: 1; }
        .route-button { border-color: #34A853; color: #34A853; background-color: transparent !important; }
        .route-button svg { fill: #34A853; }
        .hidden { display: none; }
        .info-icon { font-size: 16px; cursor: pointer; color: var(--primary-color); margin-left: 8px; font-style: normal; border: 1px solid var(--primary-color); border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; vertical-align: middle; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-content p, .modal-content li { font-size: 0.9em; margin: 10px 0; }
        .modal-content ul { padding-left: 20px; }
        .modal-content button { width: 100%; padding: 15px; font-size: 1.1em; border-radius: 10px; }
        #history-card { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="layer-1" data-layer="1" class="card">
            <div class="card-body">
                <h1 class="section-title">ประเมินอาการสโตรก <span id="info-icon" class="info-icon">i</span></h1>
                <p class="section-subtitle">วันนี้ท่านมีอาการผิดปกติหรือไม่?</p>
                <div class="symptom-grid">
                    <div class="symptom-card" onclick="showLayer2('Balance')"><img src="https://i.ibb.co/GMvMmZV/ezgif-2-563a5d8327-apng.png" alt="Balance"><p class="large-red">เซ/มึนหัว</p></div>
                    <div class="symptom-card" onclick="showLayer2('Eye')"><img src="https://i.ibb.co/9r0cMc2/ezgif-2-5374788704.png" alt="Eye"><p class="large-red">ตามัวมาก</p></div>
                    <div class="symptom-card" onclick="showLayer2('Face')"><img src="https://i.ibb.co/nRJc4MX/ezgif-2-8b010716d3.png" alt="Face"><p class="large-red">มุมปากตก</p></div>
                    <div class="symptom-card" onclick="showLayer2('Arm')"><img src="https://i.ibb.co/G7Vbn9V/ezgif-2-b6c57b3b00.png" alt="Arm"><p class="large-red">ยกแขนยาก</p></div>
                    <div class="symptom-card" onclick="showLayer2('Speech')"><img src="https://i.ibb.co/gVYy8Nf/ezgif-2-01c5ed2695.png" alt="Speech"><p class="large-red">ลำบากพูด</p></div>
                    <div class="symptom-card" onclick="handleNoSymptom()"><img src="https://i.ibb.co/yVP6CGv/image.png" alt="No Symptom"><p class="large-blue">ไม่มีอาการ</p></div>
                </div>
            </div>
        </div>

        <div id="layer-2" data-layer="2" class="card hidden">
            <div class="card-body">
                <h2 id="layer-2-title" class="section-title" style="text-align:center; font-size:1.4em;"></h2>
                <p class="section-subtitle">กรุณาเลือกรายละเอียดอาการที่ใกล้เคียงที่สุด</p>
                <div id="layer-2-buttons" class="options-container"></div>
            </div>
            <div class="btn-back" onclick="goBack('layer-1')">ย้อนกลับ</div>
        </div>

        <div id="layer-3" data-layer="3" class="card hidden">
            <div class="card-body">
                <h2 class="section-title" style="text-align:center; font-size:1.4em;">อาการเกิดขึ้นอย่างไร?</h2>
                <div class="options-container">
                    <button class="btn-severity-acute" onclick="handleSeveritySelection('เกิดขึ้นอย่างเฉียบพลัน')">เกิดขึ้นอย่างเฉียบพลัน</button>
                    <button class="btn-severity-chronic" onclick="handleChronicSymptom('เกิดขึ้นเรื้อรัง/ค่อยๆ เป็น')">เป็นมานาน/ค่อยๆเป็น</button>
                </div>
            </div>
            <div class="btn-back" onclick="goBack('layer-2')">ย้อนกลับ</div>
        </div>

        <div id="layer-4" data-layer="4" class="card hidden">
            <div class="card-body">
                <h2 class="section-title" style="text-align:center; font-size:1.4em;">อาการเริ่มเป็นเมื่อไหร่?</h2>
                <p class="section-subtitle">โปรดประมาณการเวลาให้ใกล้เคียงที่สุด</p>
                <div class="options-container time-options" id="time-options-container"></div>
            </div>
            <div class="btn-back" onclick="goBack('layer-3')">ย้อนกลับ</div>
        </div>
        
        <div id="layer-5" data-layer="5" class="card hidden">
            <div class="card-body">
                 <div class="emergency-text-container">
                     <p class="highlight-large">อาจเป็นอาการสโตรก!</p>
                     <p class="highlight-small">โปรดโทรเรียกรถพยาบาลทันที</p>
                     <div id="countdown-timer" class="countdown-timer"></div>
                     <p style="font-size:0.8em; margin-top:8px;">หลังจากกดส่งพิกัดและกดโทรออกด้วยตัวเอง</p>
                 </div>
                 <div id="action-grid-container" class="action-buttons-grid"></div>
                 <hr style="margin-top:20px; border-top: 1px solid #ddd; border-bottom: none;">
                 <div id="summary-container"></div>
                 <div id="time-details-container"></div>
                 <div id="contact-buttons" class="contact-buttons"></div>
                 <div id="route-button-container"></div>
                 <button class="btn-action" style="background-color: var(--dark-red); font-size:1.3em; padding: 20px;" onclick="triggerSave(this)">บันทึกข้อมูลและปิดหน้าต่าง</button>
            </div>
            <div class="btn-back" onclick="goBack('layer-4')">ย้อนกลับ</div>
        </div>
        
        <div id="layer-6" data-layer="6" class="card hidden">
            <div class="card-body">
                <div id="final-emoji" style="text-align:center; font-size: 4em; margin-bottom: 10px;"></div>
                <h2 id="final-title" class="section-title" style="text-align:center; font-size:1.4em;"></h2>
                <p id="final-text" style="text-align:center; font-size:1.1em;"></p>
                <button class="btn-action btn-final-confirm" style="font-size:1.3em; padding: 20px;" onclick="handleFinalSave(this, false)">บันทึกและปิด</button>
            </div>
        </div>
        
        <div id="disclaimerModal" class="modal hidden" onclick="this.style.display='none'">
            <div class="modal-content" onclick="event.stopPropagation()">
                <h2 style="text-align:center; font-size:1.2em;">ข้อจำกัดความรับผิดชอบ</h2>
                <p>• แอปพลิเคชันนี้ใช้เพื่อ <strong>ประเมินอาการเบื้องต้น</strong> เท่านั้น ไม่ใช่การวินิจฉัยทางการแพทย์</p>
                <p>• การตัดสินใจรักษาต้องพิจารณาจากปัจจัยจริงโดยบุคลากรทางการแพทย์</p>
                <p>• แอปพลิเคชันนี้ <strong>ไม่ได้โทรออกฉุกเฉินให้ท่าน</strong> หากมีเหตุจำเป็น ท่านต้องเป็นผู้กดโทรออกด้วยตนเอง</p>
                <p style="font-size:0.9em; color:#555;">การประเมินนี้เป็นการคัดกรองตามอาการ ไม่ได้รวมปัจจัยเสี่ยงส่วนบุคคล เช่น ความดันโลหิต หรือเบาหวาน</p>
                <button onclick="document.getElementById('disclaimerModal').style.display='none'" style="background-color:var(--primary-color); color:white; font-size:1.2em; padding:15px; border-radius: 10px;">รับทราบ</button>
            </div>
        </div>
        <div id="how-to-act-modal" class="modal hidden">
             <div class="modal-content">
                <h2 style="text-align:center;">ข้อควรปฏิบัติขณะเดินทาง</h2>
                <div style="text-align:left; font-size:0.9em;">
                    <strong>1. ทันทีที่สงสัยว่ามีอาการสโตรก</strong>
                    <ul>
                        <li>โทรแจ้งเหตุฉุกเฉินทันที แจ้งว่า “สงสัยสโตรก”</li>
                        <li>แจ้งชื่อผู้ป่วย, เวลาเริ่มมีอาการครั้งแรก, และที่อยู่ปัจจุบัน</li>
                        <li>หากส่งข้อมูลผ่านแอปแล้วให้แจ้งว่า <strong style="color: var(--symptom-red);">"ส่งข้อมูลทาง Line สวีรู้ทันสโตรกแล้ว"</strong></li>
                    </ul>
                    <strong>2. ขณะรอรถพยาบาล</strong>
                    <ul>
                        <li>ให้นอนราบหรือเอนศีรษะสูงเล็กน้อย (15-30°)</li>
                        <li>คลายเสื้อผ้าให้หายใจสะดวก, **ห้ามกินยาหรือดื่มน้ำเด็ดขาด**</li>
                        <li>เฝ้าสังเกตอาการและการหายใจ</li>
                    </ul>
                    <strong>3. ระหว่างเดินทางและเมื่อถึงโรงพยาบาล</strong>
                    <ul>
                        <li>ไม่ควรขับรถเอง ให้รอรถพยาบาล</li>
                        <li>เตรียมข้อมูลสำคัญ: ชื่อ, ประวัติโรคประจำตัว, ยาที่ใช้</li>
                        <li>เตรียมบัตรประชาชน</li>
                    </ul>
                    <strong>4. เมื่อถึงโรงพยาบาล</strong>
                    <ul>
                        <li>รีบแจ้งแพทย์/พยาบาลว่า "สงสัยสโตรก" และบอกเวลาที่เริ่มมีอาการ</li>
                    </ul>
                </div>
                <button onclick="document.getElementById('how-to-act-modal').style.display='none'; if(liff.isInClient()){liff.closeWindow();}" class="btn-action" style="background-color:var(--primary-color);">รับทราบ</button>
            </div>
        </div>
        
        <div id="history-card" class="card hidden"></div>
    </div>

<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>
    // --- Constants & Globals ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyptTEQF-bSEVcghqYZlQdPdP9WWbxn7JDzbidpI-m6wCe23ASFET9GF6M2l5RHBaz4/exec";
    const LIFF_ID = "2005789397-WRm1lYd9";
    const REGISTRATION_LIFF_URL = "https://liff.line.me/2005789397-nebQ8oJy";
    const hospitalCoords = { lat: 10.2300226, lon: 99.1087481 };
    
    let sessionData = {};
    let countdownInterval;

    const symptomDetails = {
        'Balance': { likely: ['เดินเซรุนแรง', 'สูญเสียการทรงตัว', 'ยืน/นั่งนิ่งไม่ได้', 'เวียนหัวรุนแรงมาก'], unlikely: ['เวียนหัวពេលเปลี่ยนท่า', 'อาการน้ำในหูไม่เท่ากัน', 'เมาค้าง/พักผ่อนน้อย'] },
        'Eye': { likely: ['ตามัวหรือมองไม่เห็น', 'เห็นภาพซ้อน', 'เสียการมองเห็นครึ่งซีก'], unlikely: ['ปัญหาสายตาเดิม', 'ตาแห้ง/ระคายเคือง', 'ต้อกระจก/ต้อหิน', 'เห็นจุดดำลอยไปมา'] },
        'Face': { likely: ['หน้าเบี้ยวครึ่งซีก', 'มุมปากตกข้างหนึ่ง', 'ยิ้มแล้วปากเบี้ยว', 'หลับตาไม่สนิท', 'ชาใบหน้าครึ่งซีก'], unlikely: ['โรคใบหน้าเบี้ยว (Bell\'s Palsy)', 'บวมจากปัญหาทันตกรรม'] },
        'Arm': { likely: ['แขน/ขาอ่อนแรงซีกเดียว', 'ยกแขนได้ไม่เท่ากัน', 'ของหลุดจากมือ', 'เดินลากขา/กะเผลก'], unlikely: ['ปวด/อักเสบกล้ามเนื้อ', 'ชาจากการนอนทับ', 'หมอนรองกระดูกทับเส้น'] },
        'Speech': { likely: ['พูดไม่ชัด/ไม่เป็นคำ', 'ลิ้นแข็งเหมือนคนเมา', 'นึกคำพูดไม่ออก/ใช้คำผิด', 'ไม่เข้าใจคำพูดคนอื่น'], unlikely: ['พูดติดขัดเพราะเหนื่อย/เครียด', 'เสียงแหบ/เป็นหวัด'] }
    };

    const positiveGreetings = [
        "เยี่ยมมาก! วันนี้คุณไม่มีอาการน่าสงสัยสโตรกเลย", "ยินดีด้วย! ขอให้คุณสุขภาพดี ปลอดโรคปลอดภัย",
        "แข็งแรงดี! รักษาสุขภาพที่ดีแบบนี้ต่อไปนะครับ", "สุดยอด! ไม่พบอาการผิดปกติในวันนี้",
        "เป็นวันที่ดี! ไม่มีสัญญาณเตือนของโรคหลอดเลือดสมอง"
    ];
    const positiveEmojis = ['👍', '🎉', '💪', '✅', '😊'];

    const icons = {
        user: '<svg class="info-card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>',
        symptom: '<svg class="info-card-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>',
        clock: '<svg class="info-card-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
        hourglass: '<svg class="info-card-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-5.25-4.25-9.5-9.5-9.5S.5 6.75.5 12s4.25 9.5 9.5 9.5 9.5-4.25 9.5-9.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 1v4m0 14v4m-5-9.5a2.5 2.5 0 105 0 2.5 2.5 0 00-5 0z" /></svg>',
        map: '<svg class="info-card-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m0 0v2.25m0-2.25h3.75m-3.75 0H5.25m0 0V6.75m0 0A2.25 2.25 0 017.5 4.5h9A2.25 2.25 0 0118.75 6.75v8.5A2.25 2.25 0 0116.5 17.5H7.5A2.25 2.25 0 015.25 15.25V6.75m15 9.75l-3.75-3.75" /></svg>',
        car: '<svg class="info-card-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5h10.5a1.125 1.125 0 001.125-1.125V6.75a1.125 1.125 0 00-1.125-1.125H4.5A1.125 1.125 0 003.375 6.75v10.5a1.125 1.125 0 001.125 1.125z" /></svg>',
        ambulance: '<svg class="info-card-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>',
        contact: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.5 15.5 0 006.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57a1 1 0 011 1v3.5a1 1 0 01-1 1A17 17 0 013 4a1 1 0 011-1h3.5a1 1 0 011 1c0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>',
        pin: '<svg class="action-button-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 01.75.75v.518a24.22 24.22 0 014.232 1.346.75.75 0 11-.634 1.288 22.72 22.72 0 00-3.6-1.222V8.25a.75.75 0 01-1.5 0v-2.13a.75.75 0 011.5 0V8.25v2.336a24.195 24.195 0 01-4.232 1.346.75.75 0 01-.634-1.288 22.695 22.695 0 003.6-1.222V5.44a.75.75 0 011.5 0v.81a.75.75 0 01-1.5 0V5.44v-.922A.75.75 0 0110 2zM5.003 5.003a.75.75 0 01.75-.75h1.597a.75.75 0 010 1.5H5.75a.75.75 0 01-.75-.75zM5.75 7a.75.75 0 000 1.5h2.553a.75.75 0 000-1.5H5.75zM5.003 9.003a.75.75 0 01.75-.75h4.494a.75.75 0 010 1.5H5.75a.75.75 0 01-.75-.75zM12 5.5a.75.75 0 000 1.5h2.25a.75.75 0 000-1.5H12zM12 9.5a.75.75 0 000 1.5h5.25a.75.75 0 000-1.5H12z"/></svg>',
        phone: '<svg class="action-button-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 013.5 2h1.148a1.5 1.5 0 011.465 1.175l.716 3.1a1.5 1.5 0 01-2.24 1.664l-1.026-.44a1.25 1.25 0 00-1.285.457l-1.34 1.675a1.25 1.25 0 00.457 1.285l.44 1.026a1.5 1.5 0 01-1.664 2.24l-3.1.716A1.5 1.5 0 012 16.852V3.5zm16.5-.5a1.5 1.5 0 00-1.5 1.5v11.852a1.5 1.5 0 001.175 1.465l3.1.716a1.5 1.5 0 002.24-1.664l-.44-1.026a1.25 1.25 0 01-.457-1.285l1.34-1.675a1.25 1.25 0 01-1.285-.457l-1.026.44a1.5 1.5 0 00-1.664-2.24l.716-3.1A1.5 1.5 0 0018.5 3h-2.352z" clip-rule="evenodd" /></svg>',
        check: '<svg class="action-button-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>'
    };

    window.onload = async () => {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            
            const profile = await liff.getProfile();
            sessionData.userID = profile.userId;
            sessionData.userName = profile.displayName;
            
            fetchUserData(profile.userId);
            setupTimeOptions();

            if (!sessionStorage.getItem('disclaimerShown')) {
                document.getElementById('disclaimerModal').style.display = 'flex';
                sessionStorage.setItem('disclaimerShown', 'true');
            }
        } catch (err) { alert("ไม่สามารถเชื่อมต่อกับ LINE ได้ โปรดลองเปิดใหม่อีกครั้ง"); }
        document.getElementById('info-icon').onclick = () => { document.getElementById('disclaimerModal').style.display = 'flex'; };
    };

    function fetchUserData(userId) {
        if (!userId) return;
        const callbackName = 'userCallback' + Date.now();
        window[callbackName] = function(response) {
            const historyCard = document.getElementById('history-card');
            if (response.status === 'found' && response.data) {
                const data = response.data;
                sessionData.registeredName = data.name;
                sessionData.district = data.district;
                sessionData.village = data.village;
                historyCard.innerHTML = `
                    <h2 style="text-align: center; font-size: 1.2em;">ประเมินอาการของคุณ ${data.name || sessionData.userName}</h2>
                    <p style="font-size: 1em; text-align: center;">ประวัติความเสี่ยงสโตรก: <strong>${data.thai_cv_risk_score}% (${data.risk_group || 'N/A'})</strong></p>
                    <p style="font-size: 0.8em; text-align: center; color: #666;">ประเมินเมื่อ: ${data.timestamp ? formatFullDateTime(new Date(data.timestamp)) : 'N/A'}</p>`;

                if(sessionData.district && sessionData.village) {
                    fetchVolunteerData(`ต.${sessionData.district} ม.${sessionData.village}`);
                }
            } else {
                historyCard.innerHTML = `<p style="text-align:center;">คุณยังไม่ได้ลงทะเบียนกับแอปประเมินความเสี่ยง <a href="${REGISTRATION_LIFF_URL}">คลิกที่นี่เพื่อลงทะเบียน</a></p>`;
            }
            historyCard.classList.remove('hidden');
            delete window[callbackName];
            if(document.head.contains(scriptTag)) document.head.removeChild(scriptTag);
        };
        const url = `${GAS_URL}?action=getUserData&userId=${userId}&callback=${callbackName}`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        document.head.appendChild(scriptTag);
    }

    function fetchVolunteerData(areaKey) {
        if (!areaKey) return;
        const callbackName = 'volunteerCallback' + Date.now();
        window[callbackName] = function(response) {
            if (response.status === 'found') {
                sessionData.volunteerContacts = response.data;
            }
            delete window[callbackName];
            if(document.head.contains(scriptTag)) document.head.removeChild(scriptTag);
        };
        const url = `${GAS_URL}?action=getVolunteerData&areaKey=${encodeURIComponent(areaKey)}&callback=${callbackName}`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        document.head.appendChild(scriptTag);
    }
    
    function handleFinalSave(button, isEmergency) {
        if(button && button.disabled) return;
        if(button) button.disabled = true;
        
        sessionData.isEmergency = isEmergency;

        const callbackName = 'saveCallback' + Date.now();
        window[callbackName] = function(response) {
            if (response && response.status === 'success') {
                alert("บันทึกข้อมูลเรียบร้อยแล้ว โปรดอ่านรายละเอียดใน Line");
                if (isEmergency) {
                    document.getElementById('how-to-act-modal').style.display = 'flex';
                } else {
                    if(liff.isInClient()) liff.closeWindow();
                }
            } else {
                alert("เกิดข้อผิดพลาดในการบันทึก: " + (response ? response.message : 'Unknown error'));
                if(button) button.disabled = false;
            }
            delete window[callbackName];
            if(document.head.contains(scriptTag)) document.head.removeChild(scriptTag);
        };
        const dataStr = encodeURIComponent(JSON.stringify(sessionData));
        const url = `${GAS_URL}?action=saveData&callback=${callbackName}&data=${dataStr}`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        scriptTag.onerror = function() {
            alert("ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้");
            if(button) button.disabled = false;
            delete window[callbackName];
        };
        document.head.appendChild(scriptTag);
    }
    
    function triggerSave(buttonElement) {
        const telLink = buttonElement.closest('a');
        if (telLink) {
            const tel = telLink.href.replace('tel:', '');
            saveData('tel', tel);
        }
        handleFinalSave(buttonElement, true);
    }
    
    function saveData(key, value) { sessionData[key] = value; }
    
    function showLayer(layerId) {
        document.querySelectorAll('[data-layer]').forEach(el => el.classList.add('hidden'));
        document.getElementById(layerId).classList.remove('hidden');
    }
    
    function goBack(targetLayer) { showLayer(targetLayer); }

    function showFinalMessage(title, text) {
        saveData('symptomDetail', text);
        document.getElementById('final-title').textContent = title;
        document.getElementById('final-text').textContent = text;
        const randomEmoji = positiveEmojis[Math.floor(Math.random() * positiveEmojis.length)];
        document.getElementById('final-emoji').textContent = randomEmoji;
        showLayer('layer-6');
    }

    function createButton(container, text, className, onClick) {
        const button = document.createElement('button');
        button.textContent = text;
        button.className = className;
        button.onclick = onClick;
        container.appendChild(button);
    }

    function showLayer2(symptomKey) {
        saveData('symptomCategory', symptomKey);
        document.getElementById('layer-2-title').textContent = `อาการด้าน${symptomKey}`;
        const buttonsContainer = document.getElementById('layer-2-buttons');
        buttonsContainer.innerHTML = '';
        const details = symptomDetails[symptomKey];
        details.likely.forEach(text => createButton(buttonsContainer, text, 'btn-symptom-likely', () => handleSymptomResult(true, text)));
        details.unlikely.forEach(text => createButton(buttonsContainer, text, 'btn-symptom-unlikely', () => handleSymptomResult(false, text)));
        showLayer('layer-2');
    }

    function handleNoSymptom() {
        saveData('symptomCategory', 'ไม่มีอาการ');
        const randomGreeting = positiveGreetings[Math.floor(Math.random() * positiveGreetings.length)];
        saveData('randomGreeting', randomGreeting);
        showFinalMessage("เยี่ยมมาก!", randomGreeting);
    }

    function handleSymptomResult(isLikely, symptomDetail) {
        saveData('symptomDetail', symptomDetail);
        if (isLikely) { showLayer('layer-3'); } 
        else {
            saveData('frequency', 'อาจไม่เข้าข่ายสโตรกเฉียบพลัน');
            showFinalMessage("คำแนะนำเบื้องต้น", "อาการดังกล่าวอาจไม่ใช่อาการของสโตรกเฉียบพลัน แต่หากกังวลควรปรึกษาแพทย์");
        }
    }
    
    function handleSeveritySelection(frequencyText) { saveData('frequency', frequencyText); showLayer('layer-4'); }
    
    function handleChronicSymptom(frequencyText) {
        saveData('frequency', frequencyText);
        showFinalMessage("คำแนะนำ", "อาการที่เป็นมานานหรือเรื้อรัง ควรปรึกษาแพทย์เพื่อหาสาเหตุที่แท้จริง");
    }
    
    function handleTimeSelection(minutesAgo, isChronic = false) {
        if (isChronic) {
            saveData('onsetTime', 'เรื้อรัง/หลายวัน');
            showFinalMessage("คำแนะนำ", "เนื่องจากอาการเป็นมานานแล้ว อาจไม่ใช่ภาวะฉุกเฉินของสโตรก แต่ควรพบแพทย์เพื่อประเมิน");
            return;
        }
        const onsetTime = new Date(Date.now() - minutesAgo * 60000);
        sessionData.onsetTimeObject = onsetTime;
        saveData('onsetTime', formatFullDateTime(onsetTime));
        showLayer('layer-5');
        buildSummaryPage();
    }

    function startCountdown(deadline) {
        if (countdownInterval) clearInterval(countdownInterval);
        const timerElement = document.getElementById('countdown-timer');
        if (!timerElement) return;

        const updateTimer = () => {
            const distance = deadline - new Date().getTime();
            if (distance < 0) {
                timerElement.textContent = "ถ้าได้รับยาหลังจากนี้อาจไม่มีประสิทธิภาพแล้ว";
                timerElement.style.color = "var(--dark-red)";
                clearInterval(countdownInterval);
                return;
            }
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timerElement.textContent = `เหลือเวลาให้ยาภายใน: ${minutes} นาที ${seconds} วินาที`;
        };
        updateTimer();
        countdownInterval = setInterval(updateTimer, 1000);
    }

    function buildSummaryPage() {
        const onset = sessionData.onsetTimeObject;
        if (!onset) return;
        const arrivalDeadline = new Date(onset.getTime() + 210 * 60000); // 3.5 hours
        const rtpaDeadline = new Date(onset.getTime() + 270 * 60000); // 4.5 hours
        saveData('arrivalDeadline', formatTime(arrivalDeadline));
        saveData('rtpaDeadline', formatTime(rtpaDeadline));
        startCountdown(rtpaDeadline.getTime());
        
        let summaryHtml = createInfoCard(icons.user, 'ผู้ป่วย', sessionData.registeredName || sessionData.userName) +
                          createInfoCard(icons.symptom, 'อาการ', sessionData.symptomDetail) +
                          createInfoCard(icons.clock, 'เริ่มมีอาการเมื่อ', formatFullDateTime(onset));
                          
        document.getElementById('summary-container').innerHTML = summaryHtml;
        document.getElementById('time-details-container').innerHTML =
                          createInfoCard(icons.hourglass, 'ต้องถึง รพ. ภายใน (3.5ชม.)', formatTime(arrivalDeadline) + ' น.') +
                          createInfoCard(icons.hourglass, 'ต้องได้รับยาภายใน (4.5ชม.)', formatTime(rtpaDeadline) + ' น.');
        buildActionContainer();
    }
    
    function buildActionContainer() {
        const container = document.getElementById('action-grid-container');
        container.innerHTML = `
            <div id="location-action" class="action-button location-button" onclick="getLocation()">
                ${icons.pin}
                <p id="location-text" class="action-button-text" style="color:white;">ส่งพิกัดที่อยู่</p>
            </div>
            <div class="action-button tel-button" onclick="triggerSave(this, 'รพ.สวี')">
                <a href="tel:0894745523" style="text-decoration:none; color:white;">${icons.phone}<p class="action-button-text">โทร รพ.สวี</p></a>
            </div>
            <div class="action-button tel-button" onclick="triggerSave(this, '1669')">
                <a href="tel:1669" style="text-decoration:none; color:white;">${icons.phone}<p class="action-button-text">โทร 1669 (ฟรี)</p></a>
            </div>
        `;
    }

    function getLocation() {
        const locButton = document.getElementById('location-action');
        locButton.onclick = null;
        locButton.querySelector('.action-button-text').textContent = 'กำลังค้นหา...';
        
        navigator.geolocation.getCurrentPosition(
            position => {
                locButton.classList.add('success');
                locButton.querySelector('.action-button-icon').innerHTML = icons.check;
                locButton.querySelector('.action-button-text').textContent = 'ส่งพิกัดแล้ว';
                
                const { latitude, longitude } = position.coords;
                saveData('location', `${latitude},${longitude}`);
                const distance = getDistanceFromLatLonInKm(latitude, longitude, hospitalCoords.lat, hospitalCoords.lon);
                updateSummaryAndActions(distance);
            },
            error => {
                alert("ไม่สามารถเข้าถึงตำแหน่งได้ โปรดเปิด GPS และอนุญาตให้แอปเข้าถึงตำแหน่ง");
                locButton.onclick = getLocation;
                locButton.querySelector('.action-button-text').textContent = 'ส่งพิกัดที่อยู่';
                updateSummaryAndActions(null);
            }
        );
    }
    
    function updateSummaryAndActions(distance) {
        let summaryContainer = document.getElementById('summary-container');
        let timeDetailsContainer = document.getElementById('time-details-container');
        let contactContainer = document.getElementById('contact-buttons');
        let routeContainer = document.getElementById('route-button-container');
        let callSawiButton = document.querySelector('.action-button.tel-button'); // Assuming first red button is Sawi
        
        contactContainer.innerHTML = '';
        routeContainer.innerHTML = '';
        let extraSummaryHtml = '';

        if (distance !== null) {
            if (distance > 450) {
                extraSummaryHtml = createInfoCard(icons.map, 'ระยะทางไป รพ.สวี', 'โปรดเดินทางไป รพ.ที่ใกล้ที่สุด');
                if(callSawiButton) callSawiButton.parentElement.classList.add('hidden'); // Hide Sawi call button
                document.getElementById('action-grid-container').insertAdjacentHTML('afterend', `<p style="color:red; font-size:0.9em; text-align:center; margin-top:10px;">ระยะทางของท่านอยู่นอกเขต อ.สวี จ.ชุมพร โปรดโทร 1669</p>`);
            } else {
                const travelTimeMinutes = (distance / 40) * 60;
                const ambulanceTravelTime = travelTimeMinutes * 1.5 + 15;
                const selfTravelArrival = new Date(new Date().getTime() + travelTimeMinutes * 60000);
                const ambulanceArrival = new Date(new Date().getTime() + ambulanceTravelTime * 60000);
                const rtpaDeadline = sessionData.onsetTimeObject ? new Date(sessionData.onsetTimeObject.getTime() + 4.5 * 60 * 60000) : new Date();

                sessionData.distance = `${distance.toFixed(1)} กม.`;
                sessionData.duration = formatDuration(travelTimeMinutes);
                sessionData.selfTravelEstimate = selfTravelArrival <= rtpaDeadline ? 'ทัน' : 'อาจไม่ทัน (แต่ยังต้องรีบไปรพ.)';
                sessionData.ambulanceEstimate = ambulanceArrival <= rtpaDeadline ? 'ทัน' : 'อาจไม่ทัน (แต่ยังต้องรีบไปรพ.)';

                extraSummaryHtml += createInfoCard(icons.map, 'ระยะทางไป รพ.สวี', sessionData.distance);
                extraSummaryHtml += createInfoCard(icons.car, 'คาดการณ์เวลาเดินทาง', sessionData.duration);
                extraSummaryHtml += createInfoCard(icons.ambulance, 'คาดการณ์ (รถ รพ. ไปรับ)', sessionData.ambulanceEstimate);
                extraSummaryHtml += createInfoCard(icons.runner, 'คาดการณ์ (เดินทางมาเอง)', sessionData.selfTravelEstimate);
            }
        }
        timeDetailsContainer.insertAdjacentHTML('beforeend', extraSummaryHtml);
        
        const gmapsUrl = `https://www.google.com/maps/dir/?api=1&destination=10.2300226,99.10874816{hospitalCoords.lat},${hospitalCoords.lon}`;
        routeContainer.innerHTML = `<a href="${gmapsUrl}" target="_blank" class="contact-button route-button"><svg class="info-card-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a.75.75 0 01.75.75v.518a24.22 24.22 0 014.232 1.346.75.75 0 11-.634 1.288 22.72 22.72 0 00-3.6-1.222V8.25a.75.75 0 01-1.5 0v-2.13a.75.75 0 011.5 0V8.25v2.336a24.195 24.195 0 01-4.232 1.346.75.75 0 01-.634-1.288 22.695 22.695 0 003.6-1.222V5.44a.75.75 0 011.5 0v.81a.75.75 0 01-1.5 0V5.44v-.922A.75.75 0 0110 2zM5.003 5.003a.75.75 0 01.75-.75h1.597a.75.75 0 010 1.5H5.75a.75.75 0 01-.75-.75zM5.75 7a.75.75 0 000 1.5h2.553a.75.75 0 000-1.5H5.75zM5.003 9.003a.75.75 0 01.75-.75h4.494a.75.75 0 010 1.5H5.75a.75.75 0 01-.75-.75zM12 5.5a.75.75 0 000 1.5h2.25a.75.75 0 000-1.5H12zM12 9.5a.75.75 0 000 1.5h5.25a.75.75 0 000-1.5H12z"/></svg><span class="label">เส้นทางไป รพ.สวี</span></a>`;
        
        if (sessionData.volunteerContacts) {
            const contacts = sessionData.volunteerContacts;
            let areaInfo = (sessionData.district && sessionData.village) ? `(ต.${sessionData.district} ม.${sessionData.village})` : '';
            contactContainer.innerHTML = `<h3 style="font-size:1.1em; text-align:center; margin-top: 20px;">เบอร์โทรผู้ช่วยเหลือในพื้นที่</h3>`;
            if (contacts.volunteer1_tel) contactContainer.innerHTML += createContactButton(contacts.volunteer1_tel, "โทรหา อสม. คนที่ 1");
            if (contacts.volunteer2_tel) contactContainer.innerHTML += createContactButton(contacts.volunteer2_tel, "โทรหา อสม. คนที่ 2");
            if (contacts.headman_tel) contactContainer.innerHTML += createContactButton(contacts.headman_tel, `โทรหา ผู้นำชุมชน ${areaInfo}`);
            if (contacts.pcu_tel) contactContainer.innerHTML += createContactButton(contacts.pcu_tel, `โทรหา ${contacts.pcu_name || 'รพ.สต.'}`);
        }
    }

    function createContactButton(tel, label) {
        return `<a href="tel:${tel}" class="contact-button" onclick="triggerSave(this, '${label}')">${icons.contact} <span class="label">${label}</span></a>`;
    }

    function createInfoCard(icon, label, value) {
        const valueColor = (value && value.includes && value.includes("ไม่ทัน")) ? 'style="color:red; font-weight:bold;"' : '';
        return `<div class="info-card"><div class="info-card-icon">${icon}</div><div class="info-card-text"><p class="label">${label}</p><p class="value" ${valueColor}>${value || 'N/A'}</p></div></div>`;
    }

    function setupTimeOptions() {
        const container = document.getElementById('time-options-container');
        container.innerHTML = '';
        const now = new Date();
        const timeColors = ['#E0E0E0', '#E4DCCF', '#E8D8BF', '#ECD4AF', '#F0D19F', '#F4CD8F', '#F8C97F', '#FBC56F', '#FFC15F', '#FFBD4F', '#FFB940'];
        const timeOptions = [
            { text: `เพิ่งเกิด (${formatTime(now)})`, minutes: 0 }, { text: '10 นาที', minutes: 10 }, 
            { text: '30 นาที', minutes: 30 }, { text: '1 ชม.', minutes: 60 }, 
            { text: '2 ชม.', minutes: 120 }, { text: '3 ชม.', minutes: 180 }, 
            { text: '4 ชม.', minutes: 240 }, { text: '6 ชม.', minutes: 360 }, 
            { text: '12 ชม.', minutes: 720 }, 
            { text: '1 วันก่อน', minutes: 1440, chronic: true }, 
            { text: 'หลายวันก่อน', minutes: 0, chronic: true, yellow: true }
        ];
        timeOptions.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.textContent = opt.text;
            btn.onclick = () => handleTimeSelection(opt.minutes, opt.chronic);
            if (opt.yellow) { btn.style.backgroundColor = '#FFC107'; }
            else if (!opt.chronic) { btn.style.backgroundColor = timeColors[index] || '#E0E0E0'; }
            else { btn.classList.add("btn-severity-chronic"); }
            container.appendChild(btn);
        });
    }
    
    function formatTime(date) { return date.toTimeString().slice(0, 5); }
    
    function formatFullDateTime(date) {
        if (!date || isNaN(date)) return 'N/A';
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear() + 543;
        const hh = String(date.getHours()).padStart(2, '0');
        const mm = String(date.getMinutes()).padStart(2, '0');
        const ss = String(date.getSeconds()).padStart(2, '0');
        return `${d}/${m}/${y} ${hh}:${mm}:${ss}`;
    }

    function formatDuration(minutes) {
        if (isNaN(minutes) || minutes < 0) return 'N/A';
        const h = Math.floor(minutes / 60);
        const m = Math.round(minutes % 60);
        if (h > 0) return `${h} ชั่วโมง ${m} นาที`;
        return `${m} นาที`;
    }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
</script>
</body>
</html>