<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å (AI)</title>
    <!-- ‡πÉ‡∏ä‡πâ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <!-- Iconify -->
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

    <style>
        /* --- Design System: ‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å (Super Elderly Friendly) --- */
        :root {
            --primary-red: #ff3654;
            --alert-red: #D32F2F;
            --safe-green: #388E3C;
            --ai-yellow: #FFD700;
        }

        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            margin: 0; 
            color: #333;
            min-height: 100vh;
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏Å */
            font-size: 26px; 
            line-height: 1.4;
            background: linear-gradient(180deg, var(--primary-red) 0%, #ffffff 450px);
            background-repeat: no-repeat;
            background-attachment: fixed;
            padding-bottom: 80px; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ö‡∏î‡∏≥‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
        }
        
        .container {
            max-width: 800px;
            padding: 15px;
            margin: 0 auto;
        }

        /* --- Header --- */
        .app-header {
            text-align: center;
            margin-bottom: 15px;
            padding-top: 10px;
            white-space: nowrap;
            overflow: hidden;
        }
        h1.main-title { 
            color: #ffffff; 
            font-weight: 900; 
            font-size: 30px; /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
            margin: 0; 
            text-shadow: 2px 2px 5px rgba(0,0,0,0.3); 
            display: inline-block;
            vertical-align: middle;
        }
        .help-btn {
            font-size: 20px;
            background-color: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.8);
            color: white;
            padding: 5px 15px;
            border-radius: 50px;
            margin-left: 10px;
            cursor: pointer;
            vertical-align: middle;
            text-decoration: none;
            display: inline-block;
            font-weight: bold;
        }

        /* --- Main Card --- */
        .main-card {
            background: #ffffff; 
            border-radius: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            padding: 20px; 
            margin-bottom: 10px; 
            border: 1px solid #f0f0f0;
            overflow: visible;
        }

        /* --- Referrer Box --- */
        #referrer-display {
            display: none; 
            background-color: #e3f2fd;
            color: #0d47a1;
            border: 3px solid #90caf9;
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 20px;
            font-size: 24px;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 700;
        }

        /* --- UI Elements --- */
        .section-title { font-size: 32px; font-weight: 800; color: #333; text-align: center; margin-bottom: 15px; }
        .section-subtitle { font-size: 24px; color: #555; text-align: center; margin-bottom: 20px; }

        /* Buttons Global */
        .btn-action, button.btn-likely, button.btn-unlikely, .file-upload-btn, .contact-button, .action-button-wrapper, #btn-record, .route-button, .btn-back {
            width: 100%;
            border-radius: 50px !important;
            font-weight: 700;
            padding: 15px 20px; 
            border: none;
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
            transition: transform 0.1s;
            margin-bottom: 15px;
            font-size: 26px; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
            white-space: normal;
            word-wrap: break-word;
            cursor: pointer;
            text-decoration: none;
        }
        .btn-action:active { transform: scale(0.98); }
        .btn-primary-custom { background-color: #007BFF; color: white; }
        .btn-likely { background-color: #D32F2F; color: white; border: 3px solid #B71C1C; }
        .btn-unlikely { background-color: #388E3C; color: white; border: 3px solid #2E7D32; }
        
        /* Back Button Style (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠) */
        .btn-back { 
            background: transparent; 
            color: #007BFF; 
            border: 3px solid #007BFF; 
            width: auto; 
            min-width: 180px; 
            margin: 0 auto; 
            font-size: 24px; 
            padding: 10px 30px; 
            border-radius: 50px !important;
        }
        .btn-back-container { padding: 20px 0; border-top: 2px solid #eee; margin-top: 25px; text-align: center; }

        /* AI Button Specific (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß + Icon Wink) */
        .btn-ai { 
            background-color: var(--ai-yellow); 
            color: black; 
            border: 4px solid #F1C40F; 
            font-size: 26px; 
            position: relative; 
            overflow: visible; 
            margin-top: 10px;
            justify-content: space-between; /* ‡∏à‡∏±‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ */
            padding-left: 25px;
            padding-right: 20px;
        }
        .wink-icon-right {
            font-size: 45px; 
            color: #fff;
            text-shadow: 0 0 5px #F1C40F;
            animation: wink-slow 1.5s infinite ease-in-out;
        }
        @keyframes wink-slow { 
            0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); } 
            50% { opacity: 0.6; transform: scale(1.1) rotate(10deg); } 
        }

        /* Symptom Grid (Maximized Images) */
        .symptom-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; /* Space ‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î‡πÜ */
        }
        .symptom-card { 
            border-radius: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            text-align: center; 
            padding: 5px; /* Padding ‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡∏£‡∏π‡∏õ */
            cursor: pointer; 
            background: #fff; 
            border: 2px solid #eee; 
            transition: all 0.1s;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }
        .symptom-card:active { transform: scale(0.97); background: #f9f9f9; border-color: #007BFF; }
        .symptom-card img { 
            width: 100%; 
            height: auto; 
            aspect-ratio: 1/1; 
            object-fit: cover; 
            border-radius: 15px; 
            margin-bottom: 5px; 
        }
        .symptom-card p { 
            margin: 0; 
            font-weight: 800; 
            font-size: 32px; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î‡πÜ */
            color: #2c3e50; 
            line-height: 1.1;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%;
        }

        /* Action Grid (Telephone Page - 3 Buttons inline) */
        .action-buttons-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-top: 20px; 
        }
        .action-button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            box-shadow: none;
            padding: 0;
            margin: 0;
            border: none;
        }
        .action-button { 
            width: 100%; 
            aspect-ratio: 1/1; 
            border-radius: 20px; 
            font-size: 3.5em; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 4px solid white; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.2); 
        }
        .location-button { background-color: #007BFF; } 
        .location-button.success { background-color: #28A745; }
        .tel-sawi-button { background-color: #f39c12; }
        .tel-1669-button { background-color: #D32F2F; }
        .action-button-text { 
            font-size: 18px; 
            font-weight: bold; 
            text-align: center; 
            margin-top: 5px; 
            color: #444; 
            line-height: 1.1; 
        }

        /* Floating Buttons (Very Big) */
        .floating-actions { position: fixed; bottom: 70px; right: 15px; display: flex; flex-direction: column; gap: 15px; z-index: 4000; }
        .float-btn { 
            width: 100px; height: 100px; border-radius: 50%; color: white; 
            display: flex; align-items: center; justify-content: center; 
            flex-direction: column; box-shadow: 0 6px 20px rgba(0,0,0,0.5); 
            border: 5px solid white; cursor: pointer; text-decoration: none;
        }
        .float-1669 { background-color: #D32F2F; animation: pulse 2s infinite; }
        .float-sawi { background-color: #f39c12; }
        .float-label { font-size: 16px; margin-top: -2px; display: block; font-weight: 800; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); } 70% { box-shadow: 0 0 0 25px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }

        /* Footer Credit & Black Bar */
        .footer-credit { 
            text-align: center; color: #666; font-size: 16px; 
            margin-top: 10px; margin-bottom: 0; padding-bottom: 0;
        }
        .fixed-footer-alert {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #000; color: #fff;
            text-align: center; padding: 10px 5px;
            font-size: 20px; font-weight: bold;
            z-index: 5000; line-height: 1.2;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
        }

        /* Alert Box Layer 5 (Red blinking) */
        .alert-stroke-detected {
            background-color: #D32F2F !important; 
            color: white !important;
            border: 4px solid #B71C1C; 
            padding: 25px; 
            border-radius: 25px;
            text-align: center; 
            animation: pulse-bg 1s infinite alternate;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .alert-icon { 
            animation: blinker 0.5s infinite; 
            font-size: 80px; 
            color: #FFD700; 
            display: block; 
            margin: 0 auto 10px; 
            text-shadow: 0 0 10px rgba(255,255,0,0.5);
        }
        .blink-text { animation: blinker 1.5s linear infinite; }
        .blink-text-slow { animation: blinker 2s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.2; } }
        @keyframes pulse-bg { 
            from { background-color: #D32F2F; transform: scale(1); } 
            to { background-color: #B71C1C; transform: scale(1.02); } 
        }

        /* Time Buttons (Reduced Padding) */
        .time-btn { 
            padding: 10px 5px !important; /* ‡∏•‡∏î Space ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô */
            font-size: 22px !important; 
            min-height: 60px;
        }

        /* Others */
        .hidden { display: none !important; }
        .pdpa-box { background: #f9f9f9; padding: 25px; border-radius: 20px; border: 2px solid #ddd; font-size: 24px; margin-bottom: 25px; }
        .modal { z-index: 5000; background: rgba(0,0,0,0.8); }
        .modal-content { border-radius: 30px; border: none; padding: 30px; }
        .karaoke-text {
            background: linear-gradient(to right, #D32F2F 50%, #333 50%); background-size: 200% 100%; background-position: 100% 0;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: karaoke 3s linear infinite; font-size: 28px; font-weight: 800; display: inline-block;
        }
        @keyframes karaoke { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }

        /* Loading */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { border: 12px solid #eee; border-top: 12px solid #ff3654; border-radius: 50%; width: 120px; height: 120px; animation: spin 1s linear infinite; margin-bottom: 30px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Input Fields Big */
        .form-select, .form-control { font-size: 24px; padding: 15px; border-radius: 20px; border: 2px solid #ccc; height: auto; }
        .input-group .btn { padding: 0 30px; }
        .input-group .iconify { font-size: 30px; }
        
        /* AI Result Image with Overlay */
        .result-image-container { position: relative; width: 100%; max-width: 400px; margin: 20px auto; border-radius: 25px; overflow: hidden; box-shadow: 0 8px 15px rgba(0,0,0,0.15); border: 3px solid #eee; }
        .result-image-container img { width: 100%; display: block; }
        .grid-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(144, 238, 144, 0.4) 1px, transparent 1px), linear-gradient(90deg, rgba(144, 238, 144, 0.4) 1px, transparent 1px);
            background-size: 40px 40px; pointer-events: none;
        }
        .detection-label {
            position: absolute; top: 10px; left: 10px;
            background: rgba(40, 167, 69, 0.8); color: white;
            padding: 5px 15px; border-radius: 15px; font-size: 18px; font-weight: bold;
        }
        .result-label { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); color: white; padding: 15px; text-align: center; font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text" style="color: #ff3654; font-weight: bold; font-size: 30px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <div id="loading-subtext" style="font-size: 24px; color: #666; margin-top: 10px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
    </div>

    <!-- Floating Buttons (Extra Large) -->
    <div class="floating-actions">
        <div class="float-btn float-sawi" onclick="handleCallClick(this, 'tel_sawee', '0894745523')">
            <span class="iconify" data-icon="mdi:hospital-box"></span>
            <span class="float-label">‡∏£‡∏û.‡∏™‡∏ß‡∏µ</span>
        </div>
        <div class="float-btn float-1669" onclick="handleCallClick(this, 'tel_1669', '1669')">
            <span class="iconify" data-icon="mdi:phone-alert"></span>
            <span class="float-label" style="font-size: 20px;">1669</span>
        </div>
    </div>

    <!-- Fixed Footer Alert -->
    <div class="fixed-footer-alert">
        ‡∏´‡∏≤‡∏Å‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
    </div>

    <div class="container">
        <!-- Header -->
        <div class="app-header">
            <h1 class="main-title">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h1>
            <div id="info-btn" class="help-btn">‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô</div>
        </div>

        <!-- Main Card -->
        <div class="main-card">
            <div id="referrer-display"></div>
            <input type="hidden" id="referrerId">

            <div id="layer-container">
                <!-- Layer 1: Home -->
                <div id="layer-1" data-layer="1"></div>
                
                <!-- Other Layers -->
                <div id="layer-2" data-layer="2" class="hidden"></div>
                <div id="layer-3" data-layer="3" class="hidden"></div>
                <div id="layer-4" data-layer="4" class="hidden"></div>
                <div id="layer-5" data-layer="5" class="hidden"></div>
                <div id="layer-6" data-layer="6" class="hidden"></div>
                <div id="layer-no-symptom-review" data-layer="no-symptom-review" class="hidden"></div>

                <!-- AI Layers -->
                <div id="layer-ai-intro" data-layer="ai-intro" class="hidden"></div>
                <div id="layer-ai-input" data-layer="ai-input" class="hidden"></div>
                <div id="layer-ai-processing" data-layer="ai-processing" class="hidden"></div>
                <div id="layer-ai-result" data-layer="ai-result" class="hidden"></div>
            </div>
        </div>

        <!-- Footer Credit -->
        <div class="footer-credit">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢ "‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å" ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡∏à.‡∏ä‡∏∏‡∏°‡∏û‡∏£</div>
    </div>

    <!-- Modals -->
    <div id="disclaimerModal" class="modal" style="display:none;"></div>
    <div id="confirmLocationModal" class="modal" style="display:none;">
         <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4 text-center">
                <span class="iconify mx-auto" data-icon="mdi:map-marker-alert" style="font-size: 100px; color: #f39c12;"></span>
                <h2 style="margin-top: 20px; font-weight:800; font-size:32px;">‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏ó‡∏£</h2>
                <p style="color: #555; font-size:24px;">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÑ‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô</p>
                <div style="display: flex; flex-direction: column; gap: 20px; margin-top: 30px;">
                    <button id="modal-send-location-btn" class="btn-action btn-primary-custom" style="margin-top:0; font-size:28px;">‡∏ï‡∏Å‡∏•‡∏á (‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡πÇ‡∏ó‡∏£)</button>
                    <button class="btn-action" style="background-color: #aaa; margin-top:0; color:white; font-size:28px;" onclick="document.getElementById('confirmLocationModal').style.display='none'">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
    </div>
    <div id="aiSummaryModal" class="modal" style="display:none;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4">
                <h3 style="text-align:center; font-weight:bold; font-size:30px;">‚ú® ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå</h3>
                <textarea id="aiSummaryText" class="form-control mb-3" style="height:200px; font-size:24px;" readonly></textarea>
                <button class="btn-action" style="background-color:#28a745; color:white;" onclick="copySummary()">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                <button class="btn-action" style="background-color:#6c757d; color:white;" onclick="document.getElementById('aiSummaryModal').style.display='none'">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>
    <div id="how-to-act-modal" class="modal" style="display:none;"></div>
    <div id="image-viewer-modal" class="modal" style="background-color: rgba(0,0,0,0.95); flex-direction: column; display:none;" onclick="this.style.display='none'">
        <img id="full-image" style="max-width: 95%; max-height: 80vh; object-fit: contain; border-radius: 20px;">
        <div style="color: #ccc; margin-top: 20px; font-size: 28px; font-weight:bold;">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î</div>
        <div class="btn-back" style="color: white; border-color: white; width: auto; padding: 15px 50px; margin-top: 30px; cursor:pointer; font-size:28px;" onclick="document.getElementById('image-viewer-modal').style.display='none'">‡∏õ‡∏¥‡∏î</div>
    </div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyptTEQF-bSEVcghqYZlQdPdP9WWbxn7JDzbidpI-m6wCe23ASFET9GF6M2l5RHBaz4/exec"; 
    const LIFF_ID = "2005789397-WRm1lYd9";
    const HEALTH_INFO_LIFF_ID = "2005789397-RLAGXrBJ"; 
    const DAILY_CHECK_LIFF_ID = "2005789397-WRm1lYd9";
    
    let sessionData = {};
    let aiInputs = { face: null, arm: null, audio: null };
    let mediaRecorder;
    let audioChunks = [];
    let currentAnalysisResult = null; 
    let countdownInterval;
    let currentActionElement = null;
    let currentActionKey = '';
    let notificationSent = false;
    let pendingCallUrl = null; 

    const symptomImages = {
        'Balance': 'https://img2.pic.in.th/pic/-14a8e9c4fc269d4d8f.md.png',
        'Eye': 'https://img2.pic.in.th/pic/-16881cec753a949477.md.png',
        'Face': 'https://img5.pic.in.th/file/secure-sv1/-1846055524307466a7.md.png',
        'Arm': 'https://img2.pic.in.th/pic/-15dbb33e12115949f4.md.png',
        'Speech': 'https://img5.pic.in.th/file/secure-sv1/-179b7758ead26c6d76.md.png'
    };
    const symptomTranslations = { 'Balance': '‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß', 'Eye': '‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô', 'Face': '‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤', 'Arm': '‡πÅ‡∏Ç‡∏ô‡∏Ç‡∏≤', 'Speech': '‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î' };
    const symptomDetails = {
        'Balance': { likely: ['‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ã‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á', '‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß', '‡∏¢‡∏∑‡∏ô/‡∏ô‡∏±‡πà‡∏á‡∏ô‡∏¥‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'], unlikely: ['‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡πà‡∏≤', '‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏´‡∏π‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô'], desc: '‡∏¢‡∏∑‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏£‡∏á‡πÅ‡∏Ç‡∏ô‡πÅ‡∏ô‡∏ö‡∏•‡∏≥‡∏ï‡∏±‡∏ß 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏°‡∏µ‡πÄ‡∏ã‡∏•‡πâ‡∏°' },
        'Eye': { likely: ['‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô', '‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ã‡πâ‡∏≠‡∏ô', '‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ã‡∏µ‡∏Å'], unlikely: ['‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡πÄ‡∏î‡∏¥‡∏°', '‡∏ï‡∏≤‡πÅ‡∏´‡πâ‡∏á/‡∏£‡∏∞‡∏Ñ‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏∑‡∏≠‡∏á'], desc: '‡πÄ‡∏≠‡∏≤‡∏°‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≠‡∏á ‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î' },
        'Face': { likely: ['‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ã‡∏µ‡∏Å', '‡∏°‡∏∏‡∏°‡∏õ‡∏≤‡∏Å‡∏ï‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á', '‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏≤‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß'], unlikely: ['‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß (Bell\'s Palsy)', '‡∏ö‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ü‡∏±‡∏ô'], desc: '‡∏™‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡∏¢‡∏¥‡πâ‡∏°‡∏¢‡∏¥‡∏á‡∏ü‡∏±‡∏ô‡∏î‡∏π‡∏õ‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡∏≤ ‡∏°‡∏∏‡∏°‡∏õ‡∏≤‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏á‡∏ï‡∏≤‡∏ï‡∏Å', hasAi: true },
        'Arm': { likely: ['‡πÅ‡∏Ç‡∏ô/‡∏Ç‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á‡∏ã‡∏µ‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', '‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô', '‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠'], unlikely: ['‡∏õ‡∏ß‡∏î‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', '‡∏ä‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏ó‡∏±‡∏ö'], desc: '‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Å‡∏£‡πá‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà', hasAi: true },
        'Speech': { likely: ['‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î/‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥', '‡∏•‡∏¥‡πâ‡∏ô‡πÅ‡∏Ç‡πá‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏°‡∏≤', '‡∏ô‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å'], unlikely: ['‡∏û‡∏π‡∏î‡∏ï‡∏¥‡∏î‡∏Ç‡∏±‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢', '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏´‡∏ö/‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ß‡∏±‡∏î'], desc: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏Å‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏≤‡∏¢‡∏Å‡∏¥‡∏ô‡∏•‡∏≥‡πÑ‡∏¢‡∏ô‡πâ‡∏≥‡∏•‡∏≤‡∏¢‡∏¢‡∏≤‡∏¢‡πÑ‡∏´‡∏•‡∏¢‡πâ‡∏≠‡∏¢ ‡∏û‡∏π‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏¥‡∏î‡∏Ç‡∏±‡∏î‡∏•‡∏¥‡πâ‡∏ô‡∏û‡∏±‡∏ô‡∏Å‡∏±‡∏ô', hasAi: true }
    };
    const hospitalCoords = { lat: 10.2300226, lon: 99.1087481 };
    const randomQuotes = [
        "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡∏ö",
        "‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏µ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏™‡∏π‡πâ‡πÜ ‡∏Ñ‡∏£‡∏±‡∏ö",
        "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏£‡∏Ñ ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≤‡∏†‡∏≠‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏Ñ‡∏£‡∏±‡∏ö"
    ];

    window.handleEmergencyCall = function(tel, label) { handleCallClick(null, 'floating_call', tel); };

    window.onload = async () => {
        document.getElementById('loading').style.display = 'none'; 
        buildInitialHTML();
        buildAILayers(); 
        
        document.getElementById('how-to-act-modal').innerHTML = `<div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4"><h2 style="text-align:center; font-weight:800; font-size:32px;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Ç‡∏ì‡∏∞‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h2><div style="text-align:left; font-size:24px;"><strong>1. ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å</strong><ul><li>‡πÇ‡∏ó‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤ ‚Äú‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏™‡πÇ‡∏ï‡∏£‡∏Å‚Äù</li><li>‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢, ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å, ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</li><li>‡∏´‡∏≤‡∏Å‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤ <strong style="color: #D32F2F;">"‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á Line ‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß"</strong></li></ul><strong>2. ‡∏Ç‡∏ì‡∏∞‡∏£‡∏≠‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</strong><ul><li>‡πÉ‡∏´‡πâ‡∏ô‡∏≠‡∏ô‡∏£‡∏≤‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏≠‡∏ô‡∏®‡∏µ‡∏£‡∏©‡∏∞‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (15-30¬∞)</li><li>‡∏Ñ‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏™‡∏∞‡∏î‡∏ß‡∏Å, **‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î**</li><li>‡πÄ‡∏ù‡πâ‡∏≤‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à</li></ul><strong>3. ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</strong><ul><li>‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</li><li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ä‡∏∑‡πà‡∏≠, ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß, ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</li><li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</li></ul><strong>4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</strong><ul><li>‡∏£‡∏µ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ß‡πà‡∏≤ "‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏™‡πÇ‡∏ï‡∏£‡∏Å" ‡πÅ‡∏•‡∏∞‡∏ö‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</li></ul></div><button onclick="document.querySelector('#how-to-act-modal').style.display='none';" class="btn-action btn-primary-custom mt-3" style="font-size:28px;">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button></div></div>`;
        document.getElementById('disclaimerModal').innerHTML = `<div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4" onclick="event.stopPropagation()"><h2 style="text-align:center; font-weight:800; font-size:32px;">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡∏à.‡∏ä‡∏∏‡∏°‡∏û‡∏£</h2><p style="font-size:24px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢ <strong>‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏ß‡∏µ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ä‡∏∏‡∏°‡∏û‡∏£</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏≠.‡∏™‡∏ß‡∏µ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p><hr style="margin:15px 0;"><p style="font-size:20px; color:#555;">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ñ‡∏∂‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô</p><button onclick="document.querySelector('#disclaimerModal').style.display='none'" class="btn-action btn-primary-custom mt-3" style="font-size:28px;">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button></div></div>`;
        
        setTimeout(() => {
            const infoBtn = document.getElementById('info-btn');
            if(infoBtn) infoBtn.onclick = () => { document.querySelector('#disclaimerModal').style.display = 'block'; };
        }, 500);
        
        document.getElementById('modal-send-location-btn').onclick = () => { 
            document.getElementById('confirmLocationModal').style.display = 'none'; 
            getLocation(false, true, () => {
                if (currentActionKey === '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î') handleFinalSave(currentActionElement, true);
                else executePendingCall();
            }); 
        };

        checkReferrerDisplay();

        try {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                sessionData.userID = profile.userId;
                sessionData.userName = profile.displayName;
                fetchUserData(profile.userId); 
                logReferrerAction(profile.userId); 
            } else { liff.login(); }
        } catch (e) { console.log(e); }
    };

    function checkReferrerDisplay() {
        const urlParams = new URLSearchParams(window.location.search);
        const refId = urlParams.get('ref');
        if (refId) {
            $('#referrerId').val(refId);
            $.getJSON(GAS_URL, { action: 'getReferrerName', refId: refId }, function(res) {
                if (res.success && res.name) {
                    $('#referrer-display').html(`ü§ù ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢: <b>‡∏Ñ‡∏∏‡∏ì${res.name}</b>`).css('display', 'flex');
                }
            });
        }
    }

    function logReferrerAction(viewerId) {
        const urlParams = new URLSearchParams(window.location.search);
        const refId = urlParams.get('ref');
        if (refId) $.getJSON(GAS_URL, { action: 'logVhvShare', refId: refId, page: 'aware', viewerId: viewerId });
    }

    // --- MAIN FLOW ---
    function buildInitialHTML() {
        document.getElementById('layer-1').innerHTML = `
            <div class="assessor-row d-flex align-items-center justify-content-between mb-4">
                <p class="m-0 fw-bold" style="font-size:26px;">‡∏ó‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£</p>
                <select id="assessor-select" class="form-select w-auto rounded-pill fw-bold" onchange="handleAssessorChange(this)">
                    <option value="myself">‡∏ï‡∏±‡∏ß‡∏â‡∏±‡∏ô‡πÄ‡∏≠‡∏á</option>
                    <option value="others">‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô</option>
                </select>
            </div>

            <div id="patient-phone-wrapper" style="display:none;" class="mb-4">
                <div class="input-group">
                    <input type="tel" id="patient-phone" class="form-control rounded-start-pill fw-bold" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥(‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" maxlength="10" inputmode="numeric">
                    <button class="btn btn-primary rounded-end-pill" onclick="triggerSearch()"><span class="iconify" data-icon="mdi:magnify"></span></button>
                </div>
            </div>

            <div id="user-info-bar" class="alert alert-light border d-flex flex-wrap justify-content-between align-items-center p-3 mb-4" style="display:none; font-size:22px; border-width:2px; border-color:#ddd;">
                <div class="w-100 mb-2"><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="ui-name" class="text-primary">-</span></div>
                <div><strong>‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á:</strong> <span id="ui-risk">-</span></div>
                <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="ui-date">-</span></div>
            </div>
            
            <button class="btn-action btn-ai mb-4" onclick="handleAiTest()">
                <span>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ AI</span>
                <span class="iconify wink-icon-right" data-icon="mdi:sparkles"></span>
            </button>

            <div class="symptom-grid">
                <div class="symptom-card" onclick="showLayer2('Balance')"><img src="${symptomImages.Balance}"><p>‡πÄ‡∏ã/‡∏°‡∏∂‡∏ô‡∏´‡∏±‡∏ß</p></div>
                <div class="symptom-card" onclick="showLayer2('Eye')"><img src="${symptomImages.Eye}"><p>‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏°‡∏≤‡∏Å</p></div>
                <div class="symptom-card" onclick="showLayer2('Face')"><img src="${symptomImages.Face}"><p>‡∏°‡∏∏‡∏°‡∏õ‡∏≤‡∏Å‡∏ï‡∏Å</p></div>
                <div class="symptom-card" onclick="showLayer2('Arm')"><img src="${symptomImages.Arm}"><p>‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô‡∏¢‡∏≤‡∏Å</p></div>
                <div class="symptom-card" onclick="showLayer2('Speech')"><img src="${symptomImages.Speech}"><p>‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏û‡∏π‡∏î</p></div>
                <div style="min-height: 160px;"></div>
            </div>
        `;
        
        document.getElementById('layer-2').innerHTML = `
            <h2 id="layer-2-title" class="section-title"></h2>
            <div id="layer-2-new-content"></div>
            <hr class="my-4">
            <p id="layer-2-subtitle" class="section-subtitle">‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
            <div id="layer-2-buttons" class="d-flex flex-wrap gap-3 justify-content-center"></div>
            <div class="btn-back-container"><button class="btn-back" onclick="showLayer('layer-1')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button></div>
        `;

        document.getElementById('layer-3').innerHTML = `
            <h2 class="section-title">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</h2>
            <div class="d-flex flex-column gap-3">
                <button class="btn-likely" onclick="handleSeveritySelection('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô')">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô</button>
                <button class="btn-action" style="background-color: #E67E22; color: white;" onclick="handleChronicSymptom('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á/‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏õ‡πá‡∏ô')">‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô/‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ‡πÄ‡∏õ‡πá‡∏ô</button>
            </div>
            <div class="btn-back-container"><button class="btn-back" onclick="showLayer('layer-2')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button></div>
        `;

        document.getElementById('layer-4').innerHTML = `
            <h2 class="section-title">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà?</h2>
            <p class="section-subtitle">‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
            <div id="time-options-container" class="d-flex flex-wrap gap-3 justify-content-center"></div>
            <div class="btn-back-container"><button class="btn-back" onclick="showLayer('layer-3')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button></div>
        `;

        document.getElementById('layer-5').innerHTML = `
            <div class="alert-stroke-detected mb-4">
                <span class="iconify alert-icon" data-icon="mdi:alarm-light"></span>
                <p class="mb-2 fs-3">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢</p>
                <p class="fw-bold" style="font-size: 36px; line-height:1.1;">‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</p>
                <p class="fw-bold fs-3 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å‡∏´‡∏≤ ‡∏£‡∏û.‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</p>
                <div id="countdown-timer" class="fw-bold text-white mt-3 fs-3 border-top pt-2"></div>
            </div>
            
            <div id="action-grid-container" class="action-buttons-grid"></div>
            <table id="summary-table" class="table table-borderless mt-4 fs-4"></table>
            <div id="contact-buttons" class="mt-4"></div>
            <div id="route-button-container" class="mt-4"></div>
            
            <button class="btn-action" style="background-color: #C0392B; color: white; margin-top:30px; font-size:30px;" onclick="handleFinalSave(this, true)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            <div class="btn-back-container"><button class="btn-back" onclick="showLayer('layer-4')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button></div>
        `;

        document.getElementById('layer-6').innerHTML = `
            <div id="final-emoji" style="text-align:center; font-size: 100px; margin-bottom: 20px;"></div>
            <h2 id="final-title" class="section-title" style="font-size:36px;"></h2>
            <p id="final-text" class="text-center" style="font-size:28px;"></p>
            <div class="d-flex flex-column gap-3 mt-4">
                <button class="btn-action btn-primary-custom" style="padding: 25px; font-size:30px;" onclick="handleFinalSave(this, false)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î</button>
                <button class="btn-action" style="background-color: #666; color: white; padding: 20px; font-size:24px;" onclick="handleTestClose()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á (‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö)</button>
            </div>
        `;
        
        document.getElementById('layer-no-symptom-review').innerHTML = `<div id="no-symptom-content"></div>`;

        setupTimeOptions();
    }

    function buildAILayers() {
        document.getElementById('layer-ai-intro').innerHTML = `
            <h2 class="section-title"><span class="iconify" data-icon="mdi:brain"></span> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ AI</h2>
            <p class="text-muted fs-4 mb-4 text-start">‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô <strong>‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Ñ‡∏ß‡∏£‡∏£‡∏µ‡∏ö‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå</strong></p>
            <div class="pdpa-box">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="pdpa-consent" style="transform: scale(2); margin-right: 20px;">
                    <label class="form-check-label fs-4" for="pdpa-consent">‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</label>
                </div>
            </div>
            <button class="btn-action btn-primary-custom" style="font-size:30px;" onclick="startAiTestFlow()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
            <div class="btn-back-container"><button class="btn-back" onclick="showLayer('layer-1')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button></div>
        `;

        document.getElementById('layer-ai-input').innerHTML = `
            <h2 class="section-title">‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
            
            <div class="card p-4 mb-4 border shadow-sm">
                <h5 class="fw-bold fs-3">1. ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Face)</h5>
                <div class="d-flex gap-3 align-items-start">
                    <img src="https://img2.pic.in.th/pic/-19b938acd92f7035f5.png" class="rounded border" style="width:120px; height:120px; object-fit:cover;" onclick="viewImage(this.src)">
                    <div class="flex-grow-1">
                        <small class="text-muted d-block mb-3 fs-4">‡∏ñ‡∏≠‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å ‡∏¢‡∏¥‡πâ‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ü‡∏±‡∏ô ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</small>
                        <div style="position:relative; overflow:hidden;">
                            <div class="file-upload-btn btn-primary-custom"><span class="iconify" data-icon="mdi:camera"></span> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
                            <input type="file" accept="image/*" capture="user" onchange="handleImageInput(this, 'face')" style="position:absolute; top:0; left:0; opacity:0; width:100%; height:100%; cursor:pointer;">
                        </div>
                    </div>
                </div>
                <img id="preview-face" class="w-100 mt-3 rounded" style="display:none;">
            </div>

            <div class="card p-4 mb-4 border shadow-sm">
                <h5 class="fw-bold fs-3">2. ‡πÅ‡∏Ç‡∏ô (Arm)</h5>
                <div class="d-flex gap-3 align-items-start">
                    <img src="https://img5.pic.in.th/file/secure-sv1/-20d4026a1d1efbfe8e.png" class="rounded border" style="width:120px; height:120px; object-fit:cover;" onclick="viewImage(this.src)">
                    <div class="flex-grow-1">
                        <small class="text-muted d-block mb-3 fs-4">‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô 2 ‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏´‡∏•‡πà ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</small>
                        <div style="position:relative; overflow:hidden;">
                            <div class="file-upload-btn btn-primary-custom"><span class="iconify" data-icon="mdi:camera"></span> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
                            <input type="file" accept="image/*" capture="environment" onchange="handleImageInput(this, 'arm')" style="position:absolute; top:0; left:0; opacity:0; width:100%; height:100%; cursor:pointer;">
                        </div>
                    </div>
                </div>
                <img id="preview-arm" class="w-100 mt-3 rounded" style="display:none;">
            </div>

            <div class="card p-4 mb-4 border shadow-sm">
                <h5 class="fw-bold fs-3">3. ‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Speech)</h5>
                <p class="text-center mb-3 fs-4">‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤: <span class="karaoke-text">"‡∏¢‡∏≤‡∏¢‡∏Å‡∏¥‡∏ô‡∏•‡∏≥‡πÑ‡∏¢ ‡∏ô‡πâ‡∏≥‡∏•‡∏≤‡∏¢‡∏¢‡∏≤‡∏¢‡πÑ‡∏´‡∏•‡∏¢‡πâ‡∏≠‡∏¢"</span></p>
                <button id="btn-record" class="btn-action" style="background:#d9534f; color:white;" onclick="toggleRecording()"><span class="iconify" data-icon="mdi:microphone"></span> ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
                <div id="audio-controls-container" style="display:none;" class="mt-3 text-center">
                    <audio id="audio-playback" controls class="w-100" style="height:50px;"></audio>
                    <small class="text-success fw-bold fs-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß</small>
                </div>
            </div>

            <p class="text-center text-danger fw-bold mt-3 fs-4">* ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á *</p>
            <button class="btn-action btn-ai" style="font-size:30px;" onclick="analyzeWithGemini()">
                <span>‡∏™‡πà‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
                <span class="iconify wink-icon-right" data-icon="mdi:sparkles"></span>
            </button>
            <div class="btn-back-container"><button class="btn-back" onclick="showLayer('layer-ai-intro')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button></div>
        `;

        document.getElementById('layer-ai-processing').innerHTML = `<div class="text-center py-5"><div class="spinner mx-auto mb-4"></div><h2 style="font-size:32px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</h2><p class="text-muted fs-3">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤<br>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ç‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p></div>`;
        document.getElementById('layer-ai-result').innerHTML = `<div id="ai-result-content"></div>`;
    }

    // --- LOGIC FUNCTIONS ---
    window.handleAssessorChange = function(select) {
        const phoneWrapper = document.getElementById('patient-phone-wrapper');
        const phoneInput = document.getElementById('patient-phone');
        if (select.value === 'others') { phoneWrapper.style.display = 'block'; phoneInput.value = ''; } 
        else { phoneWrapper.style.display = 'none'; fetchUserData(sessionData.userID); }
    };
    window.triggerSearch = function() {
        const input = document.getElementById('patient-phone');
        const phone = input.value.replace(/[^0-9]/g, '');
        if (phone.length === 10) fetchUserDataByPhone(phone);
        else { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 10 ‡∏´‡∏•‡∏±‡∏Å"); input.focus(); }
    };
    window.fetchUserDataByPhone = function(phone) { const url = `${GAS_URL}?action=getUserDataByPhone&phone=${phone}&callback=processUserData`; const scriptTag = document.createElement('script'); scriptTag.src = url; document.head.appendChild(scriptTag); };

    window.showLayer2 = function(symptomKey) {
        saveData('symptomCategory', symptomKey);
        document.getElementById('layer-2-title').textContent = `‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô${symptomTranslations[symptomKey]}`;
        const newContent = document.getElementById('layer-2-new-content');
        const buttons = document.getElementById('layer-2-buttons');
        newContent.innerHTML = ''; buttons.innerHTML = '';
        
        let newHtml = `<div class="text-center mb-4"><img src="${symptomImages[symptomKey]}" class="rounded shadow-sm" style="max-width:300px; width:100%; border-radius:20px;" onclick="viewImage('${symptomImages[symptomKey]}')"><div class="small text-muted mt-2 fs-4">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div></div>`;
        const detail = symptomDetails[symptomKey];
        if (detail.desc) newHtml += `<div class="alert alert-info border-0 border-start border-5 border-info bg-light text-start p-4 mb-4" style="background:#f0faff;"><strong class="fs-4">‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï:</strong> <span class="fs-4">${detail.desc}</span></div>`;
        if (detail.hasAi) newHtml += `<button onclick="handleAiTest()" class="btn-action btn-ai mb-4"><span>‡πÉ‡∏ä‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</span><span class="iconify wink-icon-right" data-icon="mdi:sparkles"></span></button>`;
        newHtml += `<div class="d-flex flex-column gap-3 mb-4 w-100"><button class="btn-likely" style="font-size:28px;" onclick="handleSymptomResult(true, '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢')">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢</button><button class="btn-unlikely" style="font-size:28px;" onclick="handleSymptomResult(false, '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢')">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢</button></div>`;
        newContent.innerHTML = newHtml;
        
        detail.likely.forEach(text => buttons.innerHTML += `<button class="btn-likely" style="font-size:24px;" onclick="handleSymptomResult(true, '${text}')">${text}</button>`);
        detail.unlikely.forEach(text => buttons.innerHTML += `<button class="btn-unlikely" style="font-size:24px;" onclick="handleSymptomResult(false, '${text}')">${text}</button>`);
        showLayer('layer-2');
    };

    window.handleSymptomResult = function(isLikely, symptomDetail, symptomCategory = null) {
        if (symptomCategory) saveData('symptomCategory', symptomCategory);
        saveData('symptomDetail', symptomDetail);
        if (isLikely) showLayer('layer-3'); 
        else { saveData('frequency', '‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô'); showFinalMessage("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô", "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏Å‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå"); }
    };
    window.handleSeveritySelection = function(txt) { saveData('frequency', txt); showLayer('layer-4'); };
    window.handleChronicSymptom = function(txt) { saveData('frequency', txt); showFinalMessage("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥", "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á"); };
    window.handleTimeSelection = function(min, isChronic) {
        if (isChronic) { saveData('onsetTime', '‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á/‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô'); showFinalMessage("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥", "‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏†‡∏≤‡∏ß‡∏∞‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô"); return; }
        const onset = new Date(Date.now() - min * 60000);
        sessionData.onsetTimeObject = onset;
        saveData('onsetTime', formatFullDateTime(onset));
        showLayer('layer-5');
        buildSummaryPage();
    };

    function setupTimeOptions() {
        const container = document.getElementById('time-options-container');
        if (!container) return;
        container.innerHTML = '';
        const now = new Date();
        const options = [{text:`‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏Å‡∏¥‡∏î (${formatTime(now)})`,min:0},{text:'10 ‡∏ô‡∏≤‡∏ó‡∏µ',min:10},{text:'30 ‡∏ô‡∏≤‡∏ó‡∏µ',min:30},{text:'1 ‡∏ä‡∏°.',min:60},{text:'2 ‡∏ä‡∏°.',min:120},{text:'3 ‡∏ä‡∏°.',min:180},{text:'4 ‡∏ä‡∏°.',min:240},{text:'6 ‡∏ä‡∏°.',min:360},{text:'12 ‡∏ä‡∏°.',min:720},{text:'1 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô',min:1440,chronic:true},{text:'‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô',min:0,chronic:true,final:true}];
        options.forEach(opt => {
            let style = 'background-color: #f8f9fa; border: 3px solid #dee2e6; color: #333;';
            if(opt.final) style = 'background-color: #e9ecef; color: #666;';
            else if(opt.chronic) style = 'background-color: #E67E22; color: white; border-color:#E67E22;';
            container.innerHTML += `<button class="btn-action time-btn" style="${style} width: calc(33% - 15px); display:inline-block;" onclick="handleTimeSelection(${opt.min}, ${opt.chronic})">${opt.text}</button>`;
        });
    }

    function buildSummaryPage() {
        if (!sessionData.eventId) sessionData.eventId = sessionData.userID + '-' + Date.now();
        const onset = sessionData.onsetTimeObject;
        if (!onset) return;
        const deadline = new Date(onset.getTime() + 4.5 * 60 * 60 * 1000);
        sessionData.arrivalDeadline = formatTime(new Date(onset.getTime() + 3.5 * 60 * 60 * 1000));
        sessionData.rtpaDeadline = formatTime(deadline);
        startCountdown(deadline.getTime());
        
        document.getElementById('summary-table').innerHTML = `<tbody>` + 
            createTableRow('mdi:account-circle', '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢', sessionData.registeredName || sessionData.userName) +
            createTableRow('mdi:account-heart-outline', '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£', sessionData.symptomDetail) +
            createTableRow('mdi:clock-time-three-outline', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô', formatFullDateTime(onset)) +
            createTableRow('mdi:timer-sand', '‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á ‡∏£‡∏û. (3.5‡∏ä‡∏°.)', sessionData.arrivalDeadline + ' ‡∏ô.') +
            createTableRow('mdi:timer-sand', '‡∏¢‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (4.5‡∏ä‡∏°.)', `<span class="text-warning fw-bold">${sessionData.rtpaDeadline} ‡∏ô.</span>`) + `</tbody>`;
        
        buildActionContainer();
        if(sessionData.location) {
             const btn = document.getElementById('location-action'); const txt = document.getElementById('location-text');
             if (btn) { btn.classList.add('success'); btn.innerHTML = `<span class="iconify" data-icon="mdi:check-circle"></span>`; if(txt) txt.textContent = '‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß'; }
             const c = sessionData.location.split(',');
             if(c.length === 2) updateSummaryAndActions(getDistanceFromLatLonInKm(parseFloat(c[0]), parseFloat(c[1]), hospitalCoords.lat, hospitalCoords.lon));
        } else updateSummaryAndActions(null);
    }

    function startCountdown(deadline) {
        if (countdownInterval) clearInterval(countdownInterval);
        const timer = document.getElementById('countdown-timer');
        const update = () => {
            const dist = deadline - new Date().getTime();
            if (dist < 0) { timer.textContent = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß"; timer.style.color = "#FFCDD2"; clearInterval(countdownInterval); return; }
            const h = Math.floor(dist / 3600000); const m = Math.floor((dist % 3600000) / 60000);
            timer.textContent = `‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ${h} ‡∏ä‡∏°. ${String(m).padStart(2, '0')} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        };
        update(); countdownInterval = setInterval(update, 1000);
    }

    function updateSummaryAndActions(dist) {
        const table = document.getElementById('summary-table').getElementsByTagName('tbody')[0];
        document.querySelectorAll('.distance-row').forEach(r => r.remove());
        const contacts = document.getElementById('contact-buttons'); contacts.innerHTML = '';
        const routes = document.getElementById('route-button-container'); routes.innerHTML = '';
        
        if (dist !== null) {
            let html = ''; const sawiBtn = document.querySelector('.tel-sawi-button')?.parentElement;
            if (dist > 450) {
                html += createTableRow('mdi:alert-circle-outline', '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á', '‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', true, 'distance-row text-warning');
                if (sawiBtn) sawiBtn.style.display = 'none';
            } else {
                if (sawiBtn) sawiBtn.style.display = 'flex';
                const travelMins = (dist / 40) * 60;
                const ambMins = travelMins * 1.5 + 15;
                const deadline = sessionData.onsetTimeObject ? new Date(sessionData.onsetTimeObject.getTime() + 4.5 * 3600000) : new Date();
                sessionData.distance = `${dist.toFixed(1)} ‡∏Å‡∏°.`;
                html += createTableRow('mdi:map-marker-distance', '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á', sessionData.distance, false, 'distance-row');
                html += createTableRow('mdi:car-clock', '‡πÑ‡∏õ‡πÄ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á', `${formatTime(new Date(Date.now() + travelMins * 60000))} ‡∏ô.`, false, 'distance-row');
                html += createTableRow('mdi:ambulance', '‡∏£‡∏ñ ‡∏£‡∏û. ‡∏ñ‡∏∂‡∏á', `${formatTime(new Date(Date.now() + ambMins * 60000))} ‡∏ô.`, false, 'distance-row');
                routes.innerHTML = `<a href="https://www.google.com/maps/dir/?api=1&destination=${hospitalCoords.lat},${hospitalCoords.lon}" target="_blank" class="contact-button route-button text-white" style="background-color:#17a2b8;"><span class="iconify" data-icon="mdi:directions"></span> ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</a>`;
            }
            table.insertAdjacentHTML('beforeend', html);
        }
        if (sessionData.volunteerContacts) {
            const c = sessionData.volunteerContacts;
            contacts.innerHTML = `<h5 style="text-align:center; margin-top:30px; font-weight:bold; font-size:28px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</h5>`;
            if (c.volunteer1_tel) contacts.innerHTML += createContactButton(c.volunteer1_tel, "‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ‡∏≠‡∏™‡∏°. 1", "tel_asm1");
            if (c.volunteer2_tel) contacts.innerHTML += createContactButton(c.volunteer2_tel, "‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ‡∏≠‡∏™‡∏°. 2", "tel_asm2");
            if (c.headman_tel) contacts.innerHTML += createContactButton(c.headman_tel, `‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ä‡∏∏‡∏°‡∏ä‡∏ô`, "tel_header");
            if (c.pcu_tel) contacts.innerHTML += createContactButton(c.pcu_tel, `‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ${c.pcu_name || '‡∏£‡∏û.‡∏™‡∏ï.'}`, "tel_pcu");
        }
    }

    function createContactButton(tel, label, key) { return `<div class="contact-button btn-primary-custom" onclick="handleCallClick(this, '${key}', '${tel}')"><span class="iconify" data-icon="mdi:phone"></span><span>${label}</span></div>`; }
    function createTableRow(icon, label, val, urgent, cls='') { return `<tr class="${cls}"><td><span class="iconify fs-2" data-icon="${icon}"></span></td><td>${label}</td><td class="${urgent?'text-warning fw-bold':'fw-bold'}">${val||'N/A'}</td></tr>`; }
    function buildActionContainer() {
        document.getElementById('action-grid-container').innerHTML = `
            <div class="action-button-wrapper"><div id="location-action" class="action-button location-button" onclick="getLocation(false, false)"><span class="iconify" data-icon="mdi:map-marker"></span></div><p class="action-button-text" id="location-text">‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</p></div>
            <div class="action-button-wrapper" onclick="handleCallClick(this, 'tel_sawee', '0894745523')"><div class="action-button tel-sawi-button"><span class="iconify" data-icon="mdi:phone"></span></div><p class="action-button-text">‡πÇ‡∏ó‡∏£ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</p></div>
            <div class="action-button-wrapper" onclick="handleCallClick(this, 'tel_1669', '1669')"><div class="action-button tel-1669-button"><span class="iconify" data-icon="mdi:phone"></span></div><p class="action-button-text">‡πÇ‡∏ó‡∏£ 1669</p></div>`;
    }

    // --- AI ---
    function showAiError(msg) { document.getElementById('layer-ai-processing').innerHTML = `<div class="text-center py-5"><span class="iconify" data-icon="mdi:robot-confused" style="font-size: 100px; color: #999;"></span><h3 class="mt-4" style="font-size:32px;">AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</h3><p class="text-muted fs-3">${msg}</p><div class="d-flex flex-column gap-3 mt-4"><button class="btn-action btn-ai" onclick="showLayer('layer-ai-input')">‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button><button class="btn-action btn-primary-custom" onclick="analyzeWithGemini()">‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button></div></div>`; }
    window.handleAiTest = function() { showLayer('layer-ai-intro'); };
    window.startAiTestFlow = function() { if (!document.getElementById('pdpa-consent').checked) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç"); return; } showLayer('layer-ai-input'); };
    window.handleImageInput = function(input, type) { if (input.files[0]) { const r = new FileReader(); r.onload = e => { const img = new Image(); img.onload = () => { const c = document.createElement('canvas'); const w = img.width > 800 ? 800 : img.width; const h = img.height * (w/img.width); c.width = w; c.height = h; c.getContext('2d').drawImage(img, 0, 0, w, h); const d = c.toDataURL('image/jpeg', 0.7); aiInputs[type] = d.split(',')[1]; document.getElementById(`preview-${type}`).src = d; document.getElementById(`preview-${type}`).style.display = 'block'; }; img.src = e.target.result; }; r.readAsDataURL(input.files[0]); } };
    window.toggleRecording = function() {
        const btn = document.getElementById('btn-record');
        if (btn.innerText.includes("‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á")) {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
                mediaRecorder = new MediaRecorder(s); mediaRecorder.start(); audioChunks = [];
                btn.innerHTML = '<span class="iconify" data-icon="mdi:stop"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.style.backgroundColor = "#333";
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' }); document.getElementById('audio-playback').src = URL.createObjectURL(blob); document.getElementById('audio-controls-container').style.display = 'block';
                    const r = new FileReader(); r.readAsDataURL(blob); r.onloadend = () => { aiInputs.audio = r.result.split(',')[1]; };
                    btn.innerHTML = '<span class="iconify" data-icon="mdi:check"></span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß'; btn.style.backgroundColor = "#28a745";
                };
                setTimeout(() => { if (mediaRecorder.state === "recording") mediaRecorder.stop(); }, 10000);
            });
        } else { if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop(); }
    };
    window.analyzeWithGemini = function() {
        if (!aiInputs.face && !aiInputs.arm && !aiInputs.audio) { alert("‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á"); return; }
        showLayer('layer-ai-processing');
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'analyzeStroke', faceImage: aiInputs.face, armImage: aiInputs.arm, speechAudio: aiInputs.audio, userData: { risk_group: sessionData.risk_group, score: sessionData.thai_cv_risk_score, userId: sessionData.userID, name: sessionData.registeredName } }) })
        .then(res => res.json()).then(data => { 
            if (data.status === 'success') { currentAnalysisResult = data.data; if (data.data.fileUrls) { sessionData.fileUrls = data.data.fileUrls; sessionData.isAiAssessment = true; } sessionData.riskScore = data.data.riskScore; sessionData.analysis = data.data.analysis; displayAiResult(data.data); } 
            else showAiError(data.message); 
        }).catch(err => showAiError("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"));
    };
    function displayAiResult(res) {
        const c = document.getElementById('ai-result-content');
        if (!res.isValid) c.innerHTML = `<div class="text-center"><h3 class="text-warning fw-bold fs-2">‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</h3><p>${res.refusalReason}</p><button class="btn-action btn-secondary" onclick="showLayer('layer-ai-input')">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button></div>`;
        else {
            let html = `<h3 class="text-center fw-bold fs-2 ${res.isRisk?'text-danger':'text-success'}">${res.isRisk ? `üö® ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á (${res.riskScore}%)` : '‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô'}</h3><div class="bg-light p-3 rounded mb-3 text-start border fs-5"><strong>‡∏ú‡∏•:</strong><p>${res.analysis}</p></div>`;
            html += `<h5 class="mt-4 fw-bold text-center fs-4">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h5>`;
            
            // Image Containers with Overlays
            if (aiInputs.face) html += `<div class="result-image-container"><img src="data:image/jpeg;base64,${aiInputs.face}"><div class="grid-overlay"></div><div class="detection-label">Face detection</div></div>`;
            if (aiInputs.arm) html += `<div class="result-image-container"><img src="data:image/jpeg;base64,${aiInputs.arm}"><div class="grid-overlay"></div><div class="detection-label">Arm detection</div></div>`;
            
            html += `<button class="btn-action btn-info text-white mt-4" onclick="requestSummary()">‚ú® ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡πà‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</button>`;
            if(res.isRisk) html += `<button class="btn-action btn-danger mt-3" onclick="saveData('symptomDetail', 'AI: '+ '${res.analysis}'); showLayer('layer-3');">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô</button>`;
            else html += `<button class="btn-action btn-primary-custom mt-3" onclick="saveData('symptomDetail', 'AI: Low Risk'); saveData('isFinalSave', true); handleFinalSave(this, false);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏à‡∏ö</button>`;
            html += `<div class="btn-back-container"><button class="btn-back" onclick="showLayer('layer-ai-input')">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></div>`;
            c.innerHTML = html;
        }
        showLayer('layer-ai-result');
    }
    window.requestSummary = function() { if(!currentAnalysisResult)return; fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'generateSummary', data: currentAnalysisResult }) }).then(r=>r.json()).then(d=>{ if(d.status==='success'){ document.getElementById('aiSummaryText').value = d.summary; document.getElementById('aiSummaryModal').style.display='block'; } else alert("Error"); }); };
    window.copySummary = function() { document.getElementById("aiSummaryText").select(); document.execCommand("copy"); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß"); };

    // --- SAVE & FLEX ---
    function createFlexMessage(data) {
        // --- 1. Determine State ---
        const isAbnormal = data.isEmergency || (data.isAiAssessment && data.riskScore > 50);
        const isAI = !!data.isAiAssessment;
        
        // Base Setup
        let headerColor = isAbnormal ? "#D32F2F" : "#28A745"; // Red vs Green
        let title = isAbnormal ? "‚ÄºÔ∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ‚ÄºÔ∏è" : "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: ‡∏õ‡∏Å‡∏ï‡∏¥";
        if (isAbnormal && !data.isEmergency) title = "‚ö†Ô∏è ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (AI)"; // AI Risk but not manual emergency yet
        
        // --- 2. Build Body ---
        let bodyContents = [];
        
        // Image Section (AI Only) - Show 1 or 2 images
        if (isAI && data.fileUrls) {
            let images = [];
            if (data.fileUrls.face) images.push(data.fileUrls.face);
            if (data.fileUrls.arm) images.push(data.fileUrls.arm);
            
            if (images.length > 0) {
                let imageBox = { type: "box", layout: "horizontal", contents: [] };
                images.forEach(url => {
                    imageBox.contents.push({ 
                        type: "image", url: url, size: "full", aspectRatio: "1:1", aspectMode: "cover", flex: 1, margin: "sm",
                        action: { type: "uri", uri: url }
                    });
                });
                bodyContents.push(imageBox);
                bodyContents.push({ type: "separator", margin: "md" });
            }
        }

        // Info Section
        bodyContents.push({
            type: "box", layout: "vertical", margin: "md",
            contents: [
                { type: "text", text: "üë§ ‡∏ä‡∏∑‡πà‡∏≠: " + String(data.registeredName || data.userName || "-"), weight: "bold", size: "lg", wrap: true },
                { type: "text", text: "üìÖ " + formatFullDateTime(new Date()), size: "sm", color: "#666666" }
            ]
        });

        // Analysis / Symptom Text
        let symptomText = isAI ? `AI: ${data.analysis || '-'}` : (data.symptomDetail || "‡∏õ‡∏Å‡∏ï‡∏¥");
        if (!isAbnormal) symptomText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô";
        
        bodyContents.push({
            type: "box", layout: "vertical", margin: "md", backgroundColor: isAbnormal ? "#FFEBEE" : "#E8F5E9", cornerRadius: "md", paddingAll: "md",
            contents: [
                { type: "text", text: isAbnormal ? "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö:" : "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:", weight: "bold", size: "sm", color: isAbnormal ? "#D32F2F" : "#2E7D32" },
                { type: "text", text: symptomText, wrap: true, size: "md", color: "#333333", margin: "sm" }
            ]
        });

        // Random Quote for Normal Cases
        if (!isAbnormal) {
            const randomQuote = randomQuotes[Math.floor(Math.random() * randomQuotes.length)];
            bodyContents.push({ type: "separator", margin: "lg" });
            bodyContents.push({ 
                type: "text", text: `"${randomQuote}"`, 
                style: "italic", size: "sm", color: "#888888", align: "center", margin: "md", wrap: true 
            });
        }

        // --- 3. Build Footer Buttons ---
        let footerContents = [];
        
        // Emergency Buttons
        if (isAbnormal) {
            if (data.location) {
                const loc = data.location.split(',');
                footerContents.push({ type: "button", style: "secondary", action: { type: "uri", label: "üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢", uri: `https://www.google.com/maps/search/?api=1&query=${loc[0]},${loc[1]}` } });
            }
            footerContents.push({ type: "button", style: "primary", color: "#D32F2F", action: { type: "uri", label: "üìû 1669", uri: "tel:1669" } });
            footerContents.push({ type: "button", style: "primary", color: "#F57C00", margin: "sm", action: { type: "uri", label: "üìû ‡∏£‡∏û.‡∏™‡∏ß‡∏µ", uri: "tel:0894745523" } });
        }

        // Standard Buttons
        footerContents.push({ type: "separator", margin: "md" });
        footerContents.push({
            type: "box", layout: "horizontal", margin: "md", spacing: "sm",
            contents: [
                { type: "button", style: "link", height: "sm", action: { type: "uri", label: "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà", uri: `https://liff.line.me/${DAILY_CHECK_LIFF_ID}` } },
                { type: "button", style: "link", height: "sm", action: { type: "uri", label: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß", uri: `https://liff.line.me/${HEALTH_INFO_LIFF_ID}` } }
            ]
        });

        return { 
            type: "flex", 
            altText: "‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å", 
            contents: { 
                type: "bubble", 
                size: "giga", // Max size
                header: { type: "box", layout: "vertical", backgroundColor: headerColor, contents: [{ type: "text", text: title, color: "#ffffff", weight: "bold", size: "xxl", align: "center" }] }, 
                body: { type: "box", layout: "vertical", contents: bodyContents }, 
                footer: { type: "box", layout: "vertical", contents: footerContents } 
            } 
        };
    }

    window.handleFinalSave = function(btn, isUrg) {
        if(btn && btn.disabled) return;
        if(isUrg && !sessionData.location) { if(confirm("‡πÄ‡∏Ñ‡∏™‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î\n‡∏Å‡∏î '‡∏ï‡∏Å‡∏•‡∏á' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á")) getLocation(false, true, () => handleFinalSave(btn, isUrg)); return; }
        if(btn) btn.disabled = true;
        sessionData.isEmergency = isUrg; sessionData.isFinalSave = true;
        
        const cb = 'cb'+Date.now();
        window[cb] = function(res) {
            if(res && res.status==='success') {
                if(liff.isInClient()) {
                    const flexMsg = createFlexMessage(sessionData);
                    // Attempt sending via client-side first
                    liff.sendMessages([flexMsg]).then(() => {
                        if (currentActionKey === '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î' || !isUrg) liff.closeWindow();
                        else if (document.getElementById('how-to-act-modal').style.display !== 'block') liff.closeWindow();
                    }).catch(e => {
                        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á Flex ‡πÑ‡∏î‡πâ)");
                        liff.closeWindow();
                    });
                } else {
                    if(isUrg) document.getElementById('how-to-act-modal').style.display='block'; else alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
                }
            } else alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            if(btn) btn.disabled = false;
        };
        const s = document.createElement('script'); s.src = `${GAS_URL}?action=saveData&callback=${cb}&data=${encodeURIComponent(JSON.stringify(sessionData))}`; document.body.appendChild(s);
    };

    window.handleTestClose = function() {
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á?\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡∏£‡∏û.)")) {
            if(liff.isInClient()) liff.closeWindow();
            else window.close();
        }
    };

    window.handleCallClick = function(el, key, tel) { currentActionKey = key; currentActionElement = el; pendingCallUrl = `tel:${tel}`; document.getElementById('confirmLocationModal').style.display = 'block'; };
    window.executePendingCall = function() {
        if(pendingCallUrl) {
            sessionData.contactedVia = currentActionKey;
            if(currentActionKey.startsWith('tel_')) sessionData[currentActionKey] = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
            const img = new Image(); img.src = `${GAS_URL}?action=saveData&data=${encodeURIComponent(JSON.stringify({...sessionData, isEmergency:true}))}`;
            document.getElementById('how-to-act-modal').style.display = 'block';
            window.location.href = pendingCallUrl;
        }
    };
    window.getLocation = function(save, call, cb) {
        const btn = document.getElementById('location-action'); if(btn) document.getElementById('location-text').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
        navigator.geolocation.getCurrentPosition(p => {
            if(btn) { btn.classList.add('success'); btn.innerHTML = `<span class="iconify" data-icon="mdi:check-circle"></span>`; document.getElementById('location-text').textContent = '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß'; }
            sessionData.location = `${p.coords.latitude},${p.coords.longitude}`;
            const dist = getDistanceFromLatLonInKm(p.coords.latitude, p.coords.longitude, hospitalCoords.lat, hospitalCoords.lon);
            updateSummaryAndActions(dist);
            if(cb) cb(); else if(call) { document.getElementById('confirmLocationModal').style.display='none'; executePendingCall(); }
        }, e => alert("‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"));
    };
    window.triggerSave = function(el, key) { currentActionKey = key; handleFinalSave(el, true); };
    window.fetchUserData = function(uid) { const s = document.createElement('script'); s.src = `${GAS_URL}?action=getUserData&userId=${uid}&callback=processUserData`; document.head.appendChild(s); };
    window.processUserData = function(res) {
        const bar = document.getElementById('user-info-bar'); const phone = document.getElementById('patient-phone');
        if(res.status==='found' && res.data) {
            sessionData = { ...sessionData, registeredName: res.data.name, district: res.data.district, village: res.data.village, risk_group: res.data.risk_group, thai_cv_risk_score: res.data.thai_cv_risk_score };
            document.getElementById('ui-name').textContent = res.data.name || '-';
            document.getElementById('ui-risk').textContent = (res.data.risk_group||'-') + (res.data.thai_cv_risk_score ? ` (${res.data.thai_cv_risk_score}%)` : '');
            
            // Fix N/A Date Logic
            let dateShow = '-';
            if (res.data.timestamp) {
                if (String(res.data.timestamp).indexOf('/') > -1) dateShow = res.data.timestamp;
                else dateShow = formatFullDateTime(res.data.timestamp);
            }
            document.getElementById('ui-date').textContent = dateShow;

            bar.style.display = 'flex';
            if (phone && phone.value.length === 10) phone.style.borderColor = "#28a745";
            if(res.data.district) fetchVolunteerData(`‡∏ï.${res.data.district} ‡∏°.${res.data.village}`);
        } else {
            sessionData.registeredName = `‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢ ${sessionData.userName || 'Guest'})`;
            sessionData.risk_group = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            bar.style.display = 'flex'; document.getElementById('ui-name').textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"; document.getElementById('ui-risk').textContent = "-"; document.getElementById('ui-date').textContent = "-";
            if (phone && phone.value.length === 10) phone.style.borderColor = "#f0ad4e";
        }
    };
    window.fetchVolunteerData = function(area) { const s = document.createElement('script'); s.src = `${GAS_URL}?action=getVolunteerData&areaKey=${encodeURIComponent(area)}&callback=processVolunteerData`; document.head.appendChild(s); };
    window.processVolunteerData = function(res) { if(res.status==='found') sessionData.volunteerContacts = res.data; };
    window.handleNoSymptom = function() { document.getElementById('no-symptom-content').innerHTML = Object.keys(symptomImages).map(k=>`<div class="symptom-card" style="margin-bottom:20px; flex-direction:row; padding:20px;" onclick="showLayer2('${k}')"><img src="${symptomImages[k]}" style="width:100px;"><div style="flex-grow:1; text-align:left; padding-left:20px;"><h6 class="fw-bold" style="font-size:28px;">${symptomTranslations[k]}</h6></div></div>`).join('') + `<button class="btn-unlikely mt-3" style="font-size:28px;" onclick="handleFinalNoSymptom()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</button>`; showLayer('layer-no-symptom-review'); };
    window.handleFinalNoSymptom = function() { saveData('symptomCategory', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£'); showFinalMessage("‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!", "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÄ‡∏•‡∏¢"); };
    window.showFinalMessage = function(t, txt) { saveData('symptomDetail', txt); document.getElementById('final-title').textContent = t; document.getElementById('final-text').textContent = txt; document.getElementById('final-emoji').textContent = 'üëç'; showLayer('layer-6'); };

    // Utils
    function formatTime(d) { return d.toTimeString().slice(0,5); }
    function formatFullDateTime(d) { if(!d || isNaN(new Date(d).getTime())) return 'N/A'; const date = new Date(d); return `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()+543} ${formatTime(date)}`; }
    function formatDuration(m) { if(isNaN(m)||m<0) return 'N/A'; const h=Math.floor(m/60); const r=Math.round(m%60); return h>0 ? `${h} ‡∏ä‡∏°. ${r} ‡∏ô‡∏≤‡∏ó‡∏µ` : `${r} ‡∏ô‡∏≤‡∏ó‡∏µ`; }
    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) { const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
    
    // Core Nav
    window.showLayer = function(id) { document.querySelectorAll('[data-layer]').forEach(e=>e.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); };
    window.saveData = function(k, v) { sessionData[k] = v; };
    window.viewImage = function(src) { document.getElementById('full-image').src=src; document.getElementById('image-viewer-modal').style.display='flex'; };
</script>
</body>
</html>