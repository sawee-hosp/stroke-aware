<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007BFF; --background-color: #f0f2f5;
            --card-bg-color: #ffffff; --text-color: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.1); --border-radius: 12px;
            --symptom-red: #D32F2F; --symptom-green: #388E3C;
            --dark-red: #C0392B; --light-red-bg: #FFF0F0;
            --time-yellow: #FFC107; --action-blue: #007BFF;
            --action-green: #28A745; --action-orange: #E67E22;
            --action-gray: #6C757D; --action-text: #fff;
        }
        body { font-family: "Noto Sans Thai", sans-serif; background-color: var(--background-color); margin: 0; padding: 16px; font-size: 18px; }
        .main-container { max-width: 600px; margin: 0 auto; }
        .card { padding: 24px; background-color: var(--card-bg-color); border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 16px; position: relative; padding-bottom: 20px; }
        .section-title { font-size: 1.6em; font-weight: 700; color: var(--text-color); margin-bottom: 0; display: flex; align-items: center; justify-content: center; }
        .section-subtitle { font-size: 1.1em; color: #555; margin-top: 4px; margin-bottom: 24px; text-align: center; }
        
        .symptom-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .symptom-card { border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; padding: 12px; cursor: pointer; transition: transform 0.2s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 150px; }
        .symptom-card:hover { transform: translateY(-5px); }
        .symptom-card img { width: 100%; max-width: 100px; aspect-ratio: 1 / 1; object-fit: contain; margin-bottom: 8px; }
        .symptom-card p { margin: 0; line-height: 1.3; font-weight: bold; }
        .symptom-card p.large-red { font-size: 24px; color: var(--symptom-red); }
        .symptom-card p.large-blue { font-size: 24px; color: var(--primary-color); }

        button { font-family: "Noto Sans Thai", sans-serif; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; }
        .options-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .options-container button { padding: 12px 18px; font-size: 1em; flex-grow: 1; }
        .time-options button { width: calc(50% - 4px); flex-grow: 0; }
        .time-options button.yellow-time { background-color: var(--time-yellow); color: var(--text-color); }
        .btn-action { width: 100%; padding: 15px; color: var(--action-text); margin-top: 20px; font-size: 1.2em; border-radius: 10px; }
        .btn-final-confirm { background-color: var(--primary-color); }
        .btn-symptom-likely { background-color: var(--symptom-red); color: var(--action-text); }
        .btn-symptom-unlikely { background-color: var(--symptom-green); color: var(--action-text); }
        .btn-severity-acute, .btn-severity-chronic { width: 100%; padding: 15px; margin: 8px 0; border-radius: 10px; }
        .btn-severity-acute { background-color: var(--symptom-red); color: var(--action-text); }
        .btn-severity-chronic { background-color: #E67E22; color: var(--action-text); }
        .btn-back { background: none; color: var(--primary-color); padding: 10px; font-size: 1em; position: absolute; bottom: 5px; right: 15px; }

        /* Emergency Summary Page */
        .emergency-text-container { padding: 15px; text-align: center; background: var(--light-red-bg); border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--symptom-red); }
        .emergency-text-container .highlight-large { font-size: 2em; font-weight: bold; color: var(--dark-red); animation: blinker 1.2s linear infinite; }
        .emergency-text-container .highlight-small { font-size: 1.1em; color: black; animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
        .action-buttons-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; place-items: center; }
        .action-button { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100px; height: 100px; border-radius: 15px; cursor: pointer; text-align: center; color: var(--action-text); text-decoration: none; transition: background-color 0.3s; }
        .action-button-icon { width: 48px; height: 48px; }
        .action-button-text { font-size: 0.9em; margin-top: 5px; font-weight: bold;}
        .location-button { background-color: var(--action-blue); }
        .location-button.success { background-color: var(--action-green); }
        .tel-button { background-color: var(--action-tel); }
        #summary-container .info-card { display: flex; align-items: center; gap: 15px; padding: 12px 5px; border-bottom: 1px solid #eee; }
        #summary-container .info-card:last-child { border-bottom: none; }
        .info-card-icon { width: 30px; height: 30px; flex-shrink: 0; color: var(--primary-color);}
        .info-card-text p { margin: 0; }
        .info-card-text .label { font-size: 0.9em; color: #666; }
        .info-card-text .value { font-size: 1em; font-weight: bold; color: var(--text-color); }
        .contact-buttons { margin-top: 20px; }
        .contact-button { display: flex; align-items: center; gap: 10px; border: 2px solid var(--action-gray); border-radius: 10px; padding: 12px; margin-bottom: 10px; text-decoration: none; color: var(--text-color); font-weight: bold; transition: background-color 0.2s; }
        .contact-button:hover { background-color: #f0f0f0; }
        .contact-button svg { width: 24px; height: 24px; fill: var(--action-gray); }
        .contact-button .label { flex-grow: 1; }

        /* General UI */
        .hidden { display: none; }
        .info-icon { font-size: 16px; cursor: pointer; color: var(--primary-color); margin-left: 8px; font-style: normal; border: 1px solid var(--primary-color); border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; vertical-align: middle; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; }
        .modal-content p { font-size: 1em; margin: 10px 0; }
        .modal-content button { width: 100%; padding: 15px; font-size: 1.1em; border-radius: 10px; }
        #registration-footer { text-align: center; margin-top: 20px; font-size: 1em; padding: 15px; background: #fff; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="user-info-bar" class="card hidden" style="padding:15px; margin-bottom:10px; background-color:#E3F2FD;">
            <p style="margin:0; font-size:1em;"><strong>‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</strong> <span id="user-name-display"></span></p>
            <p style="margin:0; font-size:0.9em; color:#555;"><strong>‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> <span id="user-risk-display"></span></p>
        </div>

        <div id="layer-1" data-layer="1" class="card">
            <h1 class="section-title">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å <span id="info-icon" class="info-icon">i</span></h1>
            <p class="section-subtitle">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="symptom-grid">
                <div class="symptom-card" onclick="showLayer2('Balance')"><img src="https://i.ibb.co/GMvMmZV/ezgif-2-563a5d8327-apng.png" alt="Balance"><p class="large-red">‡πÄ‡∏ã/‡∏°‡∏∂‡∏ô‡∏´‡∏±‡∏ß</p></div>
                <div class="symptom-card" onclick="showLayer2('Eye')"><img src="https://i.ibb.co/9r0cMc2/ezgif-2-5374788704.png" alt="Eye"><p class="large-red">‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏°‡∏≤‡∏Å</p></div>
                <div class="symptom-card" onclick="showLayer2('Face')"><img src="https://i.ibb.co/nRJc4MX/ezgif-2-8b010716d3.png" alt="Face"><p class="large-red">‡∏°‡∏∏‡∏°‡∏õ‡∏≤‡∏Å‡∏ï‡∏Å</p></div>
                <div class="symptom-card" onclick="showLayer2('Arm')"><img src="https://i.ibb.co/G7Vbn9V/ezgif-2-b6c57b3b00.png" alt="Arm"><p class="large-red">‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô‡∏¢‡∏≤‡∏Å</p></div>
                <div class="symptom-card" onclick="showLayer2('Speech')"><img src="https://i.ibb.co/gVYy8Nf/ezgif-2-01c5ed2695.png" alt="Speech"><p class="large-red">‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏û‡∏π‡∏î</p></div>
                <div class="symptom-card" onclick="handleNoSymptom()"><img src="https://i.ibb.co/yVP6CGv/image.png" alt="No Symptom"><p class="large-blue">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</p></div>
            </div>
        </div>

        <div id="layer-2" data-layer="2" class="card hidden">
            <h2 id="layer-2-title" class="section-title" style="text-align:center; font-size:1.4em;"></h2>
            <p class="section-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
            <div id="layer-2-buttons" class="options-container"></div>
            <button class="btn-back" onclick="goBack('layer-1')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>

        <div id="layer-3" data-layer="3" class="card hidden">
            <h2 class="section-title" style="text-align:center; font-size:1.4em;">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</h2>
            <div class="options-container">
                <button class="btn-severity-acute" onclick="handleSeveritySelection('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô')">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô</button>
                <button class="btn-severity-chronic" onclick="handleChronicSymptom('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á/‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏õ‡πá‡∏ô')">‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô/‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ‡πÄ‡∏õ‡πá‡∏ô</button>
            </div>
            <button class="btn-back" onclick="goBack('layer-2')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>

        <div id="layer-4" data-layer="4" class="card hidden">
            <h2 class="section-title" style="text-align:center; font-size:1.4em;">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà?</h2>
            <p class="section-subtitle">‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
            <div class="options-container time-options" id="time-options-container"></div>
            <button class="btn-back" onclick="goBack('layer-3')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
        
        <div id="layer-5" data-layer="5" class="card hidden">
             <div class="emergency-text-container">
                 <p class="highlight-large">‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å (Stroke)!</p>
                 <p class="highlight-small">‡πÇ‡∏õ‡∏£‡∏î‡πÇ‡∏ó‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                 <p style="font-size:1em; margin-top:10px;">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏î‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</p>
             </div>
             <div id="action-grid-container" class="action-buttons-grid"></div>
             <hr style="margin-top:20px; border-top: 1px solid #ddd; border-bottom: none;">
             <div id="summary-container"></div>
             <div id="contact-buttons" class="contact-buttons"></div>
             <button class="btn-action" style="background-color: var(--dark-red); font-size:1.3em; padding: 20px;" onclick="handleFinalSave(this, true)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
             <button class="btn-back" onclick="goBack('layer-4')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
        
        <div id="layer-6" data-layer="6" class="card hidden">
             <h2 id="final-title" class="section-title" style="text-align:center; font-size:1.4em;"></h2>
             <p id="final-text" style="text-align:center; font-size:1.1em;"></p>
             <button class="btn-action btn-final-confirm" style="font-size:1.3em; padding: 20px;" onclick="handleFinalSave(this, false)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î</button>
        </div>

        <div id="disclaimerModal" class="modal hidden" onclick="this.style.display='none'">
            <div class="modal-content" onclick="event.stopPropagation()">
                <h2 style="text-align:center; font-size:1.2em;">‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h2>
                <p>‚Ä¢ ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</strong> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</p>
                <p>‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÇ‡∏î‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</p>
                <p>‚Ä¢ ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ <strong>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô</strong> ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Å‡∏î‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</p>
                <button onclick="document.getElementById('disclaimerModal').style.display='none'" style="background-color:var(--primary-color); color:white; font-size:1.2em; padding:15px; border-radius: 10px;">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>

        <div id="registration-footer" class="card hidden" style="background-color: #f8f9fa; text-align:center;"></div>
    </div>

<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>
    // --- ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyptTEQF-bSEVcghqYZlQdPdP9WWbxn7JDzbidpI-m6wCe23ASFET9GF6M2l5RHBaz4/exec";
    const LIFF_ID = "2005789397-WRm1lYd9";
    const REGISTRATION_LIFF_URL = "https://liff.line.me/2005789397-nebQ8oJy";
    const hospitalCoords = { lat: 10.2300226, lon: 99.1087481 };
    
    let sessionData = {};

    const symptomDetails = {
        'Balance': { likely: ['‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ã‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á', '‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß', '‡∏¢‡∏∑‡∏ô/‡∏ô‡∏±‡πà‡∏á‡∏ô‡∏¥‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', '‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å'], unlikely: ['‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß·ûñ·üÅ·ûõ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡πà‡∏≤', '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏´‡∏π‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô', '‡πÄ‡∏°‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á/‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏ô‡πâ‡∏≠‡∏¢'] },
        'Eye': { likely: ['‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô', '‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ã‡πâ‡∏≠‡∏ô', '‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ã‡∏µ‡∏Å'], unlikely: ['‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡πÄ‡∏î‡∏¥‡∏°', '‡∏ï‡∏≤‡πÅ‡∏´‡πâ‡∏á/‡∏£‡∏∞‡∏Ñ‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏∑‡∏≠‡∏á', '‡∏ï‡πâ‡∏≠‡∏Å‡∏£‡∏∞‡∏à‡∏Å/‡∏ï‡πâ‡∏≠‡∏´‡∏¥‡∏ô', '‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏î‡∏≥‡∏•‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤'] },
        'Face': { likely: ['‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ã‡∏µ‡∏Å', '‡∏°‡∏∏‡∏°‡∏õ‡∏≤‡∏Å‡∏ï‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á', '‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏≤‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß', '‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏¥‡∏ó', '‡∏ä‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ã‡∏µ‡∏Å'], unlikely: ['‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß (Bell\'s Palsy)', '‡∏ö‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°'] },
        'Arm': { likely: ['‡πÅ‡∏Ç‡∏ô/‡∏Ç‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á‡∏ã‡∏µ‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', '‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô', '‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠', '‡πÄ‡∏î‡∏¥‡∏ô‡∏•‡∏≤‡∏Å‡∏Ç‡∏≤/‡∏Å‡∏∞‡πÄ‡∏ú‡∏•‡∏Å'], unlikely: ['‡∏õ‡∏ß‡∏î/‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', '‡∏ä‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏ó‡∏±‡∏ö', '‡∏´‡∏°‡∏≠‡∏ô‡∏£‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏ó‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô'] },
        'Speech': { likely: ['‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î/‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥', '‡∏•‡∏¥‡πâ‡∏ô‡πÅ‡∏Ç‡πá‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏°‡∏≤', '‡∏ô‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å/‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î', '‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô'], unlikely: ['‡∏û‡∏π‡∏î‡∏ï‡∏¥‡∏î‡∏Ç‡∏±‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢/‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î', '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏´‡∏ö/‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ß‡∏±‡∏î'] }
    };
    const icons = {
        user: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>',
        symptom: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>',
        clock: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>',
        hourglass: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 2v6h.01L6 8.01 10 12l-4 4 .01.01H6V22h12v-5.99h-.01L18 16l-4-4 4-3.99-.01-.01H18V2H6z"/></svg>',
        map: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-1.39 1.39C19.78 3.03 18.28 2 16.5 2c-1.2 0-2.33.49-3.15 1.28L12 5.92 10.65 3.28C9.83 2.49 8.7 2 7.5 2 5.72 2 4.22 3.03 3.81 4.39L3.5 3 2 4.5l1.39 1.39C3.03 5.22 2 6.72 2 8.5c0 1.2.49 2.33 1.28 3.15L5.92 12l-2.64 1.35C2.49 14.17 2 15.3 2 16.5c0 1.78 1.03 3.28 2.39 3.81L3 21.5l1.5 1.5 1.39-1.39C6.22 21.97 7.72 23 9.5 23c1.2 0 2.33-.49 3.15-1.28L14.08 18l2.64 1.35c.78.39 1.67.65 2.58.65 1.78 0 3.28-1.03 3.81-2.39L21.5 21.5l1.5-1.5-1.39-1.39C21.97 18.78 23 17.28 23 15.5c0-1.2-.49-2.33-1.28-3.15L18.08 12l2.64-1.35c.78-.39 1.67-.65 2.58-.65 1.78 0 3.28-1.03 3.81-2.39z"/></svg>',
        car: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5S18.33 16 17.5 16zM5 11l1.5-4.5h11L19 11H5z"/></svg>',
        ambulance: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 8h-3V6.21c0-2.61-1.91-4.94-4.51-5.19A5.008 5.008 0 007 6v2H4c-1.1 0-2 .9-2 2v9c0 1.1.9 2 2 2h1c.55 0 1-.45 1-1v-1h10v1c0 .55.45 1 1 1h3c1.1 0 2-.9 2-2v-3.19c1.16-.41 2-1.51 2-2.81v-1c0-1.65-1.35-3-3-3zm-9-4c1.1 0 2 .9 2 2v2H9V6c0-1.1.9-2 2-2zm8 8.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM6.5 14c.83 0 1.5.67 1.5 1.5S7.33 17 6.5 17 5 16.33 5 15.5 5.67 14 6.5 14z"/></svg>',
        runner: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 11.7V18h2v-6l2.1-2.1c.2-.2.5-.2.7 0l2.1 2.1c-.2.4-.4.8-.4 1.3 0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2c-.5 0-.9.2-1.3.4L12 9l-1.5 1.5-1-1-1.7 1.4z"/></svg>',
        contact: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H9v-1c0-1.33 2.67-2 4-2s4 .67 4 2v1zm3-4H6v-1c0-2 4-3.1 6-3.1s6 1.1 6 3.1v1zM18 7c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2zM8 7c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2z"/></svg>',
    };
    window.onload = async () => {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            
            const profile = await liff.getProfile();
            sessionData.userID = profile.userId;
            sessionData.userName = profile.displayName;
            
            fetchUserData(profile.userId);
            setupTimeOptions();

            if (!sessionStorage.getItem('disclaimerShown')) {
                document.getElementById('disclaimerModal').style.display = 'flex';
                sessionStorage.setItem('disclaimerShown', 'true');
            }
        } catch (err) { alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"); }
        document.getElementById('info-icon').onclick = () => { document.getElementById('disclaimerModal').style.display = 'flex'; };
    };

    function fetchUserData(userId) {
        if (!userId) return;
        const callbackName = 'userCallback' + Date.now();
        window[callbackName] = function(response) {
            const nameDisplay = document.getElementById('user-name-display');
            const riskDisplay = document.getElementById('user-risk-display');
            const footer = document.getElementById('registration-footer');

            if (response.status === 'found' && response.data.name) {
                const data = response.data;
                sessionData.registeredName = data.name;
                sessionData.district = data.district;
                sessionData.village = data.village;

                nameDisplay.textContent = data.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)';
                riskDisplay.textContent = `${data.thai_cv_risk_score || 'N/A'} (${data.risk_group || 'N/A'})`;
                document.getElementById('user-info-bar').classList.remove('hidden');
                footer.innerHTML = `<p style="font-size:0.8em;text-align:center;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</p>`;

                if(sessionData.district && sessionData.village) {
                    fetchVolunteerData(`‡∏ï.${sessionData.district} ‡∏°.${sessionData.village}`);
                }
            } else {
                document.getElementById('user-info-bar').classList.add('hidden');
                footer.innerHTML = `<p>‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô <a href="${REGISTRATION_LIFF_URL}">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a></p>`;
            }
            footer.classList.remove('hidden');
            delete window[callbackName];
            if(document.head.contains(scriptTag)) document.head.removeChild(scriptTag);
        };
        const url = `${GAS_URL}?action=getUserData&userId=${userId}&callback=${callbackName}`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        document.head.appendChild(scriptTag);
    }

    function fetchVolunteerData(areaKey) {
        if (!areaKey) return;
        const callbackName = 'volunteerCallback' + Date.now();
        window[callbackName] = function(response) {
            if (response.status === 'found') {
                sessionData.volunteerContacts = response.data;
            }
            delete window[callbackName];
            if(document.head.contains(scriptTag)) document.head.removeChild(scriptTag);
        };
        const url = `${GAS_URL}?action=getVolunteerData&areaKey=${encodeURIComponent(areaKey)}&callback=${callbackName}`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        document.head.appendChild(scriptTag);
    }
    
    function handleFinalSave(button, isEmergency) {
        sessionData.isEmergency = isEmergency;
        button.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; button.disabled = true;
        const callbackName = 'saveCallback' + Date.now();
        window[callbackName] = function(response) {
            if (response && response.status === 'success') {
                if (liff.isInClient()) liff.closeWindow();
                else alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            } else {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + (response ? response.message : 'Unknown error'));
                button.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î'; button.disabled = false;
            }
            delete window[callbackName];
            if(document.head.contains(scriptTag)) document.head.removeChild(scriptTag);
        };
        const dataStr = encodeURIComponent(JSON.stringify(sessionData));
        const url = `${GAS_URL}?action=saveData&callback=${callbackName}&data=${dataStr}`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        scriptTag.onerror = function() {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
            button.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î'; button.disabled = false;
            delete window[callbackName];
        };
        document.head.appendChild(scriptTag);
    }
    
    function saveData(key, value) { sessionData[key] = value; }
    
    function showLayer(layerId) {
        document.querySelectorAll('[data-layer]').forEach(el => el.classList.add('hidden'));
        document.getElementById(layerId).classList.remove('hidden');
    }
    
    function goBack(targetLayer) { showLayer(targetLayer); }

    function showFinalMessage(title, text) {
        saveData('symptomDetail', text);
        document.getElementById('final-title').textContent = title;
        document.getElementById('final-text').textContent = text;
        showLayer('layer-6');
    }

    function createButton(container, text, className, onClick) {
        const button = document.createElement('button');
        button.textContent = text;
        button.className = className;
        button.onclick = onClick;
        container.appendChild(button);
    }

    function showLayer2(symptomKey) {
        saveData('symptomCategory', symptomKey);
        document.getElementById('layer-2-title').textContent = `‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô${symptomKey}`;
        const buttonsContainer = document.getElementById('layer-2-buttons');
        buttonsContainer.innerHTML = '';
        const details = symptomDetails[symptomKey];
        details.likely.forEach(text => createButton(buttonsContainer, text, 'btn-symptom-likely', () => handleSymptomResult(true, text)));
        details.unlikely.forEach(text => createButton(buttonsContainer, text, 'btn-symptom-unlikely', () => handleSymptomResult(false, text)));
        showLayer('layer-2');
    }

    function handleNoSymptom() {
        saveData('symptomCategory', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£');
        saveData('symptomDetail', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥');
        showFinalMessage("‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!", "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢");
    }

    function handleSymptomResult(isLikely, symptomDetail) {
        saveData('symptomDetail', symptomDetail);
        if (isLikely) { showLayer('layer-3'); } 
        else {
            saveData('frequency', '‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô');
            showFinalMessage("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô", "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏Å‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå");
        }
    }
    
    function handleSeveritySelection(frequencyText) { saveData('frequency', frequencyText); showLayer('layer-4'); }
    
    function handleChronicSymptom(frequencyText) {
        saveData('frequency', frequencyText);
        showFinalMessage("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥", "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á");
    }
    
    function handleTimeSelection(minutesAgo, isChronic = false) {
        if (isChronic) {
            saveData('onsetTime', '‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á/‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô');
            showFinalMessage("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥", "‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏†‡∏≤‡∏ß‡∏∞‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô");
            return;
        }
        const onsetTime = new Date(Date.now() - minutesAgo * 60000);
        sessionData.onsetTimeObject = onsetTime;
        saveData('onsetTime', formatFullDateTime(onsetTime));
        buildSummaryPage();
        showLayer('layer-5');
    }

    function buildSummaryPage() {
        const onset = sessionData.onsetTimeObject;
        if (!onset) return;
        const arrivalDeadline = new Date(onset.getTime() + 3.5 * 60 * 60000);
        const rtpaDeadline = new Date(onset.getTime() + 4.5 * 60 * 60000);
        saveData('arrivalDeadline', formatTime(rtpaDeadline));
        saveData('rtpaDeadline', formatTime(rtpaDeadline));
        let summaryHtml = `<p><strong>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</strong> ${sessionData.registeredName || sessionData.userName}</p>
                           <p><strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</strong> ${sessionData.symptomDetail}</p>
                           <p><strong>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${formatFullDateTime(onset)}</p>
                           <p><strong>‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á ‡∏£‡∏û. ‡∏Å‡πà‡∏≠‡∏ô:</strong> ${formatTime(arrivalDeadline)} ‡∏ô.</p>
                           <p><strong>‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤ rT-PA ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô:</strong> ${formatTime(rtpaDeadline)} ‡∏ô.</p>`;
        document.getElementById('summary-container').innerHTML = summaryHtml;
        buildActionContainer();
    }
    
    function buildActionContainer() {
        const actionContainer = document.getElementById('action-container');
        actionContainer.innerHTML = `<button onclick="getLocation()" class="btn-action" style="background-color: var(--primary-color); font-size:1em;">
            <span style="font-size:1.5em; vertical-align:middle;">üìç</span> ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤</button>`;
    }

    function getLocation() {
        document.querySelector('#action-container button').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
        navigator.geolocation.getCurrentPosition(
            position => {
                const { latitude, longitude } = position.coords;
                saveData('location', `${latitude},${longitude}`);
                const distance = getDistanceFromLatLonInKm(latitude, longitude, hospitalCoords.lat, hospitalCoords.lon);
                updateSummaryAndActions(distance);
            },
            error => {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
                updateSummaryAndActions(null);
            }
        );
    }

    function updateSummaryAndActions(distance) {
        let summaryHtml = document.getElementById('summary-container').innerHTML;
        let actionHtml = '';

        if (distance !== null) {
            const travelTimeMinutes = (distance / 40) * 60;
            const ambulanceTravelTime = travelTimeMinutes * 1.5 + 15;
            const selfTravelArrival = new Date(new Date().getTime() + travelTimeMinutes * 60000);
            const ambulanceArrival = new Date(new Date().getTime() + ambulanceTravelTime * 60000);
            const rtpaDeadline = sessionData.onsetTimeObject ? new Date(sessionData.onsetTimeObject.getTime() + 4.5 * 60 * 60000) : new Date();

            sessionData.distance = `${distance.toFixed(1)} ‡∏Å‡∏°.`;
            sessionData.duration = formatDuration(travelTimeMinutes);
            sessionData.selfTravelEstimate = selfTravelArrival <= rtpaDeadline ? '‡∏ó‡∏±‡∏ô' : '‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô (‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏ö‡πÑ‡∏õ‡∏£‡∏û.)';
            sessionData.ambulanceEstimate = ambulanceArrival <= rtpaDeadline ? '‡∏ó‡∏±‡∏ô' : '‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô (‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏ö‡πÑ‡∏õ‡∏£‡∏û.)';

            summaryHtml += `<hr><p><strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏õ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ:</strong> ${sessionData.distance}</p>
                            <p><strong>‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</strong> ${sessionData.duration}</p>
                            <p><strong>‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£ (‡∏£‡∏ñ ‡∏£‡∏û. ‡πÑ‡∏õ‡∏£‡∏±‡∏ö):</strong> <strong style="color:${sessionData.ambulanceEstimate.includes('‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô') ? 'red' : 'green'}">${sessionData.ambulanceEstimate}</strong></p>
                            <p><strong>‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£ (‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ):</strong> <strong style="color:${sessionData.selfTravelEstimate.includes('‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô') ? 'red' : 'green'}">${sessionData.selfTravelEstimate}</strong></p>`;
        }
        
        const gmapsUrl = `http://googleusercontent.com/maps.google.com/6?daddr=${hospitalCoords.lat},${hospitalCoords.lon}`;
        
        if (distance !== null && distance > 450) {
            actionHtml += `<p style="color:red; font-size:0.8em; text-align:center; margin-top:10px;">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï ‡∏≠.‡∏™‡∏ß‡∏µ ‡∏à.‡∏ä‡∏∏‡∏°‡∏û‡∏£ ‡πÇ‡∏õ‡∏£‡∏î‡πÇ‡∏ó‡∏£ 1669 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡∏û.‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>`;
            actionHtml += `<a href="tel:1669"><button class="btn-action" style="background-color: var(--dark-red); font-size:1em;">‡πÇ‡∏ó‡∏£ 1669</button></a>`;
        } else {
            actionHtml += `<a href="tel:0894745523"><button class="btn-action" style="background-color: #E67E22; font-size:1em;">‡πÇ‡∏ó‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</button></a>`;
            actionHtml += `<a href="tel:1669"><button class="btn-action" style="background-color: var(--dark-red); font-size:1em;">‡πÇ‡∏ó‡∏£ 1669</button></a>`;
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢
        if (sessionData.volunteerContacts) {
            const contacts = sessionData.volunteerContacts;
            let volunteerHtml = '<hr><p style="text-align:center; font-weight:bold; font-size:1em;">‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p>';
            if (contacts.volunteer1_tel) volunteerHtml += `<a href="tel:${contacts.volunteer1_tel}"><button class="btn-action" style="background-color:#5D6D7E; font-size:0.9em;">‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ‡∏≠‡∏™‡∏°. ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1</button></a>`;
            if (contacts.volunteer2_tel) volunteerHtml += `<a href="tel:${contacts.volunteer2_tel}"><button class="btn-action" style="background-color:#5D6D7E; font-size:0.9em;">‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ‡∏≠‡∏™‡∏°. ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2</button></a>`;
            if (contacts.headman_tel) volunteerHtml += `<a href="tel:${contacts.headman_tel}"><button class="btn-action" style="background-color:#5D6D7E; font-size:0.9em;">‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</button></a>`;
            if (contacts.pcu_tel) volunteerHtml += `<a href="tel:${contacts.pcu_tel}"><button class="btn-action" style="background-color:#5D6D7E; font-size:0.9em;">‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ‡∏£‡∏û.‡∏™‡∏ï.</button></a>`;
            actionHtml += volunteerHtml;
        }
        
        actionHtml += `<a href="${gmapsUrl}" target="_blank"><button class="btn-action" style="background-color: #34A853; margin-top: 15px; font-size:1em;">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</button></a>`;

        document.getElementById('summary-container').innerHTML = summaryHtml;
        document.getElementById('action-container').innerHTML = actionHtml;
    }

    function setupTimeOptions() {
        const container = document.getElementById('time-options-container');
        container.innerHTML = '';
        const now = new Date();
        const timeOptions = [
            { text: `‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (${formatTime(now)})`, minutes: 0 }, { text: '10 ‡∏ô‡∏≤‡∏ó‡∏µ', minutes: 10 }, 
            { text: '30 ‡∏ô‡∏≤‡∏ó‡∏µ', minutes: 30 }, { text: '1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', minutes: 60 }, 
            { text: '2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', minutes: 120 }, { text: '3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', minutes: 180 }, 
            { text: '4 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', minutes: 240 }, { text: '6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', minutes: 360 }, 
            { text: '12 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', minutes: 720 }, { text: '1 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô', minutes: 1440, chronic: true }, 
            { text: '‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô', minutes: 0, chronic: true }
        ];
        timeOptions.forEach(opt => {
            const btn = document.createElement('button');
            btn.textContent = opt.text;
            btn.onclick = () => handleTimeSelection(opt.minutes, opt.chronic);
            if (opt.chronic) btn.className = "btn-severity-chronic";
            container.appendChild(btn);
        });
    }
    
    function formatTime(date) { return date.toTimeString().slice(0, 5); }
    
    function formatFullDateTime(date) {
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear() + 543;
        const hh = String(date.getHours()).padStart(2, '0');
        const mm = String(date.getMinutes()).padStart(2, '0');
        const ss = String(date.getSeconds()).padStart(2, '0');
        return `${d}/${m}/${y} ${hh}:${mm}:${ss}`;
    }

    function formatDuration(minutes) {
        if (isNaN(minutes) || minutes < 0) return 'N/A';
        const h = Math.floor(minutes / 60);
        const m = Math.round(minutes % 60);
        if (h > 0) return `${h} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        return `${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
</script>
</body>
</html>