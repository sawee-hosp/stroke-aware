<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประเมินอาการสโตรก</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007BFF; --background-color: #f0f2f5;
            --card-bg-color: #ffffff; --text-color: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.1); --border-radius: 12px;
            --symptom-red: #D32F2F; --symptom-green: #388E3C;
        }
        body { font-family: "Noto Sans Thai", sans-serif; background-color: var(--background-color); margin: 0; padding: 16px; font-size: 16px; }
        .main-container { max-width: 600px; margin: 0 auto; }
        .card { padding: 24px; background-color: var(--card-bg-color); border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 16px; position: relative; padding-bottom: 20px; }
        .symptom-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .symptom-card { border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; padding: 12px; cursor: pointer; transition: transform 0.2s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 120px; }
        .symptom-card:hover { transform: translateY(-5px); }
        .symptom-card img { width: 80%; max-width: 80px; aspect-ratio: 1 / 1; object-fit: contain; margin-bottom: 8px; }
        .symptom-card p { margin: 0; font-size: 1.1em; font-weight: bold; line-height: 1.3; }
        button { font-family: "Noto Sans Thai", sans-serif; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; }
        .options-container { text-align: center; }
        .options-container button { display: block; width: 100%; padding: 15px; margin: 8px 0; font-size: 1em; }
        .btn-symptom-likely { background-color: var(--symptom-red); color: white; }
        .btn-symptom-unlikely { background-color: var(--symptom-green); color: white; }
        .btn-action { width: 100%; padding: 15px; color: white; margin-top: 20px; font-size: 1.1em; background-color: var(--primary-color); }
        .hidden { display: none; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
        .modal-content p { font-size: 0.9em; margin: 10px 0; }
        #registration-footer { text-align: center; margin-top: 20px; font-size: 0.9em; padding: 15px; background: #fff; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="layer-1" data-layer="1" class="card">
            <div class="symptom-grid">
                <div class="symptom-card" onclick="showLayer2('Balance')"><p>เซ/มึนหัว (Balance)</p></div>
                <div class="symptom-card" onclick="showLayer2('Eye')"><p>ตามัวมาก (Eye)</p></div>
                <div class="symptom-card" onclick="showLayer2('Face')"><p>มุมปากตก (Face)</p></div>
                <div class="symptom-card" onclick="showLayer2('Arm')"><p>ยกแขนยาก (Arm)</p></div>
                <div class="symptom-card" onclick="showLayer2('Speech')"><p>ลำบากพูด (Speech)</p></div>
                <div class="symptom-card" onclick="handleNoSymptom()"><p style="color:#0b5394;">ไม่มีอาการดังกล่าว</p></div>
            </div>
        </div>

        <div id="layer-2" data-layer="2" class="card hidden">
            <h2 id="layer-2-title" style="text-align:center;"></h2>
            <p style="text-align:center; font-size: 1em;">กรุณาเลือกรายละเอียดอาการที่ใกล้เคียงที่สุด</p>
            <div id="layer-2-buttons" class="options-container"></div>
        </div>
        
        <div id="layer-final" data-layer="final" class="card hidden">
             <h2 id="final-title" class="section-title" style="text-align:center;"></h2>
             <p id="final-text" style="text-align:center;"></p>
             <button class="btn-action" onclick="handleFinalSave(this)">บันทึกและปิด</button>
        </div>

        <div id="registration-footer" class="hidden"></div>
    </div>

    <div id="disclaimerModal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 style="text-align:center; font-size:1.1em;">ข้อจำกัดความรับผิดชอบ</h2>
            <p>• แอปพลิเคชันนี้ใช้เพื่อ <strong>ประเมินอาการเบื้องต้น</strong> เท่านั้น ไม่ใช่การวินิจฉัยทางการแพทย์</p>
            <p>• การตัดสินใจรักษาต้องพิจารณาจากปัจจัยจริงโดยบุคลากรทางการแพทย์</p>
            <p>• หากมีอาการฉุกเฉิน โปรดโทร 1669 ทันที</p>
            <button onclick="document.getElementById('disclaimerModal').style.display='none'" style="background-color:var(--primary-color); color:white; font-size:1.1em; padding:12px;">ตกลง</button>
        </div>
    </div>

<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyptTEQF-bSEVcghqYZlQdPdP9WWbxn7JDzbidpI-m6wCe23ASFET9GF6M2l5RHBaz4/exec";
    const LIFF_ID = "2005789397-WRm1lYd9";
    const REGISTRATION_LIFF_URL = "https://liff.line.me/2005789397-nebQ8oJy";
    
    let sessionData = {};

     const symptomDetails = {
        'Balance': {
            likely: ['เดินเซรุนแรง', 'สูญเสียการทรงตัว', 'ยืน/นั่งนิ่งไม่ได้', 'เวียนหัวรุนแรงมาก'],
            unlikely: ['เวียนหัวពេលเปลี่ยนท่า', 'อาการน้ำในหูไม่เท่ากัน', 'เมาค้าง/พักผ่อนน้อย']
        },
        'Eye': {
            likely: ['ตามัวหรือมองไม่เห็น', 'เห็นภาพซ้อน', 'เสียการมองเห็นครึ่งซีก'],
            unlikely: ['ปัญหาสายตาเดิม', 'ตาแห้ง/ระคายเคือง', 'ต้อกระจก/ต้อหิน', 'เห็นจุดดำลอยไปมา']
        },
        'Face': {
            likely: ['หน้าเบี้ยวครึ่งซีก', 'มุมปากตกข้างหนึ่ง', 'ยิ้มแล้วปากเบี้ยว', 'หลับตาไม่สนิท', 'ชาใบหน้าครึ่งซีก'],
            unlikely: ['โรคใบหน้าเบี้ยว (Bell\'s Palsy)', 'บวมจากปัญหาทันตกรรม']
        },
        'Arm': {
            likely: ['แขน/ขาอ่อนแรงซีกเดียว', 'ยกแขนได้ไม่เท่ากัน', 'ของหลุดจากมือ', 'เดินลากขา/กะเผลก'],
            unlikely: ['ปวด/อักเสบกล้ามเนื้อ', 'ชาจากการนอนทับ', 'หมอนรองกระดูกทับเส้น']
        },
        'Speech': {
            likely: ['พูดไม่ชัด/ไม่เป็นคำ', 'ลิ้นแข็งเหมือนคนเมา', 'นึกคำพูดไม่ออก/ใช้คำผิด', 'ไม่เข้าใจคำพูดคนอื่น'],
            unlikely: ['พูดติดขัดเพราะเหนื่อย/เครียด', 'เสียงแหบ/เป็นหวัด']
        }
    };
    
    window.onload = async () => {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            
            const profile = await liff.getProfile();
            sessionData.userID = profile.userId;
            sessionData.userName = profile.displayName;
            
            fetchUserData(profile.userId); // Fetch registration status
            
            // Show disclaimer on first load of the session
            if (!sessionStorage.getItem('disclaimerShown')) {
                document.getElementById('disclaimerModal').style.display = 'flex';
                sessionStorage.setItem('disclaimerShown', 'true');
            }
        } catch (err) { alert("ไม่สามารถเชื่อมต่อกับ LINE ได้ โปรดลองเปิดใหม่อีกครั้ง"); }
    };

    function fetchUserData(userId) {
        if (!userId) return;
        const callbackName = 'userCallback' + Date.now();
        window[callbackName] = function(response) {
            const footer = document.getElementById('registration-footer');
            if (response.status === 'found' && response.data.name) {
                footer.innerHTML = `<p>✔️ ลงทะเบียนแล้วในชื่อ: <strong>${response.data.name}</strong></p>`;
            } else {
                footer.innerHTML = `<p>คุณยังไม่ได้ลงทะเบียน <a href="${REGISTRATION_LIFF_URL}">คลิกที่นี่เพื่อลงทะเบียน</a></p>`;
            }
            footer.classList.remove('hidden');
            delete window[callbackName];
            document.head.removeChild(scriptTag);
        };
        const url = `${GAS_URL}?action=getUserData&userId=${userId}&callback=${callbackName}`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        document.head.appendChild(scriptTag);
    }

    // --- [FIXED] saveData function is now defined ---
    function saveData(key, value) {
        sessionData[key] = value;
        console.log("Data Stored:", sessionData);
    }

    function handleFinalSave(button) {
        button.textContent = 'กำลังบันทึก...'; button.disabled = true;
        const callbackName = 'saveCallback' + Date.now();
        window[callbackName] = function(response) {
            if (response && response.status === 'success') {
                if (liff.isInClient()) liff.closeWindow();
                else alert("บันทึกข้อมูลเรียบร้อยแล้ว");
            } else {
                alert("เกิดข้อผิดพลาดในการบันทึก: " + (response ? response.message : 'Unknown error'));
                button.textContent = 'บันทึกและปิด'; button.disabled = false;
            }
            delete window[callbackName];
            document.head.removeChild(scriptTag);
        };
        const dataStr = encodeURIComponent(JSON.stringify(sessionData));
        const url = `${GAS_URL}?action=saveData&callback=${callbackName}&data=${dataStr}`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        scriptTag.onerror = () => {
            alert("ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้");
            button.textContent = 'บันทึกและปิด'; button.disabled = false;
            delete window[callbackName];
        };
        document.head.appendChild(scriptTag);
    }
    
    function showLayer(layerId) {
        document.querySelectorAll('[data-layer]').forEach(el => el.classList.add('hidden'));
        document.getElementById(layerId).classList.remove('hidden');
    }
    
    function goBack() { showLayer('layer-1'); }

    function showFinalMessage(title, text) {
        saveData('symptomDetail', text); // Save the conclusion
        document.getElementById('final-title').textContent = title;
        document.getElementById('final-text').textContent = text;
        showLayer('layer-final');
    }

    function createButton(container, text, className, onClick) {
        const button = document.createElement('button');
        button.textContent = text;
        button.className = className;
        button.onclick = onClick;
        container.appendChild(button);
    }

    function showLayer2(symptomCategory) {
        saveData('symptomCategory', symptomCategory); // This line caused the error before
        document.getElementById('layer-2-title').textContent = `อาการด้าน${symptomCategory}`;
        const buttonsContainer = document.getElementById('layer-2-buttons');
        buttonsContainer.innerHTML = '';
        const details = symptomDetails[symptomCategory];
        details.likely.forEach(text => createButton(buttonsContainer, text, 'btn-symptom-likely', () => handleSymptomResult(text)));
        details.unlikely.forEach(text => createButton(buttonsContainer, text, 'btn-symptom-unlikely', () => handleSymptomResult(text)));
        showLayer('layer-2');
    }

    function handleNoSymptom() {
        saveData('symptomCategory', 'ไม่มีอาการ');
        showFinalMessage("เยี่ยมมาก!", "วันนี้คุณไม่มีอาการน่าสงสัย ขอให้มีสุขภาพที่แข็งแรงต่อไปครับ");
    }

    function handleSymptomResult(symptomDetail) {
        showFinalMessage("บันทึกผล", `คุณมีอาการ: ${symptomDetail}`);
    }

</script>
</body>
</html>