<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <style>
        :root {
            --primary-color: #007BFF; --background-color: #f0f2f5;
            --card-bg-color: #ffffff; --text-color: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.1); --border-radius: 16px;
            --symptom-red: #D32F2F; --symptom-green: #388E3C;
            --dark-red: #C0392B; --light-red-bg: #FFF0F0;
            --action-blue: #007BFF; --action-green: #28A745;
            --action-red: #D32F2F; --action-orange: #f39c12; --action-gray: #6C757D;
        }

        /* --- Global Font Size (Large for Elderly) --- */
        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            background-color: var(--background-color); 
            margin: 0; padding: 16px; 
            font-size: 24px; 
            line-height: 1.5;
        }

        /* --- Specific Class for Summary Page (Normal Font Size) --- */
        .normal-font-mode {
            font-size: 18px !important; 
        }
        .normal-font-mode .btn-action { font-size: 1.2em; padding: 15px; } 
        .normal-font-mode .action-button .iconify { font-size: 48px; } 
        .normal-font-mode .emergency-text-container .large-red-blink { font-size: 1.5em; }

        /* --- Loading Screen Styles --- */
        #loading { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 2000; color: white; text-align: center; 
        }
        .spinner {
            border: 8px solid #333; border-top: 8px solid #ffc107; 
            border-radius: 50%; width: 80px; height: 80px; 
            animation: spin 1s linear infinite; margin-bottom: 30px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-text { font-size: 2rem; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .loading-prefix { font-size: 1.2rem; margin-bottom: 5px; color: #aaa; }
        #loading-subtext { 
            font-size: 3rem; font-weight: 800; color: #ffc107; 
            min-height: 80px; line-height: 1.2; text-shadow: 2px 2px 10px rgba(255,193,7,0.5); 
            opacity: 1; transition: opacity 0.5s ease-in-out; 
        }

        /* --- Image Viewer Modal (Lightbox) --- */
        #image-viewer-modal {
            display: none; position: fixed; z-index: 5000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.95);
            align-items: center; justify-content: center; flex-direction: column;
        }
        #full-image {
            max-width: 90%; max-height: 80vh; object-fit: contain; border-radius: 10px;
        }
        .close-img-btn {
            position: absolute; top: 20px; right: 20px;
            color: #f1f1f1; font-size: 50px; font-weight: bold; cursor: pointer;
            z-index: 5001; background: none; border: none;
        }
        .img-instruction { color: #ccc; margin-top: 10px; font-size: 18px; }

        /* --- Layout & Card Styles --- */
        .main-container { max-width: 600px; margin: 0 auto; }
        .card { padding: 20px; background-color: var(--card-bg-color); border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 10px; }
        .card-body { padding-bottom: 10px; }
        
        .section-title { font-size: 1.6em; font-weight: 700; color: var(--text-color); display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        .section-subtitle { font-size: 1.1em; color: #555; margin-top: 0px; margin-bottom: 20px; text-align: center; }

        .home-title { font-size: 1.4em; margin-bottom: 5px; } 
        .home-subtitle { font-size: 1em; margin-bottom: 15px; }

        /* --- Symptom Grid --- */
        .symptom-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .symptom-card { 
            border-radius: var(--border-radius); box-shadow: var(--shadow); 
            text-align: center; padding: 15px; cursor: pointer; 
            transition: transform 0.2s ease; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; min-height: 160px; 
            border: 2px solid transparent; background: #fff;
        }
        .symptom-card:hover { transform: translateY(-5px); border-color: var(--primary-color); }
        .symptom-card img { width: 100%; max-width: 100px; aspect-ratio: 1 / 1; object-fit: contain; margin-bottom: 10px; }
        .symptom-card p { margin: 0; line-height: 1.2; font-weight: bold; font-size: 1.1em; }
        .symptom-card.no-symptom { background-color: #E8F5E9; border: 2px solid #C8E6C9; }

        /* --- Buttons & Inputs --- */
        button { font-family: "Noto Sans Thai", sans-serif; cursor: pointer; border: none; border-radius: 12px; font-weight: bold; transition: 0.2s; }
        .options-container { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
        .options-container button { padding: 20px; font-size: 1.1em; flex-grow: 1; color: white; }
        .time-options button { width: calc(33.33% - 8px); flex-grow: 0; margin-bottom: 10px; font-size: 1em; padding: 15px 5px; color: #333; border: 1px solid #ddd;}
        
        .btn-action { width: 100%; padding: 20px; color: white; margin-top: 25px; font-size: 1.4em; border-radius: 15px; }
        
        .btn-back-container { padding: 15px 0; border-top: 1px solid #eee; margin-top: 25px; }
        .btn-back { background: none; color: var(--primary-color); padding: 15px; font-size: 1.2em; text-align: center; width: 100%; display: block; font-weight: bold; border: 2px solid var(--primary-color); border-radius: 10px; }
        
        .hidden { display: none; }
        
        /* Clickable Image Style */
        .symptom-image-container { position: relative; }
        .symptom-image-container img { width: 100%; border-radius: var(--border-radius); margin-bottom: 20px; cursor: zoom-in; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .zoom-hint { position: absolute; bottom: 25px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; pointer-events: none; }

        .general-symptom-buttons { display: flex; gap: 15px; margin-bottom: 25px; }
        .general-symptom-buttons button { flex: 1; padding: 20px; font-size: 1.2em; }
        .btn-likely { background-color: var(--symptom-red); color: white; }
        .btn-unlikely { background-color: var(--symptom-green); color: white; }
        
        /* --- [UPDATED] Review Card Styles --- */
        .review-card { 
            display: flex; 
            flex-direction: column; /* ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
            padding: 0; /* ‡∏•‡∏ö padding ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏ä‡∏ô‡∏Ç‡∏≠‡∏ö */
            border: 1px solid #ddd; 
            border-radius: var(--border-radius); 
            margin-bottom: 30px; 
            overflow: hidden; /* ‡∏ï‡∏±‡∏î‡∏°‡∏∏‡∏°‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .review-image { 
            width: 100%; 
            padding: 0; 
            cursor: zoom-in; 
            position: relative;
        } 
        .review-image img { 
            width: 100%; 
            height: auto;
            display: block; /* ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ */
            border-radius: 0; /* ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏á‡πÄ‡∏û‡∏£‡∏≤‡∏∞ card ‡πÇ‡∏Ñ‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß */
        }
        .review-action { 
            display: flex; 
            gap: 10px;
            padding: 15px; 
            background: #fff;
        }
        .review-action button { 
            flex: 1; /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
            font-size: 1.1em; 
            padding: 15px 5px; 
        }
        
        /* Summary Page Styles */
        .emergency-text-container { padding: 15px; text-align: center; background: var(--light-red-bg); border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--symptom-red); }
        .emergency-text-container p { margin: 5px 0; }
        .emergency-text-container .large-red-blink { font-weight: bold; color: var(--dark-red); animation: blinker 1.2s linear infinite; }
        .emergency-text-container .small-black-blink { color: black; animation: blinker 1.5s linear infinite; font-weight: bold; }
        .countdown-timer { color: var(--primary-color); font-weight: bold; margin-top: 10px; }
        @keyframes blinker { 50% { opacity: 0.3; } }
        
        .action-buttons-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; place-items: center; margin-top: 15px; }
        .action-button-wrapper { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-color); width: 100%; }
        .action-button { display: flex; align-items: center; justify-content: center; width: 100%; aspect-ratio: 1/1; border-radius: 15px; cursor: pointer; text-align: center; color: white; transition: background-color 0.3s; box-shadow: var(--shadow); }
        .action-button-text { margin-top: 8px; font-weight: bold; }
        
        .location-button { background-color: var(--action-blue); }
        .location-button.success { background-color: var(--action-green); }
        .tel-sawi-button { background-color: var(--action-orange); }
        .tel-1669-button { background-color: var(--action-red); }
        
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .summary-table tr td { padding: 10px 5px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .summary-table .icon-col { width: 40px; text-align: center; }
        .summary-table .icon-col .iconify { color: var(--primary-color); }
        .summary-table .label-col { color: #6C757D; white-space: nowrap; }
        .summary-table .value-col { font-weight: bold; text-align: right; color: var(--text-color); }
        .summary-table .value-col.value-urgent { color: var(--dark-red); }
        
        .contact-buttons { margin-top: 20px; }
        .contact-button { display: flex; align-items: center; justify-content: center; gap: 10px; border: 2px solid var(--action-gray); border-radius: 12px; padding: 10px; margin-bottom: 10px; text-decoration: none; color: var(--text-color); font-weight: bold; transition: background-color 0.2s; }
        .contact-button .label { flex-grow: 1; text-align: center; }
        .route-button { border-color: #34A853; color: #34A853 !important; }
        
        /* Modals */
        .modal { position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
        .modal-content {
            background-color: #fff; padding: 30px; border-radius: 20px;
            width: 90%; max-width: 550px; text-align: left;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-content h2 { font-size: 1.4em; margin-bottom: 20px; }
        .modal-content p, .modal-content li { font-size: 1.1em; margin: 10px 0; }
        .info-icon { font-size: 20px; cursor: pointer; color: var(--primary-color); margin-left: 5px; border: 2px solid var(--primary-color); border-radius: 50%; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; vertical-align: middle; font-weight: bold;}
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <div class="loading-prefix">‡∏à‡∏≥‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å:</div>
        <div id="loading-subtext"></div>
    </div>

    <div id="image-viewer-modal" onclick="closeImageViewer()">
        <button class="close-img-btn">√ó</button>
        <img id="full-image">
        <div class="img-instruction">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î</div>
    </div>

    <div class="main-container">
        <div id="layer-1" data-layer="1" class="card"></div>
        
        <div id="layer-2" data-layer="2" class="card hidden"></div>
        
        <div id="layer-3" data-layer="3" class="card hidden"></div>
        <div id="layer-4" data-layer="4" class="card hidden"></div>
        
        <div id="layer-5" data-layer="5" class="card hidden normal-font-mode"></div>
        
        <div id="layer-6" data-layer="6" class="card hidden"></div>
        
        <div id="layer-no-symptom-review" data-layer="no-symptom-review" class="card hidden"></div>
        
        <div id="history-card" class="card hidden normal-font-mode"></div>
        
        <div id="disclaimerModal" class="modal"></div>
        <div id="how-to-act-modal" class="modal normal-font-mode"></div>
        <div id="confirmLocationModal" class="modal normal-font-mode">
            <div class="modal-content" style="text-align: center;">
                <span class="iconify" data-icon="mdi:map-marker-alert" style="font-size: 60px; color: var(--action-orange);"></span>
                <h2 style="margin-top: 15px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</h2>
                <p style="color: #555;">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î" ‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏ó‡∏£</p>
                <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 25px;">
                    <button id="modal-send-location-btn" class="btn-action" style="background-color: var(--action-blue); margin-top:0; font-size:1.1em; padding:15px;">‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏ó‡∏£</button>
                    <button id="modal-call-anyway-btn" class="btn-action" style="background-color: var(--action-gray); margin-top:0; font-size:1.1em; padding:15px;">‡πÇ‡∏ó‡∏£‡πÄ‡∏•‡∏¢‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
                </div>
            </div>
        </div>
    </div>

<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyptTEQF-bSEVcghqYZlQdPdP9WWbxn7JDzbidpI-m6wCe23ASFET9GF6M2l5RHBaz4/exec";
    const LIFF_ID = "2005789397-WRm1lYd9";
    const REGISTRATION_LIFF_URL = "https://liff.line.me/2005789397-nebQ8oJy";
    
    let sessionData = {};
    let countdownInterval;
    let currentActionElement = null;
    let currentActionKey = '';
    let notificationSent = false;
    let loadingInterval; 

    const hospitalCoords = { lat: 10.2300226, lon: 99.1087481 };
    const icons = {
        user: 'mdi:account-circle', symptom: 'mdi:account-heart-outline',
        clock: 'mdi:clock-time-three-outline', hourglass: 'mdi:timer-sand',
        map: 'mdi:map-marker-distance', car: 'mdi:car-clock',
        ambulance: 'mdi:ambulance', runner: 'mdi:run-fast',
        contact: 'mdi:phone', pin: 'mdi:map-marker', check: 'mdi:check-circle',
        phone: 'mdi:phone-hangup', route: 'mdi:directions'
    };
    const symptomImages = {
        'Balance': 'https://img2.pic.in.th/pic/9262fb61dad1ac59a.png',
        'Eye': 'https://img2.pic.in.th/pic/116c85596438a20abb.png',
        'Face': 'https://img5.pic.in.th/file/secure-sv1/816bef53cab08af4c.png',
        'Arm': 'https://img5.pic.in.th/file/secure-sv1/1085d75ea978c5fa79.png',
        'Speech': 'https://img5.pic.in.th/file/secure-sv1/120c61160f5b97e541.png'
    };
    const symptomTranslations = {
        'Balance': '‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß', 'Eye': '‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô', 'Face': '‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤', 
        'Arm': '‡πÅ‡∏Ç‡∏ô‡∏Ç‡∏≤', 'Speech': '‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î'
    };
    const symptomDetails = {
        'Balance': { likely: ['‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ã‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á', '‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß', '‡∏¢‡∏∑‡∏ô/‡∏ô‡∏±‡πà‡∏á‡∏ô‡∏¥‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'], unlikely: ['‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡πà‡∏≤', '‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏´‡∏π‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô'] },
        'Eye': { likely: ['‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô', '‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ã‡πâ‡∏≠‡∏ô', '‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ã‡∏µ‡∏Å'], unlikely: ['‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡πÄ‡∏î‡∏¥‡∏°', '‡∏ï‡∏≤‡πÅ‡∏´‡πâ‡∏á/‡∏£‡∏∞‡∏Ñ‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏∑‡∏≠‡∏á'] },
        'Face': { likely: ['‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ã‡∏µ‡∏Å', '‡∏°‡∏∏‡∏°‡∏õ‡∏≤‡∏Å‡∏ï‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á', '‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏≤‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß'], unlikely: ['‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß (Bell\'s Palsy)', '‡∏ö‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ü‡∏±‡∏ô'] },
        'Arm': { likely: ['‡πÅ‡∏Ç‡∏ô/‡∏Ç‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á‡∏ã‡∏µ‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', '‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô', '‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠'], unlikely: ['‡∏õ‡∏ß‡∏î‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', '‡∏ä‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏ó‡∏±‡∏ö'] },
        'Speech': { likely: ['‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î/‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥', '‡∏•‡∏¥‡πâ‡∏ô‡πÅ‡∏Ç‡πá‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏°‡∏≤', '‡∏ô‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å'], unlikely: ['‡∏û‡∏π‡∏î‡∏ï‡∏¥‡∏î‡∏Ç‡∏±‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢', '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏´‡∏ö/‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ß‡∏±‡∏î'] }
    };

    // --- Loading Animation Logic ---
    function startLoadingAnimation() {
        const msgs = ["‡πÄ‡∏ã‡∏°‡∏∂‡∏ô‡∏´‡∏±‡∏ß", "‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏°‡∏≤‡∏Å", "‡∏°‡∏∏‡∏°‡∏õ‡∏≤‡∏Å‡∏ï‡∏Å", "‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô‡∏¢‡∏≤‡∏Å", "‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏û‡∏π‡∏î"];
        let i = 0;
        const sub = document.getElementById('loading-subtext');
        
        if(sub) sub.textContent = msgs[0];

        loadingInterval = setInterval(() => {
            if(sub) sub.style.opacity = 0;
            setTimeout(() => {
                i = (i + 1) % msgs.length;
                if(sub) sub.textContent = msgs[i];
                if(sub) sub.style.opacity = 1;
            }, 500);
        }, 2500);
    }

    function stopLoadingAnimation() {
        clearInterval(loadingInterval);
        const loader = document.getElementById('loading');
        if(loader) loader.style.display = 'none';
    }

    // --- Image Viewer Logic ---
    function viewImage(src) {
        const modal = document.getElementById('image-viewer-modal');
        const img = document.getElementById('full-image');
        img.src = src;
        modal.style.display = "flex";
    }

    function closeImageViewer() {
        document.getElementById('image-viewer-modal').style.display = "none";
    }

    // --- Scroll Logic for Review Page ---
    function scrollToNextReviewItem(currentKey) {
        const keys = ['Balance', 'Eye', 'Face', 'Arm', 'Speech'];
        const currentIndex = keys.indexOf(currentKey);
        
        if (currentIndex < keys.length - 1) {
            // Scroll to next card
            const nextKey = keys[currentIndex + 1];
            const nextElement = document.getElementById(`review-card-${nextKey}`);
            if (nextElement) {
                nextElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else {
            // Last item, scroll to the final button
            const finalBtn = document.getElementById('final-review-btn');
            if (finalBtn) {
                finalBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }

    window.onload = async () => {
        startLoadingAnimation(); 
        buildInitialHTML();
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            sessionData.userID = profile.userId;
            sessionData.userName = profile.displayName;
            fetchUserData(profile.userId);
            setupTimeOptions();
        } catch (err) { 
            console.error(err); 
            stopLoadingAnimation(); 
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"); 
        }
        document.getElementById('info-icon').onclick = () => { document.querySelector('#disclaimerModal').style.display = 'flex'; };
        
        document.getElementById('modal-call-anyway-btn').onclick = () => {
            document.getElementById('confirmLocationModal').style.display = 'none';
            proceedWithSave();
        };
        document.getElementById('modal-send-location-btn').onclick = () => {
            document.getElementById('confirmLocationModal').style.display = 'none';
            getLocation(true); 
        };
    };

    function buildInitialHTML() {
        document.getElementById('layer-1').innerHTML = `
            <div class="card-body">
                <h1 class="section-title home-title" style="font-size: 1.4em;">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å <span id="info-icon" class="info-icon">i</span></h1>
                <p class="section-subtitle home-subtitle" style="font-size: 1em;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                <div class="symptom-grid">
                    <div class="symptom-card" onclick="showLayer2('Balance')"><img src="https://i.ibb.co/GMvMmZV/ezgif-2-563a5d8327-apng.png" alt="Balance"><p>‡πÄ‡∏ã/‡∏°‡∏∂‡∏ô‡∏´‡∏±‡∏ß</p></div>
                    <div class="symptom-card" onclick="showLayer2('Eye')"><img src="https://i.ibb.co/9r0cMc2/ezgif-2-5374788704.png" alt="Eye"><p>‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏°‡∏≤‡∏Å</p></div>
                    <div class="symptom-card" onclick="showLayer2('Face')"><img src="https://i.ibb.co/nRJc4MX/ezgif-2-8b010716d3.png" alt="Face"><p>‡∏°‡∏∏‡∏°‡∏õ‡∏≤‡∏Å‡∏ï‡∏Å</p></div>
                    <div class="symptom-card" onclick="showLayer2('Arm')"><img src="https://i.ibb.co/G7Vbn9V/ezgif-2-b6c57b3b00.png" alt="Arm"><p>‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô‡∏¢‡∏≤‡∏Å</p></div>
                    <div class="symptom-card" onclick="showLayer2('Speech')"><img src="https://i.ibb.co/gVYy8Nf/ezgif-2-01c5ed2695.png" alt="Speech"><p>‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏û‡∏π‡∏î</p></div>
                    <div class="symptom-card no-symptom" onclick="handleNoSymptom()"><img src="https://i.ibb.co/yVP6CGv/image.png" alt="No Symptom"><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</p></div>
                </div>
            </div>`;
        
        document.getElementById('layer-2').innerHTML = `<div class="card-body"><h2 id="layer-2-title" class="section-title" style="text-align:center;"></h2><div id="layer-2-new-content"></div><hr id="layer-2-separator" style="margin: 25px 0;"><p id="layer-2-subtitle" class="section-subtitle">‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p><div id="layer-2-buttons" class="options-container"></div></div><div class="btn-back-container"><div class="btn-back" onclick="goBack('layer-1')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div></div>`;
        document.getElementById('layer-3').innerHTML = `<div class="card-body"><h2 class="section-title" style="text-align:center;">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</h2><div class="options-container"><button class="btn-likely" onclick="handleSeveritySelection('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô')">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô</button><button style="background-color: #E67E22; color: white;" onclick="handleChronicSymptom('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á/‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏õ‡πá‡∏ô')">‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô/‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ‡πÄ‡∏õ‡πá‡∏ô</button></div></div><div class="btn-back-container"><div class="btn-back" onclick="goBack('layer-2')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div></div>`;
        document.getElementById('layer-4').innerHTML = `<div class="card-body"><h2 class="section-title" style="text-align:center;">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà?</h2><p class="section-subtitle">‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p><div class="options-container time-options" id="time-options-container"></div></div><div class="btn-back-container"><div class="btn-back" onclick="goBack('layer-3')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div></div>`;
        document.getElementById('layer-5').innerHTML = `<div class="card-body"><div class="emergency-text-container"><p>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢</p><p class="large-red-blink">‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</p><p class="small-black-blink">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å‡∏´‡∏≤ ‡∏£‡∏û.‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</p><div id="countdown-timer" class="countdown-timer"></div></div><div id="action-grid-container" class="action-buttons-grid"></div><table id="summary-table" class="summary-table"></table><div id="contact-buttons" class="contact-buttons"></div><div id="route-button-container"></div><button class="btn-action" style="background-color: var(--dark-red);" onclick="triggerSave(this, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î', true)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button></div><div class="btn-back-container"><div class="btn-back" onclick="goBack('layer-4')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div></div>`;
        document.getElementById('layer-6').innerHTML = `<div class="card-body"><div id="final-emoji" style="text-align:center; font-size: 5em; margin-bottom: 15px;"></div><h2 id="final-title" class="section-title" style="text-align:center;"></h2><p id="final-text" style="text-align:center; font-size:1.3em;"></p><button class="btn-action" style="background-color: var(--primary-color); padding: 25px;" onclick="handleFinalSave(this, false)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î</button></div>`;
        
        // [Modified] Review Page Structure
        document.getElementById('layer-no-symptom-review').innerHTML = `
            <div class="card-body">
                <h2 class="section-title" style="text-align:center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1.4em;">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡πÉ‡∏à</h2>
                <p class="section-subtitle">‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£"</p>
                <div id="review-container"></div>
                <button id="final-review-btn" class="btn-unlikely" style="width:100%; padding: 25px; font-size: 1.4em; margin-top: 25px;" onclick="handleFinalNoSymptom()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</button>
            </div>
            <div class="btn-back-container"><div class="btn-back" onclick="goBack('layer-1')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div></div>`;
            
        document.getElementById('disclaimerModal').innerHTML = `<div class="modal-content" onclick="event.stopPropagation()"><h2 style="text-align:center;">‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h2><p>‚Ä¢ ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</strong> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</p><p>‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÇ‡∏î‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</p><p>‚Ä¢ ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ <strong>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô</strong> ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Å‡∏î‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</p><p style="font-size:1em; color:#555;">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p><button onclick="document.querySelector('#disclaimerModal').style.display='none'" style="background-color:var(--primary-color); color:white; font-size:1.4em; padding:15px; border-radius: 10px; width:100%; margin-top:15px;">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button></div>`;
        document.getElementById('how-to-act-modal').innerHTML = `<div class="modal-content"><h2 style="text-align:center;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Ç‡∏ì‡∏∞‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h2><div style="text-align:left;"><strong>1. ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å</strong><ul><li>‡πÇ‡∏ó‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤ ‚Äú‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏™‡πÇ‡∏ï‡∏£‡∏Å‚Äù</li><li>‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢, ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å, ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</li><li>‡∏´‡∏≤‡∏Å‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤ <strong style="color: var(--symptom-red);">"‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á Line ‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß"</strong></li></ul><strong>2. ‡∏Ç‡∏ì‡∏∞‡∏£‡∏≠‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</strong><ul><li>‡πÉ‡∏´‡πâ‡∏ô‡∏≠‡∏ô‡∏£‡∏≤‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏≠‡∏ô‡∏®‡∏µ‡∏£‡∏©‡∏∞‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (15-30¬∞)</li><li>‡∏Ñ‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏™‡∏∞‡∏î‡∏ß‡∏Å, **‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î**</li><li>‡πÄ‡∏ù‡πâ‡∏≤‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à</li></ul><strong>3. ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</strong><ul><li>‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</li><li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ä‡∏∑‡πà‡∏≠, ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß, ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</li><li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</li></ul><strong>4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</strong><ul><li>‡∏£‡∏µ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ß‡πà‡∏≤ "‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏™‡πÇ‡∏ï‡∏£‡∏Å" ‡πÅ‡∏•‡∏∞‡∏ö‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</li></ul></div><button onclick="document.querySelector('#how-to-act-modal').style.display='none'; if(liff.isInClient()){liff.closeWindow();}" class="btn-action" style="background-color:var(--primary-color);">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button></div>`;
    }

    function fetchUserData(userId) {
        if (!userId) return;
        const url = `${GAS_URL}?action=getUserData&userId=${userId}&callback=processUserData`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        document.head.appendChild(scriptTag);
    }
    
    window.processUserData = function(response) {
        stopLoadingAnimation();
        const historyCard = document.getElementById('history-card');
        if (response.status === 'found' && response.data) {
            const data = response.data;
            sessionData.registeredName = data.name;
            sessionData.district = data.district;
            sessionData.village = data.village;
            sessionData.risk_group = data.risk_group; 
            const riskTimestamp = data.timestamp ? formatFullDateTime(new Date(data.timestamp)) : 'N/A';
            historyCard.innerHTML = `<h2 style="text-align: center; font-size: 1.2em;">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${data.name || sessionData.userName}</h2><p style="font-size: 1em; text-align: center;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å(${data.risk_group || 'N/A'}): <strong>${data.thai_cv_risk_score}%</strong></p><p style="font-size: 0.9em; text-align: center; color: #666;">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${riskTimestamp}</p>`;
            if(sessionData.district && sessionData.village) {
                fetchVolunteerData(`‡∏ï.${sessionData.district} ‡∏°.${sessionData.village}`);
            }
        } else {
            historyCard.innerHTML = `<p style="text-align:center; font-size:1.1em;">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á <a href="${REGISTRATION_LIFF_URL}">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a></p>`;
        }
        historyCard.classList.remove('hidden');
    }

    function fetchVolunteerData(areaKey) {
        if (!areaKey) return;
        const url = `${GAS_URL}?action=getVolunteerData&areaKey=${encodeURIComponent(areaKey)}&callback=processVolunteerData`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        document.head.appendChild(scriptTag);
    }

    window.processVolunteerData = function(response) {
        if (response.status === 'found') {
            sessionData.volunteerContacts = response.data;
        }
    }

    function handleFinalSave(button, isEmergency) {
        if(button && button.disabled) return;
        if(button) button.disabled = true;
        sessionData.isEmergency = isEmergency;
        const callbackName = 'saveCallback' + Date.now();
        window[callbackName] = function(response) {
            if (response && response.status === 'success') {
                if (isEmergency && response.notificationSent) {
                    if (currentActionKey === '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î') {
                        if(liff.isInClient()) liff.closeWindow();
                    } else {
                        document.getElementById('how-to-act-modal').style.display = 'flex';
                    }
                } else if (!isEmergency) {
                    if(liff.isInClient()) liff.closeWindow();
                }
            } else {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + (response ? response.message : 'Unknown error'));
            }
            if(button) button.disabled = false;
        };
        const dataStr = encodeURIComponent(JSON.stringify(sessionData));
        const url = `${GAS_URL}?action=saveData&callback=${callbackName}&data=${dataStr}`;
        const scriptTag = document.createElement('script');
        scriptTag.src = url;
        scriptTag.onerror = function() {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
            if(button) button.disabled = false;
        };
        document.head.appendChild(scriptTag);
    }

    function triggerSave(element, key, isFinalSave = false) {
        currentActionElement = element;
        currentActionKey = key;
        sessionData.isFinalSave = isFinalSave;
        if (key.startsWith('tel_') && !sessionData.location) {
            document.getElementById('confirmLocationModal').style.display = 'flex';
        } else {
            proceedWithSave();
        }
    }

    function proceedWithSave() {
        if (currentActionKey.startsWith('tel_')) {
            sessionData[currentActionKey] = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
        }
        sessionData.contactedVia = currentActionKey;
        if (!notificationSent || sessionData.isFinalSave) {
            sessionData.sendNotification = true;
            notificationSent = true;
        } else {
            sessionData.sendNotification = false;
        }
        handleFinalSave(currentActionElement, true);
    }

    function getLocation(andThenSave = false) {
        const locButton = document.getElementById('location-action');
        const locText = document.getElementById('location-text');

        if (!locButton || !locText) {
            console.error("Location button or text element not found.");
            return;
        }

        locButton.onclick = null; 
        locText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
        
        navigator.geolocation.getCurrentPosition(
            position => {
                locButton.classList.add('success');
                locButton.innerHTML = `<span class="iconify" data-icon="${icons.check}"></span>`;
                locText.textContent = '‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß';
                const { latitude, longitude } = position.coords;
                saveData('location', `${latitude},${longitude}`);
                const distance = getDistanceFromLatLonInKm(latitude, longitude, hospitalCoords.lat, hospitalCoords.lon);
                updateSummaryAndActions(distance);
                if (andThenSave) {
                    proceedWithSave();
                }
            },
            error => {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
                locButton.onclick = () => getLocation(andThenSave); 
                locText.textContent = '‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà';
                updateSummaryAndActions(null);
            }
        );
    }
    
    function saveData(key, value) { sessionData[key] = value; }
    function showLayer(layerId) { document.querySelectorAll('[data-layer]').forEach(el => el.classList.add('hidden')); document.getElementById(layerId).classList.remove('hidden'); }
    function goBack(targetLayer) { showLayer(targetLayer); }

    function handleNoSymptom() {
        buildNoSymptomReviewPage();
        showLayer('layer-no-symptom-review');
    }

    function showFinalMessage(title, text) {
        saveData('symptomDetail', text);
        const finalTitle = document.getElementById('final-title');
        const finalText = document.getElementById('final-text');
        const finalEmoji = document.getElementById('final-emoji');
        if (finalTitle) finalTitle.textContent = title;
        if (finalText) finalText.textContent = text;
        if (finalEmoji) finalEmoji.textContent = ['üëç', 'üéâ', 'üí™', '‚úÖ', 'üòä'][Math.floor(Math.random() * 5)];
        showLayer('layer-6');
    }
    
    function handleFinalNoSymptom() {
        saveData('symptomCategory', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£');
        saveData('randomGreeting', "‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÄ‡∏•‡∏¢");
        showFinalMessage("‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!", "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÄ‡∏•‡∏¢");
    }

    function showLayer2(symptomKey) {
        saveData('symptomCategory', symptomKey);
        document.getElementById('layer-2-title').textContent = `‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô${symptomTranslations[symptomKey]}`;
        const newContentContainer = document.getElementById('layer-2-new-content');
        const buttonsContainer = document.getElementById('layer-2-buttons');
        newContentContainer.innerHTML = '';
        buttonsContainer.innerHTML = '';
        
        let newHtml = `<div class="symptom-image-container">
            <img src="${symptomImages[symptomKey]}" alt="${symptomTranslations[symptomKey]}" onclick="viewImage('${symptomImages[symptomKey]}')">
            <div class="zoom-hint">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
        </div>`;
        
        newHtml += `<div class="general-symptom-buttons">
                        <button class="btn-likely" onclick="handleSymptomResult(true, '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢')">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢</button>
                        <button class="btn-unlikely" onclick="handleSymptomResult(false, '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢')">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢</button>
                    </div>`;
        newContentContainer.innerHTML = newHtml;
        const details = symptomDetails[symptomKey];
        details.likely.forEach(text => {
            const btn = document.createElement('button');
            btn.className = 'btn-likely';
            btn.textContent = text;
            btn.onclick = () => handleSymptomResult(true, text);
            buttonsContainer.appendChild(btn);
        });
        details.unlikely.forEach(text => {
            const btn = document.createElement('button');
            btn.className = 'btn-unlikely';
            btn.textContent = text;
            btn.onclick = () => handleSymptomResult(false, text);
            buttonsContainer.appendChild(btn);
        });
        showLayer('layer-2');
    }

    function buildNoSymptomReviewPage() {
        const container = document.getElementById('review-container');
        if (!container) return;
        container.innerHTML = '';
        let reviewHtml = '';
        for (const key in symptomImages) {
            // [Modified] New Layout for Review Cards (Full Image + Buttons Below)
            reviewHtml += `<div class="review-card" id="review-card-${key}">
                    <div class="review-image" onclick="viewImage('${symptomImages[key]}')">
                        <img src="${symptomImages[key]}" alt="${symptomTranslations[key]}">
                    </div>
                    <div class="review-action">
                        <button class="btn-likely" onclick="handleSymptomResult(true, '‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ${symptomTranslations[key]} ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô', '${key}')">‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</button>
                        <button class="btn-unlikely" onclick="scrollToNextReviewItem('${key}')">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</button>
                    </div>
                </div>`;
        }
        container.innerHTML = reviewHtml;
    }

    function handleSymptomResult(isLikely, symptomDetail, symptomCategory = null) {
        if (symptomCategory) { saveData('symptomCategory', symptomCategory); }
        saveData('symptomDetail', symptomDetail);
        if (isLikely) { showLayer('layer-3'); } 
        else {
            saveData('frequency', '‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô');
            showFinalMessage("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô", "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏Å‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå");
        }
    }
    
    function handleSeveritySelection(frequencyText) { saveData('frequency', frequencyText); showLayer('layer-4'); }
    function handleChronicSymptom(frequencyText) {
        saveData('frequency', frequencyText);
        showFinalMessage("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥", "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á");
    }
    
    function handleTimeSelection(minutesAgo, isChronic = false) {
        if (isChronic) {
            saveData('onsetTime', '‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á/‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô');
            showFinalMessage("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥", "‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏†‡∏≤‡∏ß‡∏∞‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô");
            return;
        }
        const onsetTime = new Date(Date.now() - minutesAgo * 60000);
        sessionData.onsetTimeObject = onsetTime;
        saveData('onsetTime', formatFullDateTime(onsetTime));
        showLayer('layer-5');
        buildSummaryPage();
    }

    function buildSummaryPage() {
        if (!sessionData.eventId) {
            sessionData.eventId = sessionData.userID + '-' + Date.now();
        }
        const onset = sessionData.onsetTimeObject;
        if (!onset) return;
        const arrivalDeadline = new Date(onset.getTime() + 3.5 * 60 * 60 * 1000);
        const rtpaDeadline = new Date(onset.getTime() + 4.5 * 60 * 60 * 1000);
        sessionData.arrivalDeadline = formatTime(arrivalDeadline);
        sessionData.rtpaDeadline = formatTime(rtpaDeadline);
        startCountdown(rtpaDeadline.getTime());
        let tableHtml = '<tbody>';
        tableHtml += createTableRow(icons.user, '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢', sessionData.registeredName || sessionData.userName);
        tableHtml += createTableRow(icons.symptom, '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£', sessionData.symptomDetail);
        tableHtml += createTableRow(icons.clock, '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠', formatFullDateTime(onset));
        tableHtml += createTableRow(icons.hourglass, '‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á ‡∏£‡∏û. ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (3.5‡∏ä‡∏°.)', sessionData.arrivalDeadline + ' ‡∏ô.');
        tableHtml += createTableRow(icons.hourglass, '‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (4.5‡∏ä‡∏°.)', sessionData.rtpaDeadline + ' ‡∏ô.');
        tableHtml += '</tbody>';
        document.getElementById('summary-table').innerHTML = tableHtml;
        buildActionContainer();
        updateSummaryAndActions(null);
    }

    function startCountdown(deadlineMillis) {
        if (countdownInterval) clearInterval(countdownInterval);
        const timerElement = document.getElementById('countdown-timer');
        if (!timerElement) return;
        const updateTimer = () => {
            const distance = deadlineMillis - new Date().getTime();
            if (distance < 0) {
                timerElement.textContent = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß";
                timerElement.style.color = "var(--dark-red)";
                clearInterval(countdownInterval);
                return;
            }
            const hours = Math.floor(distance / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            timerElement.textContent = `‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ${String(hours)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${String(minutes).padStart(2, '0')} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        };
        updateTimer();
        countdownInterval = setInterval(updateTimer, 1000);
    }

    function updateSummaryAndActions(distance) {
        const table = document.getElementById('summary-table').getElementsByTagName('tbody')[0];
        document.querySelectorAll('.distance-row').forEach(row => row.remove());
        const contactContainer = document.getElementById('contact-buttons');
        contactContainer.innerHTML = '';
        const routeContainer = document.getElementById('route-button-container');
        routeContainer.innerHTML = '';
        if (distance !== null) {
            let extraHtml = '';
            const sawiButtonWrapper = document.querySelector('.tel-sawi-button').closest('.action-button-wrapper');
            if (distance > 450) {
                extraHtml += createTableRow('mdi:alert-circle-outline', '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏õ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ', '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ ‡∏£‡∏û.‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î', true, 'distance-row');
                if (sawiButtonWrapper) sawiButtonWrapper.style.display = 'none';
            } else {
                if (sawiButtonWrapper) sawiButtonWrapper.style.display = 'flex';
                const travelTimeMinutes = (distance / 40) * 60;
                const ambulanceTravelTime = travelTimeMinutes * 1.5 + 15;
                const selfTravelArrival = new Date(Date.now() + travelTimeMinutes * 60000);
                const ambulanceArrival = new Date(Date.now() + ambulanceTravelTime * 60000);
                const rtpaDeadline = sessionData.onsetTimeObject ? new Date(sessionData.onsetTimeObject.getTime() + 4.5 * 60 * 60 * 1000) : new Date();
                sessionData.distance = `${distance.toFixed(1)} ‡∏Å‡∏°.`;
                sessionData.duration = formatDuration(travelTimeMinutes);
                const selfTravelText = `${formatTime(selfTravelArrival)} ‡∏ô. (${selfTravelArrival <= rtpaDeadline ? '‡∏ó‡∏±‡∏ô' : '‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô'})`;
                const ambulanceTravelText = `${formatTime(ambulanceArrival)} ‡∏ô. (${ambulanceArrival <= rtpaDeadline ? '‡∏ó‡∏±‡∏ô' : '‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô'})`;
                sessionData.selfTravelEstimate = selfTravelText;
                sessionData.ambulanceEstimate = ambulanceTravelText;
                extraHtml += createTableRow(icons.map, '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏õ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ', sessionData.distance, false, 'distance-row');
                extraHtml += createTableRow(icons.car, '‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', sessionData.duration, false, 'distance-row');
                extraHtml += createTableRow(icons.runner, '‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏°‡∏≤‡πÄ‡∏≠‡∏á)', sessionData.selfTravelEstimate, selfTravelText.includes('‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô'), 'distance-row');
                extraHtml += createTableRow(icons.ambulance, '‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏£‡∏ñ ‡∏£‡∏û. ‡πÑ‡∏õ‡∏£‡∏±‡∏ö)', sessionData.ambulanceEstimate, ambulanceTravelText.includes('‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô'), 'distance-row');
                const gmapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${hospitalCoords.lat},${hospitalCoords.lon}`;
                routeContainer.innerHTML = `<a href="${gmapsUrl}" target="_blank" class="contact-button route-button"><span class="iconify" data-icon="${icons.route}"></span><span class="label">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</span></a>`;
            }
            table.insertAdjacentHTML('beforeend', extraHtml);
        }
        if (sessionData.volunteerContacts) {
            const contacts = sessionData.volunteerContacts;
            let areaInfo = (sessionData.district && sessionData.village) ? `(‡∏ï.${sessionData.district} ‡∏°.${sessionData.village})` : '';
            contactContainer.innerHTML = `<h3 style="font-size:1.1em; text-align:center; margin-top:20px; margin-bottom:10px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</h3>`;
            if (contacts.volunteer1_tel) contactContainer.innerHTML += createContactButton(contacts.volunteer1_tel, "‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ‡∏≠‡∏™‡∏°. 1", "tel_asm1");
            if (contacts.volunteer2_tel) contactContainer.innerHTML += createContactButton(contacts.volunteer2_tel, "‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ‡∏≠‡∏™‡∏°. 2", "tel_asm2");
            if (contacts.headman_tel) contactContainer.innerHTML += createContactButton(contacts.headman_tel, `‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ${areaInfo}`, "tel_header");
            if (contacts.pcu_tel) contactContainer.innerHTML += createContactButton(contacts.pcu_tel, `‡πÇ‡∏ó‡∏£‡∏´‡∏≤ ${contacts.pcu_name || '‡∏£‡∏û.‡∏™‡∏ï.'}`, "tel_pcu");
        }
    }

    function createTableRow(iconName, label, value, isUrgent = false, rowClass = '') {
        const valueClass = isUrgent ? 'value-col value-urgent' : 'value-col';
        return `<tr class="${rowClass}">
                    <td class="icon-col"><span class="iconify" data-icon="${iconName}"></span></td>
                    <td class="label-col">${label}</td>
                    <td class="${valueClass}">${value || 'N/A'}</td>
                </tr>`;
    }
    
    function setupTimeOptions() {
        const container = document.getElementById('time-options-container');
        if (!container) return;
        container.innerHTML = '';
        const now = new Date();
        const timeOptions = [
            { text: `‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏Å‡∏¥‡∏î (${formatTime(now)})`, minutes: 0 }, { text: '10 ‡∏ô‡∏≤‡∏ó‡∏µ', minutes: 10 },
            { text: '30 ‡∏ô‡∏≤‡∏ó‡∏µ', minutes: 30 }, { text: '1 ‡∏ä‡∏°.', minutes: 60 },
            { text: '2 ‡∏ä‡∏°.', minutes: 120 }, { text: '3 ‡∏ä‡∏°.', minutes: 180 },
            { text: '4 ‡∏ä‡∏°.', minutes: 240 }, { text: '6 ‡∏ä‡∏°.', minutes: 360 },
            { text: '12 ‡∏ä‡∏°.', minutes: 720 },
            { text: '1 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô', minutes: 1440, chronic: true },
            { text: '‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô', minutes: 0, chronic: true, final: true }
        ];
        const startColor = { r: 224, g: 224, b: 224 };
        const endColor = { r: 255, g: 193, b: 7 };
        timeOptions.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.textContent = opt.text;
            btn.onclick = () => handleTimeSelection(opt.minutes, opt.chronic);
            if (opt.final) { btn.style.backgroundColor = `rgb(${endColor.r}, ${endColor.g}, ${endColor.b})`; } 
            else if (opt.chronic) { btn.style.backgroundColor = '#E67E22'; btn.style.color = 'white'; } 
            else {
                const ratio = index / (timeOptions.length - 3);
                const r = Math.round(startColor.r + (endColor.r - startColor.r) * ratio);
                const g = Math.round(startColor.g + (endColor.g - startColor.g) * ratio);
                const b = Math.round(startColor.b + (endColor.b - startColor.b) * ratio);
                btn.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
            }
            container.appendChild(btn);
        });
    }

    function createContactButton(tel, label, key) { return `<a href="tel:${tel}" class="contact-button" onclick="triggerSave(this, '${key}')"><span class="iconify" data-icon="${icons.contact}"></span><span class="label">${label}</span></a>`; }
    
    function buildActionContainer() {
        const container = document.getElementById('action-grid-container');
        if (!container) return;
        container.innerHTML = `
            <div class="action-button-wrapper">
                <div id="location-action" class="action-button location-button" onclick="getLocation()">
                    <span class="iconify" data-icon="mdi:map-marker"></span>
                </div>
                <p id="location-text" class="action-button-text">‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</p>
            </div>
            <a href="tel:0894745523" class="action-button-wrapper" onclick="triggerSave(this, 'tel_sawee')">
                <div class="action-button tel-sawi-button">
                    <span class="iconify" data-icon="mdi:phone"></span>
                </div>
                <p class="action-button-text">‡πÇ‡∏ó‡∏£ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</p>
            </a>
            <a href="tel:1669" class="action-button-wrapper" onclick="triggerSave(this, 'tel_1669')">
                <div class="action-button tel-1669-button">
                    <span class="iconify" data-icon="mdi:phone"></span>
                </div>
                <p class="action-button-text">‡πÇ‡∏ó‡∏£ 1669</p>
            </a>`;
    }
    
    function formatTime(date) { return date.toTimeString().slice(0, 5); }
    function formatFullDateTime(date) {
        if (!date || isNaN(new Date(date).getTime())) return 'N/A';
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear() + 543;
        const hh = String(d.getHours()).padStart(2, '0');
        const mm = String(d.getMinutes()).padStart(2, '0');
        return `${day}/${month}/${year} ${hh}:${mm} ‡∏ô.`;
    }
    function formatDuration(minutes) {
        if (isNaN(minutes) || minutes < 0) return 'N/A';
        const h = Math.floor(minutes / 60);
        const m = Math.round(minutes % 60);
        if (h > 0) return `${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        return `${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    }
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
</script>
</body>
</html>